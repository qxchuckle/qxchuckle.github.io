<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><script>if ('serviceWorker' in navigator) {
  //- if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 1) {
  //-   (async()=>{window.stop()})()
  //-   window.localStorage.setItem('ChenBlogHelper_Set', 1)
  //- }
  //- navigator.serviceWorker.register('/giggles.js')
  //-   .then(async () => {
  //-     if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 2) {
  //-       window.localStorage.setItem('ChenBlogHelper_Set', 2)
  //-       setTimeout(() => {
  //-         window.location.reload()
  //-       }, 150)
  //-     }
  //-   })
  // 卸载所有 Service Worker
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister().then(function(success) {
        if (success) {
          console.log('Service Worker 已成功卸载');
        }
      });
    }
  });
  // 清除相关的 localStorage
  window.localStorage.removeItem('ChenBlogHelper_Set');
}
//- function setQXCookies(obj, limitTime, customDomain) {
//-     let data = new Date(new Date().getTime() + limitTime * 24 * 60 * 60 * 1000).toGMTString();
//-     for (let i in obj) {
//-       document.cookie = i + '=' + obj[i] + ';expires=' + data + ';domain=' + customDomain;
//-     }
//- }
//- function getQXCookie(name) {
//-     var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
//-     if (arr = document.cookie.match(reg))
//-         return decodeURIComponent(arr[2]);
//-     else
//-         return null;
//- }
//- if(getQXCookie('qcqx')!=="chuckle"){
//-   setQXCookies({ qcqx: 'chuckle' }, 365, 'qcqx.cn');
//- }else{
//-   console.log("qcqx");
//- }</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>qx-tracker | 轻笑Chuckle</title><meta name="keywords" content="TS"><meta name="author" content="『轻笑Chuckle』"><meta name="copyright" content="『轻笑Chuckle』"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="baidu-site-verification" content="codeva-BLXfA46XrF"><meta name="description" content="一个前端监控和埋点SDK">
<meta property="og:type" content="article">
<meta property="og:title" content="qx-tracker">
<meta property="og:url" content="https://www.qcqx.cn/article/31416cf6.html">
<meta property="og:site_name" content="轻笑Chuckle">
<meta property="og:description" content="一个前端监控和埋点SDK">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/1.webp">
<meta property="article:published_time" content="2024-01-18T13:54:59.000Z">
<meta property="article:modified_time" content="2024-01-18T13:54:59.000Z">
<meta property="article:author" content="『轻笑Chuckle』">
<meta property="article:tag" content="TS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/1.webp"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp"><link rel="canonical" href="https://www.qcqx.cn/article/31416cf6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/index.css?285"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/fontawesome.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.json","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":160},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'qx-tracker',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-18 21:54:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/tag_plugins.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="轻笑Chuckle" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp"/></div></div><div id="web_bg"></div><div id="svg_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="is-center" id="sidebar-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="menu-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><div id="chuckle_home"><div class="back-home-button"><i class="back-home-button-icon fas fa-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">传送门</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="前往博客主页" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" loading="lazy"/><span class="back-menu-item-text">博客主页</span></a><a class="back-menu-item" href="https://waline.qcqx.cn/ui" rel="external nofollow" title="前往评论后端" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/c4.webp" loading="lazy"/><span class="back-menu-item-text">评论管理</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客线路</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.qcqx.cn/" title="前往博客主站" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/h4.webp" loading="lazy"/><span class="back-menu-item-text">主域名线路</span></a><a class="back-menu-item" href="https://qxchuckle.github.io" title="前往博客Github线路" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/c6.webp" loading="lazy"/><span class="back-menu-item-text">Github线路</span></a></div></div></div></div></div><span id="blog_name"><a id="site-name" href="/">轻笑Chuckle</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div><div id="buttons"><div id="switch-bg"><a class="site-page social-icon search" href="javascript:;" rel="noopener external nofollow" onclick="toggleWinbox()" title="切换背景-换一种感觉。"><i class="fas fa-images fa-fw"></i></a></div><div id="switch-darkmode"><a class="site-page social-icon" onclick="kk.switchDarkMode()" title="切换模式"><i class="fas fa-adjust fa-fw"></i></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info" style="background-image: url('https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/1.webp')"><div id="post-meta-top"><span class="post-categories"><i class="iconfont icon-fenlei fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span><span class="post-tags"><a class="post-meta-tags" href="/tags/TS/">TS</a></span></div><h1 class="post-title">qx-tracker<a class="post-share" id="share-post" href="javascript:;" rel="noopener external nofollow" onclick="kk.postURL()"><i class="fa fa-share-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="iconfont icon-shalou fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-18T13:54:59.000Z" title="发表于 2024-01-18 21:54:59">2024-01-18</time></span><span class="post-meta-date"><i class="iconfont icon-gengxin fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-18T13:54:59.000Z" title="更新于 2024-01-18 21:54:59">2024-01-18</time></span></div><div class="meta-secondline"><span class="post-meta-wordcount"><i class="iconfont icon-tongji1 fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.7k</span></span><span class="post-meta-wordcount"><i class="iconfont icon-tubiaozhizuomoban- fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span><span class="leancloud_visitors" id="/article/31416cf6.html" data-flag-title="qx-tracker"><i class="iconfont icon-yanjing fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-commentcount"><i class="iconfont icon-pinglun fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/article/31416cf6.html#post-comment"><span class="waline-comment-count" id="/article/31416cf6.html"></span></a></span></div></div></div><article class="post-content" id="article-container"><div class="Copyright-Notice" id="Copyright-Notice"><div id="post-Copyright-bar"></div><div id="Copyright-box"><span>本站博文未在任何平台</span><span class="copyright-phone-none">以任何形式</span><span>售卖，详情:</span><a href="/agreement/">协议</a></div></div><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a target="_blank" rel="noopener" href="https://github.com/qxchuckle/qx-tracker">qx-tracker</a> 是一个前端监控和埋点SDK，支持自定义埋点和监控。</p>
<p>埋点就是数据采集-数据处理-数据分析和挖掘，如用户停留时间，用户哪个按钮点的多等。使用ts在编译过程中发现问题，减少生产代码的错误。</p>
<p>本文重新解构一下项目实现，复习相关的API。</p>
<h1 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h1><p>使用 <code>Rollup</code> 构建项目，<code>TypeScript</code> 编写代码。基本模板为自编写的 <a target="_blank" rel="noopener" href="https://github.com/qxchuckle/rollup-template">rollup-template</a></p>
<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><p><strong>两个npm命令：</strong></p>
<ol>
<li><code>npm run build</code> 构建<strong>生产环境</strong>代码，rollup 使用 <code>rollup.config.prod.mjs</code> 生产配置文件，并将环境变量 <code>ENV</code> 设置为 <code>production</code></li>
<li><code>npm run dev</code> 构建<strong>开发环境</strong>代码，rollup 使用 <code>rollup.config.dev.mjs</code> 开发配置文件，并将环境变量 <code>ENV</code> 设置为 <code>development</code>，<code>-w</code> 监听文件变化(热更新)，<code>-m</code> 生成sourcemap源映射文件。</li>
</ol>
<figure class="highlight json"><figcaption><span>npm命令</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rollup --config rollup.config.prod.mjs --environment ENV:production&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rollup --config rollup.config.dev.mjs -w -m --environment ENV:development&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>最终打包的文件在 <code>dist</code> 目录下。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.cjs.js&quot;</span><span class="punctuation">,</span> <span class="comment">// commonjs规范</span></span><br><span class="line"><span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.esm.js&quot;</span><span class="punctuation">,</span> <span class="comment">// esm模块规范</span></span><br><span class="line"><span class="attr">&quot;browser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.js&quot;</span><span class="punctuation">,</span> <span class="comment">// 浏览器环境，使用umd</span></span><br><span class="line"><span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dist/index.d.ts&quot;</span><span class="punctuation">,</span> <span class="comment">// ts类型声明文件</span></span><br></pre></td></tr></table></figure>
<h2 id="rollup配置"><a href="#rollup配置" class="headerlink" title="rollup配置"></a>rollup配置</h2><p>一共有三个配置文件：</p>
<ol>
<li><code>rollup.config.common.mjs</code> 公共配置文件，包含基础的公共配置，如 input、基础插件。</li>
<li><code>rollup.config.dev.mjs</code> 开发环境配置文件，继承公共配置文件，设置 output、增加插件。</li>
<li><code>rollup.config.prod.mjs</code> 生产环境配置文件，继承公共配置文件，设置 output、增加插件、打包类型声明文件。</li>
</ol>
<figure class="highlight js"><figcaption><span>rollup.config.common.mjs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认情况下，Rollup 只能处理相对路径的导入，安装node-resolve才能在模块中导入第三方npm模块</span></span><br><span class="line"><span class="keyword">import</span> nodeResolve <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-node-resolve&#x27;</span>;</span><br><span class="line"><span class="comment">// 将 CommonJS 模块转换为 ES6 模块，因为 Rollup 默认只能处理 ES6 模块</span></span><br><span class="line"><span class="keyword">import</span> commonjs <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-commonjs&#x27;</span>;</span><br><span class="line"><span class="comment">// 在每次打包之前清空输出目录</span></span><br><span class="line"><span class="keyword">import</span> clear <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-clear&#x27;</span>;</span><br><span class="line"><span class="comment">// 编译ts，使 Rollup 能处理ts文件</span></span><br><span class="line"><span class="keyword">import</span> typescript <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-typescript&#x27;</span>;</span><br><span class="line"><span class="comment">// 在源代码中替换一些特定的字符串。</span></span><br><span class="line"><span class="keyword">import</span> replace <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-replace&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// 入口文件</span></span><br><span class="line">  <span class="attr">input</span>: &#123;</span><br><span class="line">    <span class="comment">// 名为index的入口文件</span></span><br><span class="line">    <span class="attr">index</span>: <span class="string">&#x27;./src/core/index.ts&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 插件配置</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">replace</span>(&#123;</span><br><span class="line">      <span class="attr">preventAssignment</span>: <span class="literal">true</span>, <span class="comment">// 阻止在赋值操作中进行不正确的替换。</span></span><br><span class="line">      <span class="attr">__env__</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(process.<span class="property">env</span>.<span class="property">ENV</span>) <span class="comment">// 替换为环境变量</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">nodeResolve</span>(), <span class="comment">// 可以导入第三方npm模块</span></span><br><span class="line">     <span class="comment">// 将 CommonJS 模块转换为 ES6 模块，只处理js和ts文件</span></span><br><span class="line">    <span class="title function_">commonjs</span>(&#123; <span class="attr">extensions</span>: [<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>] &#125;),</span><br><span class="line">    <span class="title function_">clear</span>(&#123;</span><br><span class="line">      <span class="comment">// 需要清空的文件夹</span></span><br><span class="line">      <span class="attr">targets</span>: [<span class="string">&#x27;dist&#x27;</span>],</span><br><span class="line">      <span class="comment">// 在监视模式下进行汇总重新编译时是否清除目录</span></span><br><span class="line">      <span class="attr">watch</span>: <span class="literal">false</span>, <span class="comment">// default: false</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">typescript</span>(&#123;&#125;), <span class="comment">// 编译ts</span></span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>rollup.config.dev.mjs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在开发环境中启动一个 HTTP 服务器</span></span><br><span class="line"><span class="keyword">import</span> serve <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-serve&#x27;</span>;</span><br><span class="line"><span class="comment">// 在文件改变时自动刷新浏览器</span></span><br><span class="line"><span class="keyword">import</span> livereload <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-livereload&quot;</span>;</span><br><span class="line"><span class="comment">// 生成html文件，方便查看效果</span></span><br><span class="line"><span class="keyword">import</span> html <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-html&#x27;</span>;</span><br><span class="line"><span class="comment">// 公共配置</span></span><br><span class="line"><span class="keyword">import</span> common <span class="keyword">from</span> <span class="string">&#x27;./rollup.config.common.mjs&#x27;</span>;</span><br><span class="line"><span class="comment">// html模板</span></span><br><span class="line"><span class="keyword">import</span> &#123; htmlDevTemple &#125; <span class="keyword">from</span> <span class="string">&#x27;./html-temple.mjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Object.assign扩展公共配置</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, common, &#123;</span><br><span class="line">  <span class="comment">// 输出配置</span></span><br><span class="line">  <span class="attr">output</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">dir</span>: <span class="string">&#x27;dist&#x27;</span>, <span class="comment">// 输出目录</span></span><br><span class="line">      <span class="attr">entryFileNames</span>: <span class="string">&#x27;[name].js&#x27;</span>, <span class="comment">// 输出文件名</span></span><br><span class="line">      <span class="attr">format</span>: <span class="string">&#x27;umd&#x27;</span>, <span class="comment">// 输出格式</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Tracker&quot;</span> <span class="comment">// umd模块名称，作为全局变量名</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    ...common.<span class="property">plugins</span>, <span class="comment">// 导入公共配置的插件</span></span><br><span class="line">    <span class="title function_">html</span>(htmlDevTemple), <span class="comment">// 生成html文件</span></span><br><span class="line">    <span class="title function_">serve</span>(&#123;</span><br><span class="line">      <span class="attr">port</span>: <span class="number">3000</span>, <span class="comment">// 端口</span></span><br><span class="line">      <span class="attr">contentBase</span>: <span class="string">&#x27;dist&#x27;</span>, <span class="comment">// 服务器的根目录为输出目录</span></span><br><span class="line">      <span class="attr">openPage</span>: <span class="string">&#x27;/index.html&#x27;</span>, <span class="comment">// 打开哪个文件</span></span><br><span class="line">      <span class="attr">open</span>: <span class="literal">false</span>, <span class="comment">// 自动打开浏览器</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">livereload</span>(), <span class="comment">// 自动刷新浏览器</span></span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>rollup.config.prod.mjs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import html from &#x27;@rollup/plugin-html&#x27;;</span></span><br><span class="line"><span class="comment">// 压缩</span></span><br><span class="line"><span class="comment">// import terser from &#x27;@rollup/plugin-terser&#x27;;</span></span><br><span class="line"><span class="comment">// 公共配置</span></span><br><span class="line"><span class="keyword">import</span> common <span class="keyword">from</span> <span class="string">&quot;./rollup.config.common.mjs&quot;</span>;</span><br><span class="line"><span class="comment">// import &#123; htmlProdTemple &#125; from &#x27;./html-temple.mjs&#x27;;</span></span><br><span class="line"><span class="comment">// 用于生成 TypeScript 的声明文件</span></span><br><span class="line"><span class="keyword">import</span> dts <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-dts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Object.assign扩展公共配置</span></span><br><span class="line"><span class="comment">// 导出一个数组，数组中包含两个配置对象，rollup允许多入口多个产物</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, common, &#123;</span><br><span class="line">    <span class="attr">output</span>: [</span><br><span class="line">      <span class="comment">//打包 AMD CMD UMD</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">        <span class="attr">entryFileNames</span>: <span class="string">&quot;[name].js&quot;</span>,</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;umd&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Tracker&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 压缩的事还是应该交给用户自己去做</span></span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//   dir: &#x27;dist&#x27;,</span></span><br><span class="line">      <span class="comment">//   entryFileNames: &#x27;[name].min.js&#x27;,</span></span><br><span class="line">      <span class="comment">//   format: &#x27;umd&#x27;,</span></span><br><span class="line">      <span class="comment">//   name: &quot;tracker&quot;,</span></span><br><span class="line">      <span class="comment">//   plugins: [terser()],</span></span><br><span class="line">      <span class="comment">// &#125;,</span></span><br><span class="line">      <span class="comment">//打包common js</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">        <span class="attr">entryFileNames</span>: <span class="string">&quot;[name].cjs.js&quot;</span>,</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;cjs&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//   dir: &#x27;dist&#x27;,</span></span><br><span class="line">      <span class="comment">//   entryFileNames: &#x27;[name].cjs.min.js&#x27;,</span></span><br><span class="line">      <span class="comment">//   format: &#x27;cjs&#x27;,</span></span><br><span class="line">      <span class="comment">//   plugins: [terser()],</span></span><br><span class="line">      <span class="comment">// &#125;,</span></span><br><span class="line">      <span class="comment">//打包esModule</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">        <span class="attr">entryFileNames</span>: <span class="string">&quot;[name].esm.js&quot;</span>,</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&quot;es&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// &#123;</span></span><br><span class="line">      <span class="comment">//   dir: &#x27;dist&#x27;,</span></span><br><span class="line">      <span class="comment">//   entryFileNames: &#x27;[name].esm.min.js&#x27;,</span></span><br><span class="line">      <span class="comment">//   format: &#x27;es&#x27;,</span></span><br><span class="line">      <span class="comment">//   plugins: [terser()],</span></span><br><span class="line">      <span class="comment">// &#125;,</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      ...common.<span class="property">plugins</span>,</span><br><span class="line">      <span class="comment">// html(htmlProdTemple)</span></span><br><span class="line">    ],</span><br><span class="line">  &#125;),</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 打包d.ts</span></span><br><span class="line">    <span class="attr">input</span>: &#123;</span><br><span class="line">      <span class="attr">index</span>: <span class="string">&quot;./src/core/index.ts&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">      <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">      <span class="attr">entryFileNames</span>: <span class="string">&quot;[name].d.ts&quot;</span>,</span><br><span class="line">      <span class="attr">format</span>: <span class="string">&quot;es&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [<span class="title function_">dts</span>()],</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p><strong>tsconfig.json 配置：</strong></p>
<figure class="highlight json"><figcaption><span>tsconfig.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;incremental&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="comment">// TS编译器在第一次编译之后会生成一个存储编译信息的文件，第二次编译会在第一次的基础上进行增量编译，可以提高编译的速度</span></span><br><span class="line">    <span class="comment">// &quot;tsBuildInfoFile&quot;: &quot;./buildFile&quot;, // 增量编译文件的存储位置</span></span><br><span class="line">    <span class="comment">// &quot;diagnostics&quot;: true, // 打印诊断信息 </span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span> <span class="comment">/* 指定 ECMAScript 目标版本：&#x27;ES3&#x27; (default), &#x27;ES5&#x27;, &#x27;ES2015&#x27;, &#x27;ES2016&#x27;, &#x27;ES2017&#x27;,&#x27;ES2018&#x27; or &#x27;ESNEXT&#x27;. */</span></span><br><span class="line">    <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span> <span class="comment">/* 输出的代码使用什么方式进行模块化： &#x27;none&#x27;, &#x27;commonjs&#x27;, &#x27;amd&#x27;, &#x27;system&#x27;, &#x27;umd&#x27;, &#x27;es2015&#x27;, or &#x27;ESNext&#x27;. */</span></span><br><span class="line">    <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">/* 指定引用的标准库 */</span></span><br><span class="line">      <span class="string">&quot;esnext&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;dom&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// TS需要引用的库，即声明文件，es5 默认引用dom、es5、scripthost,如需要使用es的高级版本特性，通常都需要配置，如es8的数组新特性需要引入&quot;ES2019.Array&quot;,</span></span><br><span class="line">    <span class="attr">&quot;allowJs&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 允许编译器编译JS，JSX文件</span></span><br><span class="line">    <span class="attr">&quot;checkJs&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 允许在JS文件中报错，通常与allowJS一起使用</span></span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist&quot;</span><span class="punctuation">,</span> <span class="comment">// 指定输出目录</span></span><br><span class="line">    <span class="attr">&quot;rootDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./src&quot;</span><span class="punctuation">,</span> <span class="comment">// 指定输出文件目录(用于输出)，用于控制输出目录结构</span></span><br><span class="line">    <span class="comment">// &quot;declaration&quot;: true, // 生成声明文件，开启后会自动生成声明文件</span></span><br><span class="line">    <span class="comment">// &quot;declarationDir&quot;: &quot;./dist/typings&quot;, // 指定生成声明文件存放目录</span></span><br><span class="line">    <span class="comment">// &quot;emitDeclarationOnly&quot;: true, // 只生成声明文件，而不会生成js文件</span></span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="comment">// 生成目标文件的sourceMap文件</span></span><br><span class="line">    <span class="comment">// &quot;inlineSourceMap&quot;: true, // 生成目标文件的inline SourceMap，inline SourceMap会包含在生成的js文件中</span></span><br><span class="line">    <span class="attr">&quot;declarationMap&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="comment">// 为声明文件生成sourceMap</span></span><br><span class="line">    <span class="comment">// &quot;typeRoots&quot;: [], // 声明文件目录，默认时node_modules/@types</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// 加载的声明文件包</span></span><br><span class="line">    <span class="attr">&quot;removeComments&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 删除注释 </span></span><br><span class="line">    <span class="comment">// &quot;noEmit&quot;: true, // 不输出文件,即编译后不会生成任何js文件</span></span><br><span class="line">    <span class="attr">&quot;noEmitOnError&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 发送错误时不输出任何文件</span></span><br><span class="line">    <span class="attr">&quot;noEmitHelpers&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 不生成helper函数，减小体积，需要额外安装，常配合importHelpers一起使用</span></span><br><span class="line">    <span class="attr">&quot;importHelpers&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 通过tslib引入helper函数，文件必须是模块</span></span><br><span class="line">    <span class="attr">&quot;downlevelIteration&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 降级遍历器实现，如果目标源是es3/5，那么遍历器会有降级的实现</span></span><br><span class="line">    <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 开启所有严格的类型检查</span></span><br><span class="line">    <span class="attr">&quot;alwaysStrict&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 在代码中注入&#x27;use strict&#x27;</span></span><br><span class="line">    <span class="attr">&quot;noImplicitAny&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 不允许隐式的any类型</span></span><br><span class="line">    <span class="attr">&quot;strictNullChecks&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 不允许把null、undefined赋值给其他类型的变量</span></span><br><span class="line">    <span class="attr">&quot;strictFunctionTypes&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 不允许函数参数双向协变</span></span><br><span class="line">    <span class="attr">&quot;strictPropertyInitialization&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 类的实例属性必须初始化</span></span><br><span class="line">    <span class="attr">&quot;strictBindCallApply&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 严格的bind/call/apply检查</span></span><br><span class="line">    <span class="attr">&quot;noImplicitThis&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 不允许this有隐式的any类型</span></span><br><span class="line">    <span class="attr">&quot;noUnusedLocals&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 检查只声明、未使用的局部变量(只提示不报错)</span></span><br><span class="line">    <span class="attr">&quot;noUnusedParameters&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 检查未使用的函数参数(只提示不报错)</span></span><br><span class="line">    <span class="attr">&quot;noFallthroughCasesInSwitch&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 防止switch语句贯穿(即如果没有break语句后面不会执行)</span></span><br><span class="line">    <span class="attr">&quot;noImplicitReturns&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">//每个分支都会有返回值</span></span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 允许export=导出，由import from 导入</span></span><br><span class="line">    <span class="attr">&quot;allowUmdGlobalAccess&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 允许在模块中全局变量的方式访问umd模块</span></span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node&quot;</span><span class="punctuation">,</span> <span class="comment">// 模块解析策略，ts默认用node的解析策略，即相对的方式导入</span></span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./&quot;</span><span class="punctuation">,</span> <span class="comment">// 解析非相对模块的基地址，默认是当前目录</span></span><br><span class="line">    <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 路径映射，相对于baseUrl</span></span><br><span class="line">      <span class="comment">// &quot;@/*&quot;: [</span></span><br><span class="line">      <span class="comment">//   &quot;src/*&quot;</span></span><br><span class="line">      <span class="comment">// ]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rootDirs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;src&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// 将多个目录放在一个虚拟目录下，用于运行时，即编译后引入文件的位置可能发生变化，这也设置可以虚拟src和out在同一个目录下，不用再去改变路径也不会报错</span></span><br><span class="line">    <span class="attr">&quot;listEmittedFiles&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 打印输出文件</span></span><br><span class="line">    <span class="attr">&quot;listFiles&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="comment">// 打印编译的文件(包括引用的声明文件)</span></span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;emitDecoratorMetadata&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resolveJsonModule&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 指定一个匹配列表（属于自动指定该路径下的所有ts相关文件）</span></span><br><span class="line">  <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;src/**/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="comment">// 指定一个排除列表（include的反向操作）</span></span><br><span class="line">  <span class="comment">// &quot;exclude&quot;: [</span></span><br><span class="line">  <span class="comment">//   &quot;demo.ts&quot;</span></span><br><span class="line">  <span class="comment">// ],</span></span><br><span class="line">  <span class="comment">// 指定哪些文件使用该配置（属于手动一个个指定文件）</span></span><br><span class="line">  <span class="comment">// &quot;files&quot;: [</span></span><br><span class="line">  <span class="comment">//   &quot;src/index.d.ts&quot;</span></span><br><span class="line">  <span class="comment">// ]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>html-temple.mjs</strong> 配合 <code>rollup/plugin-html</code> 生成开发环境测试用的 html 文件，其实感觉也没比新建一个html文件方便。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight js"><figcaption><span>主要目录结构</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├───📁 dist/</span><br><span class="line">│   └───...</span><br><span class="line">├───📁 server/</span><br><span class="line">│   └───...</span><br><span class="line">├───📁 src/</span><br><span class="line">│   └───...</span><br><span class="line">└───...</span><br></pre></td></tr></table></figure>
<p><strong>根目录：</strong></p>
<ol>
<li><code>dist</code> 是Rollup输出目录，存放构建打包的产物</li>
<li><code>server</code> 一个简单的后端服务，用于测试数据上报。</li>
<li><code>src</code> 项目源码。</li>
</ol>
<figure class="highlight js"><figcaption><span>src源码目录结构</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">├───📁 core/ <span class="comment">// 核心源码</span></span><br><span class="line">│   ├───📁 tracker/ <span class="comment">// tracker相关类</span></span><br><span class="line">│   │   ├───📄 dom.<span class="property">ts</span> <span class="comment">// dom埋点</span></span><br><span class="line">│   │   ├───📄 error.<span class="property">ts</span> <span class="comment">// 错误监控</span></span><br><span class="line">│   │   ├───📄 index.<span class="property">ts</span> <span class="comment">// 统一暴露</span></span><br><span class="line">│   │   ├───📄 location.<span class="property">ts</span> <span class="comment">// 路由监控</span></span><br><span class="line">│   │   ├───📄 navigator.<span class="property">ts</span> <span class="comment">// 获取用户信息</span></span><br><span class="line">│   │   ├───📄 options.<span class="property">ts</span> <span class="comment">// tracker配置</span></span><br><span class="line">│   │   ├───📄 performance.<span class="property">ts</span> <span class="comment">// 性能监控，主要是dom和资源加载的性能</span></span><br><span class="line">│   │   └───📄 trackerCls.<span class="property">ts</span> <span class="comment">// 抽象类，控制其它tracker类行为</span></span><br><span class="line">│   └───📄 index.<span class="property">ts</span> <span class="comment">// 入口文件，Tracker类，管理配置和其它监控类实例。</span></span><br><span class="line">├───📁 types/ <span class="comment">// 类型</span></span><br><span class="line">│   └───📄 index.<span class="property">ts</span> <span class="comment">// 定义了一些ts类型</span></span><br><span class="line">├───📁 utils/ <span class="comment">// 工具函数</span></span><br><span class="line">│   ├───📄 beacon.<span class="property">ts</span> <span class="comment">// 封装sendBeacon</span></span><br><span class="line">│   ├───📄 index.<span class="property">ts</span> <span class="comment">// 统一暴露所有工具函数</span></span><br><span class="line">│   ├───📄 location.<span class="property">ts</span> <span class="comment">// 路由相关函数</span></span><br><span class="line">│   ├───📄 log.<span class="property">ts</span> <span class="comment">// 开发环境log</span></span><br><span class="line">│   ├───📄 navigator.<span class="property">ts</span> <span class="comment">// 获取用户信息</span></span><br><span class="line">│   ├───📄 performance.<span class="property">ts</span> <span class="comment">// 性能相关函数</span></span><br><span class="line">│   ├───📄 string.<span class="property">ts</span> <span class="comment">// 计算字符串大小</span></span><br><span class="line">│   ├───📄 uuid.<span class="property">ts</span> <span class="comment">// 获取uuid</span></span><br><span class="line">│   └───📄 watch.<span class="property">ts</span> <span class="comment">// 监视器，暂时没用到</span></span><br><span class="line">└───📄 index.<span class="property">d</span>.<span class="property">ts</span> <span class="comment">// 基础类型声明文件</span></span><br></pre></td></tr></table></figure>
<h1 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h1><p>解析项目还是由表及里好，先从入口文件 <code>core/index.ts</code> 讲起。<br>工具函数和类型文件的内容，在各个监控类用到时再穿插讲解。</p>
<p>入口文件导出了一个名为 <code>Tracker</code> 的类，我称之为主类，继承自 <code>TrackerOptions</code>，主类主要管理着其它监控类实例，并提供了上报数据的方法、与外部环境打交道。</p>
<figure class="highlight ts"><figcaption><span>src\core\index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="TrackerOptions配置类"><a href="#TrackerOptions配置类" class="headerlink" title="TrackerOptions配置类"></a>TrackerOptions配置类</h2><p><code>TrackerOptions</code> 是配置类，管理着所有监控类的配置，如上报地址、功能开启等。所有监控类都要根据配置来执行相应的操作。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\options.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DefaultOptions</span>, <span class="title class_">Options</span>, <span class="title class_">TrackerConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>; <span class="comment">// 导入类型</span></span><br><span class="line"><span class="keyword">import</span> &#123; getCanvasID &#125; <span class="keyword">from</span> <span class="string">&quot;../../utils&quot;</span>; <span class="comment">// 导入通过canvas获取uuid的方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">TrackerOptions</span> &#123;</span><br><span class="line">  <span class="comment">// 存储配置项，protected权限，实例不能访问，子类和自己可以访问</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">options</span>: <span class="title class_">Options</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 构造函数，接收配置项</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options</span>) &#123;</span><br><span class="line">    <span class="comment">// 合并默认和用户传入设置，用户传入设置优先级高</span></span><br><span class="line">    <span class="comment">// 通过 Object.assign 合并默认配置和用户配置</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="title function_">initDefault</span>(), options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化配置项</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">initDefault</span>(): <span class="title class_">DefaultOptions</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;<span class="title class_">DefaultOptions</span>&gt;&#123;</span><br><span class="line">      <span class="attr">requestUrl</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 上报地址</span></span><br><span class="line">      <span class="attr">uuid</span>: <span class="variable language_">this</span>.<span class="title function_">generateUserID</span>(), <span class="comment">// 用户唯一标识</span></span><br><span class="line">      <span class="attr">historyTracker</span>: <span class="literal">false</span>, <span class="comment">// history模式，开启后会监听路由变化</span></span><br><span class="line">      <span class="attr">hashTracker</span>: <span class="literal">false</span>, <span class="comment">// hash模式，开启后会监听路由变化</span></span><br><span class="line">      <span class="attr">errorTracker</span>: <span class="literal">false</span>, <span class="comment">// 错误监控</span></span><br><span class="line">      <span class="attr">domTracker</span>: <span class="literal">false</span>, <span class="comment">// dom埋点监控</span></span><br><span class="line">      <span class="comment">// 需要监控的dom事件</span></span><br><span class="line">      <span class="attr">domEventsList</span>: <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;dblclick&#x27;</span>, <span class="string">&#x27;contextmenu&#x27;</span>, <span class="string">&#x27;mousedown&#x27;</span>, <span class="string">&#x27;mouseup&#x27;</span>, <span class="string">&#x27;mouseout&#x27;</span>, <span class="string">&#x27;mouseover&#x27;</span>]),</span><br><span class="line">      <span class="attr">performanceTracker</span>: <span class="literal">false</span>, <span class="comment">// 性能监控</span></span><br><span class="line">      <span class="attr">navigatorTracker</span>: <span class="literal">false</span>, <span class="comment">// 用户信息监控</span></span><br><span class="line">      <span class="attr">extra</span>: <span class="literal">undefined</span>, <span class="comment">// 上报时需要携带的额外信息</span></span><br><span class="line">      <span class="attr">sdkVersion</span>: <span class="title class_">TrackerConfig</span>.<span class="property">version</span>, <span class="comment">// sdk版本</span></span><br><span class="line">      <span class="attr">log</span>: <span class="literal">true</span>, <span class="comment">// 是否在控制台打印日志</span></span><br><span class="line">      <span class="attr">realTime</span>: <span class="literal">false</span>, <span class="comment">// 是否实时上报</span></span><br><span class="line">      <span class="attr">maxSize</span>: <span class="number">1024</span> * <span class="number">50</span> <span class="comment">// 单次上报数据最大值，单位字节</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 生成uuid</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">generateUserID</span>(): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getCanvasID</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看默认配置项，由私有方法 <code>initDefault()</code> 提供，为 <code>DefaultOptions</code> 类型。</p>
<figure class="highlight ts"><figcaption><span>DefaultOptions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DefaultOptions</span> &#123;</span><br><span class="line">  <span class="attr">requestUrl</span>: <span class="built_in">string</span>, <span class="comment">// 上报地址</span></span><br><span class="line">  <span class="attr">uuid</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>, <span class="comment">// 用户唯一标识</span></span><br><span class="line">  <span class="attr">historyTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// history模式，开启后会监听路由变化</span></span><br><span class="line">  <span class="attr">hashTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// hash模式，开启后会监听路由变化</span></span><br><span class="line">  <span class="attr">errorTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// 错误监控</span></span><br><span class="line">  <span class="attr">domTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// dom埋点监控</span></span><br><span class="line">  <span class="attr">domEventsList</span>: <span class="title class_">Set</span>&lt;keyof <span class="title class_">HTMLElementEventMap</span>&gt;, <span class="comment">// 需要监控的dom事件</span></span><br><span class="line">  <span class="attr">performanceTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// 性能监控</span></span><br><span class="line">  <span class="attr">navigatorTracker</span>: <span class="built_in">boolean</span>, <span class="comment">// 用户信息监控</span></span><br><span class="line">  <span class="attr">extra</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; | <span class="literal">undefined</span>, <span class="comment">// 上报时需要携带的额外信息</span></span><br><span class="line">  <span class="attr">sdkVersion</span>: <span class="built_in">string</span> | <span class="built_in">number</span>, <span class="comment">// sdk版本</span></span><br><span class="line">  <span class="attr">log</span>: <span class="built_in">boolean</span>, <span class="comment">// 是否在控制台打印日志</span></span><br><span class="line">  <span class="attr">realTime</span>: <span class="built_in">boolean</span>, <span class="comment">// 是否实时上报</span></span><br><span class="line">  <span class="attr">maxSize</span>: <span class="built_in">number</span>, <span class="comment">// 单次上报数据最大值，单位字节</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="built_in">enum</span> <span class="title class_">TrackerConfig</span> &#123;</span><br><span class="line">  version = <span class="string">&#x27;1.0.0&#x27;</span>, <span class="comment">// 版本</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有功能默认都是关闭的，用户可以根据需要开启。uuid通过 <code>generateUserID()</code> 方法获取，domEventsList 已经配置了一些常用的dom事件。sdkVersion 则是通过枚举类型 <code>TrackerConfig</code> 获取。</p>
<p>配置类的构造函数传入一个 <code>Options</code> 类型的外部配置项，通过 <code>Object.assign</code> 合并默认配置和用户配置，用户配置优先级高。</p>
<p><code>Options</code> 类型由 <code>DefaultOptions</code> 类型，通过 <code>Optional</code> 高级类型加工而来，将 requestUrl 设为必选项，而其它都是可选项，也就是必须传入一个上报地址。</p>
<figure class="highlight ts"><figcaption><span>Options</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户传入选项</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Options</span> = <span class="title class_">Optional</span>&lt;<span class="title class_">DefaultOptions</span>, <span class="string">&#x27;requestUrl&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>TS并<strong>没有</strong>提供 <code>Optional</code> 高级类型，用于将某些属性设为可选项。需要自己实现。</p>
<ol>
<li>传入两个泛型参数，<code>T</code>为原始类型，<code>K</code>为必选项，是 <code>T</code> 的属性名。</li>
<li><code>Pick</code> 类型将必选项筛选出来，<code>Omit</code> 去掉必选项，再使用 <code>Partial</code> 类型将其它属性设为可选项。</li>
<li>最后通过联合类型 <code>&amp;</code> 合并两个类型。</li>
</ol>
<p>高级类型就像是类型的函数，加工原始类型，返回一个新的类型。</p>
<figure class="highlight ts"><figcaption><span>Optional</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选项生成器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">T</span> - 原始类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">K</span> - 必填类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Optional</span>&lt;T, K <span class="keyword">extends</span> keyof T&gt; = <span class="title class_">Pick</span>&lt;T, K&gt; &amp; <span class="title class_">Partial</span>&lt;<span class="title class_">Omit</span>&lt;T, K&gt;&gt;;</span><br></pre></td></tr></table></figure>
<p>最后，将合并后的配置项存储在 <code>options</code> 属性中。为 <code>protected</code> 权限，只能由子类和自己访问。当然，主类也提供了一些方法，允许动态设置一些配置项，如uuid、额外数据等。</p>
<h2 id="trackerCls"><a href="#trackerCls" class="headerlink" title="trackerCls"></a>trackerCls</h2><p>主类管理着所有具体监控类的实例，而这些监控类都继承自 <code>trackerCls</code> 这个抽象类。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span>, <span class="title class_">EventListeners</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象类，具体的监控类需要继承该类，控制监控类的行为</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TrackerCls</span> &#123;</span><br><span class="line">  <span class="comment">// 存储配置项</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">options</span>: <span class="title class_">Options</span></span><br><span class="line">  <span class="comment">// 存储上报数据的方法</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">reportTracker</span>: <span class="title class_">Function</span> <span class="comment">// 上报数据的方法</span></span><br><span class="line">  <span class="comment">// 存储事件监听器</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="attr">eventListeners</span>: <span class="title class_">EventListeners</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 配置项和上报方法由外部传入</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reportTracker</span> = reportTracker;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 抽象方法，如何初始化交给具体的监控类去实现。</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">init</span>(): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 封装addEventListener</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">addEventListener</span>(<span class="params">name: <span class="built_in">string</span>, handler: EventListenerOrEventListenerObject, options: <span class="built_in">boolean</span> | AddEventListenerOptions = <span class="literal">false</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 如果没有该事件的监听数组，就初始化一个空的</span></span><br><span class="line">    !<span class="variable language_">this</span>.<span class="property">eventListeners</span>.<span class="title function_">hasOwnProperty</span>(name) &amp;&amp; (<span class="variable language_">this</span>.<span class="property">eventListeners</span>[name] = [])</span><br><span class="line">    <span class="comment">// 将事件监听器存入数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventListeners</span>[name].<span class="title function_">push</span>(handler)</span><br><span class="line">    <span class="comment">// 添加事件监听</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(name, handler, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 额外需要销毁的内容，由具体的监控类去实现</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">additionalDestroy</span>(): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 销毁方法，因为有事件监听器，所以需要销毁事件监听器，避免内存泄漏</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 遍历eventListeners获取所有事件监听器，然后移除</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> eventName <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">eventListeners</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> listeners = <span class="variable language_">this</span>.<span class="property">eventListeners</span>[eventName];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> listener <span class="keyword">of</span> listeners) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(eventName, listener);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 清空eventListeners</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventListeners</span> = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 调用额外销毁的方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">additionalDestroy</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>trackerCls</code> 控制监控类的基本行为：</p>
<ol>
<li>构造函数需要接收从外部（主类）传入的配置项和上报方法。并根据配置项初始化自己，在合适的时候上报数据。</li>
<li>规定了抽象方法 <code>init</code>，具体的监控类需要实现初始化方法。</li>
<li>提供了 <code>addEventListener</code> 方法，封装了 <code>window.addEventListener</code>，并存储了事件监听器，方便销毁。</li>
<li>提供了 <code>destroy</code> 方法，用于销毁事件监听器，避免内存泄漏。同时定义了 <code>additionalDestroy</code> 抽象方法，额外需要销毁的内容由具体的监控类去实现。</li>
</ol>
<h2 id="Tracker主类"><a href="#Tracker主类" class="headerlink" title="Tracker主类"></a>Tracker主类</h2><p>再回来看主类 <code>Tracker</code>，继承自 <code>TrackerOptions</code>，所以拥有配置类的属性和方法。</p>
<p>主类的构造函数同样接收一个 <code>Options</code> 类型的配置项，并通过 <code>super</code> 调用父类构造函数，初始化配置项。现在，配置项由主类进行管理了。</p>
<p>主类提供了一些 <code>public</code> 方法，<code>setUserID</code>、<code>setExtra</code>，允许动态设置配置项。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许外部设置uuid</span></span><br><span class="line"><span class="keyword">public</span> setUserID&lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptions</span>[<span class="string">&#x27;uuid&#x27;</span>]&gt;(<span class="attr">uuid</span>: T) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDestroy</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">uuid</span> = uuid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 外部设置额外参数</span></span><br><span class="line"><span class="keyword">public</span> setExtra&lt;T <span class="keyword">extends</span> <span class="title class_">DefaultOptions</span>[<span class="string">&#x27;extra&#x27;</span>]&gt;(<span class="attr">extra</span>: T) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDestroy</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">extra</span> = extra;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>继续看构造函数：</strong></p>
<ol>
<li>实例化了各种监控类，并存储在了 <code>trackers</code> 私有对象的对应属性上。这是为了方便管理和调用类上的方法（初始化、销毁）。</li>
<li>所有监控类都需要接收配置项和上报方法，上报方法包装了主类的 <code>reportTracker</code> 方法。</li>
</ol>
<p>在设计上，监控类只负责自己的监控职责，并在合适的适合上报数据，不负责数据的具体处理和上报逻辑，具体的上报实现由主类负责。</p>
<figure class="highlight ts"><figcaption><span>src\core\index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TrackerOptions</span>, <span class="title class_">LocationTracker</span>, <span class="title class_">DomTracker</span>, <span class="title class_">ErrorTracker</span>, <span class="title class_">PerformanceTracker</span>, <span class="title class_">NavigatorTracker</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./tracker&quot;</span>;</span><br><span class="line"><span class="comment">// 存储各种Tracker的实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">trackers</span>: <span class="title class_">Trackers</span> = &#123;</span><br><span class="line">  <span class="attr">locationTracker</span>: <span class="literal">undefined</span>, <span class="comment">// 路由监控实例</span></span><br><span class="line">  <span class="attr">domTracker</span>: <span class="literal">undefined</span>, <span class="comment">// dom埋点监控实例</span></span><br><span class="line">  <span class="attr">errorTracker</span>: <span class="literal">undefined</span>, <span class="comment">// 错误监控实例</span></span><br><span class="line">  <span class="attr">performanceTracker</span>: <span class="literal">undefined</span>, <span class="comment">// 性能监控实例</span></span><br><span class="line">  <span class="attr">navigatorTracker</span>: <span class="literal">undefined</span>, <span class="comment">// 用户信息监控实例</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">options: Options</span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>(options);</span><br><span class="line">  <span class="comment">// 创建各种Tracker的实例，将配置和上报方法传入</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">locationTracker</span> = <span class="keyword">new</span> <span class="title class_">LocationTracker</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>,</span><br><span class="line">    &lt;T&gt;<span class="function">(<span class="params">data: T, key: <span class="built_in">string</span></span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, key)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">domTracker</span> = <span class="keyword">new</span> <span class="title class_">DomTracker</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>,</span><br><span class="line">    &lt;T&gt;<span class="function">(<span class="params">data: T, key: <span class="built_in">string</span></span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, key)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">errorTracker</span> = <span class="keyword">new</span> <span class="title class_">ErrorTracker</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>,</span><br><span class="line">    &lt;T&gt;<span class="function">(<span class="params">data: T, key: <span class="built_in">string</span></span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, key)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">performanceTracker</span> = <span class="keyword">new</span> <span class="title class_">PerformanceTracker</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>,</span><br><span class="line">    &lt;T&gt;<span class="function">(<span class="params">data: T, key: <span class="built_in">string</span></span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, key)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">navigatorTracker</span> = <span class="keyword">new</span> <span class="title class_">NavigatorTracker</span>(</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>,</span><br><span class="line">    &lt;T&gt;<span class="function">(<span class="params">data: T, key: <span class="built_in">string</span></span>) =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, key)</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 调用初始化方法</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型 src\types\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LocationTracker</span>, <span class="title class_">DomTracker</span>, <span class="title class_">ErrorTracker</span>, <span class="title class_">PerformanceTracker</span>, <span class="title class_">NavigatorTracker</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../core/tracker&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Trackers</span> = &#123;</span><br><span class="line">  <span class="attr">locationTracker</span>: <span class="title class_">LocationTracker</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">domTracker</span>: <span class="title class_">DomTracker</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">errorTracker</span>: <span class="title class_">ErrorTracker</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">performanceTracker</span>: <span class="title class_">PerformanceTracker</span> | <span class="literal">undefined</span>,</span><br><span class="line">  <span class="attr">navigatorTracker</span>: <span class="title class_">NavigatorTracker</span> | <span class="literal">undefined</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>初始化：</strong><br>实例化完各种监控类后，调用了 <code>init()</code> 私有方法。</p>
<ol>
<li>遍历所有Tracker实例，调用其初始化方法。</li>
<li>如果不是实时上报模式，初始化 <code>beforeCloseReport</code>，主类控制在页面关闭前上报。</li>
</ol>
<p>只要监听了事件，其回调都应该保存起来，以便在合适的时候销毁。这里监听了 <code>beforeunload</code> 事件，所以使用 <code>beforeCloseHandler</code> 私有属性保存其回调。</p>
<figure class="highlight ts"><figcaption><span>初始化相关属性和方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储字符串大小计算方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">stringSizeCalculation</span>: <span class="title class_">Function</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// 存储beforeCloseHandler，页面关闭前执行的回调</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">beforeCloseHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历所有Tracker实例，调用其初始化方法</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">trackers</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">trackers</span>[key <span class="keyword">as</span> keyof <span class="title class_">Trackers</span>]?.<span class="title function_">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不是实时上报模式，初始化beforeCloseReport，主类控制在页面关闭前上报</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">realTime</span>) &#123;</span><br><span class="line">      <span class="comment">// 创建字符串大小计算方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">stringSizeCalculation</span> = <span class="title function_">createStringSizeCalculation</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">beforeCloseReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果允许log，则打印初始化成功</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">log</span> &amp;&amp; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Tracker is OK&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// console.log(e);</span></span><br><span class="line">    <span class="comment">// 初始化出错，则直接上报错误</span></span><br><span class="line">    <span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">requestUrl</span>, <span class="variable language_">this</span>.<span class="title function_">decorateData</span>(&#123;</span><br><span class="line">      <span class="attr">targetKey</span>: <span class="string">&quot;tracker&quot;</span>,</span><br><span class="line">      <span class="attr">event</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">      <span class="attr">message</span>: e,</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">log</span> &amp;&amp; <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Tracker is error&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 启动页面关闭前上报</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">beforeCloseReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 设置beforeCloseHandler</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">beforeCloseHandler</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">sendReport</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 监听页面关闭前beforeunload事件</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;beforeunload&quot;</span>, <span class="variable language_">this</span>.<span class="property">beforeCloseHandler</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>销毁：</strong><br>主类提供了公共方法 <code>destroy</code>，允许外部销毁监控。主要是调用了各个监控类的销毁方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 销毁</span></span><br><span class="line">public <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果已经销毁，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDestroy</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// 销毁前把剩余数据传出</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">sendReport</span>();</span><br><span class="line">  <span class="comment">// 遍历所有监控类</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">trackers</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用其销毁方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">trackers</span>[key <span class="keyword">as</span> keyof <span class="title class_">Trackers</span>]?.<span class="title function_">destroy</span>();</span><br><span class="line">    <span class="comment">// 将其实例置为undefined，以便GC回收</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">trackers</span>[key <span class="keyword">as</span> keyof <span class="title class_">Trackers</span>] = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 移除beforeCloseHandler</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">beforeCloseHandler</span> &amp;&amp; <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;beforeunload&quot;</span>, <span class="variable language_">this</span>.<span class="property">beforeCloseHandler</span>);</span><br><span class="line">  <span class="comment">// 设置属性为undefined，以便GC回收</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stringSizeCalculation</span> = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">beforeCloseHandler</span> = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// 将销毁标志置为true</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isDestroy</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="数据上报"><a href="#数据上报" class="headerlink" title="数据上报"></a>数据上报</h1><p>上报数据的方法由主类提供，并通过构造函数注入给其它各个监控类。</p>
<h2 id="封装sendBeacon"><a href="#封装sendBeacon" class="headerlink" title="封装sendBeacon"></a>封装sendBeacon</h2><p>传统的数据上报方式，如 XMLHttpRequest 或 Fetch API，容易受到页面卸载过程中的阻塞，导致数据丢失。</p>
<p>而 <code>navigator.sendBeacon</code> 可以在页面卸载时安全、可靠地发送数据。</p>
<ol>
<li>异步执行，不阻塞页面关闭或跳转。</li>
<li>不受页面卸载过程的影响，确保数据可靠发送。</li>
<li>无法获取响应，但在发送<strong>简单请求</strong>时天然跨域，就像fetch的no-cors模式一样。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>sendBeacon 只能发送 POST 请求。</li>
<li><strong>请求类型为 ping</strong>，只能传送少量数据（通常是 <strong>64KB 以内</strong>），无法自定义请求头。</li>
<li>只能传输 ArrayBuffer、ArrayBufferView、Blob、DOMString、FormData 或 URLSearchParams 类型的数据。</li>
<li>如果处于危险的网络环境，或者开启了广告屏蔽插件 此请求将无效</li>
</ol>
<p><code>sendBeacon(url, data)</code> 接收两个参数，第一个是地址，第二个是数据。</p>
<p><strong>返回值：</strong>boolean</p>
<ol>
<li>true: 数据被异步缓存，但并不保证数据已被成功发送或接收。所以后续考虑只在关闭页面前使用 sendBeacon，其它时候使用 fetch。</li>
<li>false: 数据无法被缓存，通常是因为数据太大或 URL 无效。</li>
</ol>
<p><strong>数据类型：</strong><br>如果data是字符串类型，那么<strong>content-type</strong>会自动匹配为<code>text/plain</code>，如果是FormData类型，则会自动匹配为multipart/form-data类型。</p>
<p>如果想要发送json数据，则需要借助Blob对象。通过Blob的type参数，可以指定MIME类型，间接达到设置Content-Type的目的。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> <span class="title class_">Blob</span>([<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params)], &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但这会导致跨域，因为不是原始的三个<strong>Content-Type</strong>。所以不如直接使用<code>text/plain</code>，请求体是JSON字符串。后端使用 <code>JSON.parse</code> 解析。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封装sendBeacon，传入url和params，返回上报状态</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">sendBeacon</span>(<span class="params">url: <span class="built_in">string</span>, params: <span class="built_in">object</span></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="comment">// 判断是否有数据，也就是params是否为空对象</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="title function_">keys</span>(params).<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// const blob = new Blob([JSON.stringify(params)], &#123;</span></span><br><span class="line">  <span class="comment">//   type: &#x27;application/json&#x27;</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line">  <span class="keyword">const</span> state = navigator.<span class="title function_">sendBeacon</span>(url, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params));</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个简单的 express 后端，使用 <code>express.text()</code> 解析请求体的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/tracker&#x27;</span>, express.<span class="title function_">text</span>(), <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">body</span>));</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;listening on&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="reportTracker方法"><a href="#reportTracker方法" class="headerlink" title="reportTracker方法"></a>reportTracker方法</h2><p><code>reportTracker</code> 是 <code>Tracker</code> 主类上报数据的私有方法，通过构造函数注入给各个监控类。</p>
<figure class="highlight ts"><figcaption><span>src\core\index.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="attr">report</span>: <span class="title class_">Report</span> = &#123;&#125;; <span class="comment">// 暂存上报数据</span></span><br><span class="line"><span class="comment">// 上报</span></span><br><span class="line"><span class="keyword">private</span> reportTracker&lt;T&gt;(<span class="attr">data</span>: T, <span class="attr">key</span>: <span class="built_in">string</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="comment">// 调用decorateData修饰数据</span></span><br><span class="line">  <span class="keyword">const</span> params = <span class="variable language_">this</span>.<span class="title function_">decorateData</span>(data);</span><br><span class="line">  <span class="comment">// 如果是实时上报模式，直接调用sendBeacon上报</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">realTime</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">requestUrl</span>, params);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 将数据存入report属性中对应key的数组中</span></span><br><span class="line">    !<span class="variable language_">this</span>.<span class="property">report</span>.<span class="title function_">hasOwnProperty</span>(key) &amp;&amp; (<span class="variable language_">this</span>.<span class="property">report</span>[key] = []);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">report</span>[key].<span class="title function_">push</span>(params);</span><br><span class="line">    <span class="comment">// 不是实时上报模式，先判断是否超过最大值，超过则上报</span></span><br><span class="line">    <span class="keyword">const</span> size =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">stringSizeCalculation</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">stringSizeCalculation</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">report</span>));</span><br><span class="line">    log &amp;&amp; <span class="title function_">log</span>(size, params); <span class="comment">// 打印上报数据,方便调试</span></span><br><span class="line">    <span class="comment">// 判断是否超过最大值，已经超过了则上报</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">maxSize</span> &amp;&amp;</span><br><span class="line">      size &amp;&amp;</span><br><span class="line">      size &gt; (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">maxSize</span> || <span class="number">10000</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 调用累积上报方法</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">sendReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先使用了 <code>decorateData</code> 方法修饰数据，加上了uuid、时间戳、路由等统一信息。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修饰数据，加上统一信息</span></span><br><span class="line"><span class="keyword">private</span> decorateData&lt;T&gt;(<span class="attr">data</span>: T): <span class="built_in">object</span> &#123;</span><br><span class="line">  <span class="comment">// 将传入的数据和统一信息合并</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, &#123;</span><br><span class="line">    <span class="attr">uuid</span>: <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">uuid</span>, <span class="comment">// 加上uuid</span></span><br><span class="line">    <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>(), <span class="comment">// 加上时间戳</span></span><br><span class="line">    <span class="attr">location</span>: <span class="variable language_">this</span>.<span class="property">trackers</span>.<span class="property">locationTracker</span>?.<span class="title function_">getLocation</span>(), <span class="comment">// 加上当前路由，由路由监控实例提供</span></span><br><span class="line">    <span class="attr">extra</span>: <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">extra</span>, <span class="comment">// 加上配置项中的额外数据</span></span><br><span class="line">  &#125;, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是实时上报模式，直接调用 <code>sendBeacon()</code> 上报数据。</p>
<p>如果不是实时上报模式，先将本次数据存入 <code>report</code> 属性对应<strong>key</strong>的数组中，然后通过 <code>stringSizeCalculation()</code> 方法判断 <code>report</code> 缓存是否超过最大值，超过则调用 <code>sendReport()</code> 累积上报方法。</p>
<p><code>stringSizeCalculation()</code> 方法通过 <code>TextEncoder</code> 编码器对字符串进行编码，然后返回字节长度，粗略计算字符串大小，单位字节。</p>
<figure class="highlight ts"><figcaption><span>src\utils\string.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createStringSizeCalculation</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> textEncode = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">str: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> textEncode.<span class="title function_">encode</span>(str).<span class="property">length</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sendReport累积上报"><a href="#sendReport累积上报" class="headerlink" title="sendReport累积上报"></a>sendReport累积上报</h2><p>如果不是实时上报模式，则监控数据会缓存在 <code>report</code> 对象中，按监控类型，也就是key分类保存在对应属性值（数组）中。</p>
<blockquote>
<p>大多数情况下应该使用非实时模式，监控数据不会立即上报，而是等待数据累积到一定程度再上报，这样可以减少请求次数，提高性能。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 累积数据上报方法</span></span><br><span class="line"><span class="comment">// 这是一个公共方法，允许外部调用，用户可以在合适的时候上报数据，而不用等数据累积超过最大值</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">sendReport</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="comment">// 如果已经销毁，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDestroy</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 调用sendBeacon上报数据</span></span><br><span class="line">  <span class="keyword">const</span> state = <span class="title function_">sendBeacon</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">requestUrl</span>, <span class="variable language_">this</span>.<span class="property">report</span>);</span><br><span class="line">  <span class="comment">// 上报成功后清空report</span></span><br><span class="line">  state &amp;&amp; (<span class="variable language_">this</span>.<span class="property">report</span> = &#123;&#125;);</span><br><span class="line">  <span class="comment">// 返回上报状态</span></span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sendReport()</code> 是一个公共方法，允许外部调用，用户可以在合适的时候上报数据，而不用等数据累积超过最大值。</p>
<h2 id="sendTracker用户主动上报"><a href="#sendTracker用户主动上报" class="headerlink" title="sendTracker用户主动上报"></a>sendTracker用户主动上报</h2><p>很多情况下，监控需要和业务内容高度耦合，这是通用的监控类或埋点无法做到的，所以主类提供了 <code>sendTracker()</code> 方法，允许用户主动上报数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主动上报</span></span><br><span class="line"><span class="keyword">public</span> sendTracker&lt;T&gt;(<span class="attr">targetKey</span>: <span class="built_in">string</span> = <span class="string">&quot;manual&quot;</span>, data?: T) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDestroy</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">event</span>: <span class="string">&quot;manual&quot;</span>,</span><br><span class="line">      targetKey,</span><br><span class="line">      data,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;manual&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sendTracker()</code> 实际上只是调用了 <code>reportTracker()</code> 方法，在 <code>report</code> 缓存中的 key 为 <strong>manual</strong>。</p>
<h1 id="LocationTracker类"><a href="#LocationTracker类" class="headerlink" title="LocationTracker类"></a>LocationTracker类</h1><p>监控最重要一点就是知道，当前是在哪个页面，以及用户在当前页面的停留时长。对于SPA或启用了PJAX的站点，还需要监控路由的切换，包括 history 和 hash 的变化。</p>
<p><code>LocationTracker</code> 类就是用来监控路由信息的。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\location.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TrackerCls</span> <span class="keyword">from</span> <span class="string">&quot;./trackerCls&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createHistoryMonitoring, getLocation &#125; <span class="keyword">from</span> <span class="string">&quot;../../utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">LocationTracker</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TrackerCls</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">enterTime</span>: <span class="built_in">number</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span>; <span class="comment">// 记录用户进入当前页面时的时间戳</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">location</span>: <span class="built_in">string</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span>; <span class="comment">// 记录用户当前页面</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 调用父类的构造函数</span></span><br><span class="line">    <span class="variable language_">super</span>(options, reportTracker);</span><br><span class="line">    <span class="comment">// 初始化用户进入当前页面的时间戳和当前页面</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">reLocationRecord</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 如果开启了history监控，就监听history变化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">historyTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">historyChangeReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果开启了hash监控，就监听hash变化</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">hashTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">hashChangeReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果开启了任意路由监控，则开启页面关闭前上报关闭信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">historyTracker</span> || <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">hashTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">beforeCloseRouterReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 销毁时额外需要销毁的内容</span></span><br><span class="line">  <span class="title function_">additionalDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enterTime</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">location</span> = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新当前路径和进入时间</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">reLocationRecord</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">enterTime</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">location</span> = <span class="title function_">getLocation</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 进行location监听</span></span><br><span class="line">  <span class="keyword">private</span> captureLocationEvent&lt;T&gt;(<span class="attr">event</span>: <span class="built_in">string</span>, <span class="attr">targetKey</span>: <span class="built_in">string</span>, data?: T) &#123;</span><br><span class="line">    <span class="comment">// 回调</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 数据</span></span><br><span class="line">      <span class="keyword">const</span> d = &#123;</span><br><span class="line">        event, <span class="comment">// 事件类型</span></span><br><span class="line">        targetKey, <span class="comment">// 目标key，按后端需要自定义，默认为 history-pv 或 hash-pv</span></span><br><span class="line">        <span class="attr">location</span>: <span class="variable language_">this</span>.<span class="property">location</span>, <span class="comment">// 原路由</span></span><br><span class="line">        <span class="attr">targetLocation</span>: <span class="title function_">getLocation</span>(), <span class="comment">// 当前路由，也就是目标路由</span></span><br><span class="line">        <span class="comment">// 用户访问该路由时长</span></span><br><span class="line">        <span class="attr">duration</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() - <span class="variable language_">this</span>.<span class="property">enterTime</span>!,</span><br><span class="line">        data, <span class="comment">// 额外的数据</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// 上报数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(d, <span class="string">&quot;router&quot;</span>);</span><br><span class="line">      <span class="comment">// 更新当前路径和进入时间</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reLocationRecord</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 监听事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(event, eventHandler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 监听history变化</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">historyChangeReport</span>(<span class="params">eventName: <span class="built_in">string</span> = <span class="string">&quot;historyChange&quot;</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 创建History变化的统一事件</span></span><br><span class="line">    <span class="title function_">createHistoryMonitoring</span>(eventName);</span><br><span class="line">    <span class="comment">// 监听该事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">captureLocationEvent</span>(eventName, <span class="string">&quot;history-pv&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 监听hash变化</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">hashChangeReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 也就是监听hashchange事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">captureLocationEvent</span>(<span class="string">&quot;hashchange&quot;</span>, <span class="string">&quot;hash-pv&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 页面关闭前上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">beforeCloseRouterReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">realTime</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> eventName = <span class="string">&quot;beforeunload&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> d = &#123;</span><br><span class="line">        <span class="attr">event</span>: eventName,</span><br><span class="line">        <span class="attr">targetKey</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">        <span class="attr">location</span>: <span class="variable language_">this</span>.<span class="property">location</span>,</span><br><span class="line">        <span class="attr">duration</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() - <span class="variable language_">this</span>.<span class="property">enterTime</span>!,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(d, <span class="string">&quot;router&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(eventName, eventHandler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 给外部提供页面信息</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">getLocation</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">location</span>!;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="监听路由变化"><a href="#监听路由变化" class="headerlink" title="监听路由变化"></a>监听路由变化</h2><p><strong>hash</strong>变化可以直接监听 <code>hashchange</code> 事件</p>
<p>而<strong>history</strong>变化则比较特殊。</p>
<ol>
<li>全局 <code>history</code> 对象上的 <code>back()</code>, <code>forward()</code> 和 <code>go()</code>，浏览器的前进后退按钮，会触发 <code>popstate</code> 事件。</li>
<li>但 <code>pushState()</code> 和 <code>replaceState()</code> 不会触发 <code>popstate</code> 事件。且没有对应的事件可以监听。</li>
</ol>
<p>所以需要重写这两个方法，在其被调用时，通知监听者。借助 <code>Event</code> 类可以很方便地创建一个统一的自定义事件。</p>
<figure class="highlight ts"><figcaption><span>src\utils\location.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// back()、forward() 和 go() 事件都会触发 popState 事件。</span></span><br><span class="line"><span class="comment">// 但是 pushState() 和 replaceEstate() 不会触发 popState 事件。因此我们需要做些代码处理让它们都能触发某一个事件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createHistoryEvent = &lt;T <span class="keyword">extends</span> keyof <span class="title class_">History</span>&gt;(</span><br><span class="line">  <span class="attr">type</span>: T,</span><br><span class="line">  <span class="attr">eventName</span>: <span class="built_in">string</span></span><br><span class="line">): <span class="function">(<span class="params">() =&gt; <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> origin = history[<span class="keyword">type</span>]; <span class="comment">// 保存原始方法</span></span><br><span class="line">  <span class="keyword">const</span> e = <span class="keyword">new</span> <span class="title class_">Event</span>(eventName); <span class="comment">// 创建自定义事件</span></span><br><span class="line">  <span class="keyword">const</span> typeEvent = <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="keyword">type</span>); <span class="comment">// 创建方法同名事件</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"><span class="variable language_">this</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 调用原始方法</span></span><br><span class="line">    <span class="keyword">const</span> res = origin.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="comment">// 触发自定义事件</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">dispatchEvent</span>(typeEvent);</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">dispatchEvent</span>(e);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建对history的监听，统一触发指定自定义事件。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; [eventName=&#x27;historyChange&#x27;] history变化统一触发的自定义事件名。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * window.addEventListener(&#x27;historyChange&#x27;, () =&gt; &#123;</span></span><br><span class="line"><span class="comment"> *  console.log(&#x27;history changed!&#x27;)</span></span><br><span class="line"><span class="comment"> * &#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createHistoryMonitoring</span>(<span class="params">eventName: <span class="built_in">string</span> = <span class="string">&quot;historyChange&quot;</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 重写history的pushState方法</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">history</span>[<span class="string">&quot;pushState&quot;</span>] = <span class="title function_">createHistoryEvent</span>(<span class="string">&quot;pushState&quot;</span>, eventName);</span><br><span class="line">  <span class="comment">// 重写history的replaceState方法</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">history</span>[<span class="string">&quot;replaceState&quot;</span>] = <span class="title function_">createHistoryEvent</span>(</span><br><span class="line">    <span class="string">&quot;replaceState&quot;</span>,</span><br><span class="line">    eventName</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 在触发popstate事件时，触发自定义事件</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;popstate&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">dispatchEvent</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(eventName));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前页面的路径</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getLocation</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span> + <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在<code>pushState</code>和<code>replaceState</code>方法，以及<strong>popstate</strong>事件，都会触发自定义的 <code>historyChange</code> 事件，且还有pushState和replaceState两个和方法同名的事件可供监听，当然目前还没用上，统一事件够用了。</p>
<h1 id="navigatorTracker类"><a href="#navigatorTracker类" class="headerlink" title="navigatorTracker类"></a>navigatorTracker类</h1><p><code>navigatorTracker</code> 类非常简单，就是通过 <code>navigator</code> 对象获取用户的一些信息。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\navigator.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TrackerCls</span> <span class="keyword">from</span> <span class="string">&quot;./trackerCls&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getNavigatorInfo &#125; <span class="keyword">from</span> <span class="string">&quot;../../utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">NavigatorTracker</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TrackerCls</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options, reportTracker);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">navigatorTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">navigatorReport</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">additionalDestroy</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="comment">// 用户信息上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">navigatorReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">      <span class="attr">targetKey</span>: <span class="string">&#x27;navigator&#x27;</span>,</span><br><span class="line">      <span class="attr">event</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">info</span>: <span class="title function_">getNavigatorInfo</span>(),</span><br><span class="line">    &#125;, <span class="string">&#x27;navigator&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类的业务核心是通过 <code>getNavigatorInfo</code> 工具方法获取信息。因为 <code>navigator</code> 对象的属性比较多，需要加工后上报。</p>
<figure class="highlight ts"><figcaption><span>src\utils\navigator.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取navigator信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getNavigatorInfo</span>(<span class="params"></span>): <span class="built_in">object</span> &#123;</span><br><span class="line">  <span class="comment">// 获取navigator</span></span><br><span class="line">  <span class="keyword">const</span> navigator = <span class="variable language_">window</span>.<span class="property">navigator</span>;</span><br><span class="line">  <span class="comment">// 获取ua</span></span><br><span class="line">  <span class="keyword">const</span> ua = navigator.<span class="property">userAgent</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">userAgent</span>: ua,</span><br><span class="line">    <span class="attr">cookieEnabled</span>: navigator.<span class="property">cookieEnabled</span>,</span><br><span class="line">    <span class="attr">language</span>: navigator.<span class="property">language</span>,</span><br><span class="line">    <span class="attr">browser</span>: <span class="title function_">getBrowser</span>(ua),</span><br><span class="line">    <span class="attr">os</span>: <span class="title function_">getOS</span>(ua),</span><br><span class="line">    <span class="attr">isMobile</span>: <span class="title function_">isMobile</span>(ua),</span><br><span class="line">    <span class="attr">screen</span>: &#123;</span><br><span class="line">      <span class="comment">// 获取屏幕宽高</span></span><br><span class="line">      <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">width</span>,</span><br><span class="line">      <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">height</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取浏览器信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBrowser</span>(<span class="params">ua: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  ua = ua.<span class="title function_">toLowerCase</span>();</span><br><span class="line">  <span class="keyword">const</span> browserRegex = &#123;</span><br><span class="line">    <span class="title class_">Edge</span>: <span class="regexp">/edge\/([\d.]+)/i</span>,</span><br><span class="line">    <span class="attr">IE</span>: <span class="regexp">/(rv:|msie\s+)([\d.]+)/i</span>,</span><br><span class="line">    <span class="title class_">Firefox</span>: <span class="regexp">/firefox\/([\d.]+)/i</span>,</span><br><span class="line">    <span class="title class_">Chrome</span>: <span class="regexp">/chrome\/([\d.]+)/i</span>,</span><br><span class="line">    <span class="title class_">Opera</span>: <span class="regexp">/opera\/([\d.]+)/i</span>,</span><br><span class="line">    <span class="title class_">Safari</span>: <span class="regexp">/version\/([\d.]+).*safari/i</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> browser <span class="keyword">in</span> browserRegex) &#123;</span><br><span class="line">    <span class="keyword">const</span> match = ua.<span class="title function_">match</span>(browserRegex[browser <span class="keyword">as</span> keyof <span class="keyword">typeof</span> browserRegex]);</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">name</span>: browser, <span class="attr">version</span>: match[<span class="number">1</span>] &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">version</span>: <span class="string">&quot;0&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取操作系统信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOS</span>(<span class="params">ua: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  ua = ua.<span class="title function_">toLowerCase</span>();</span><br><span class="line">  <span class="keyword">const</span> osRegex = [</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;windows&quot;</span>, <span class="attr">regex</span>: <span class="regexp">/compatible|windows/i</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;macOS&quot;</span>, <span class="attr">regex</span>: <span class="regexp">/macintosh|macintel/i</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;iOS&quot;</span>, <span class="attr">regex</span>: <span class="regexp">/iphone|ipad/i</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;android&quot;</span>, <span class="attr">regex</span>: <span class="regexp">/android/i</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&quot;linux&quot;</span>, <span class="attr">regex</span>: <span class="regexp">/linux/i</span> &#125;</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> os <span class="keyword">of</span> osRegex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ua.<span class="title function_">match</span>(os.<span class="property">regex</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> os.<span class="property">name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;other&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否为移动端</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isMobile</span>(<span class="params">ua: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> !!ua.<span class="title function_">match</span>(</span><br><span class="line">    <span class="regexp">/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于浏览器、系统、移动端的判断，是通过正则匹配 <code>userAgent</code> 字符串。其实可以只把 UA 传给后端，后端再解析。但前端先处理下获取关键信息，也挺好。</p>
<h1 id="DomTracker类"><a href="#DomTracker类" class="headerlink" title="DomTracker类"></a>DomTracker类</h1><p><code>DomTracker</code> 类通过元素上的埋点，监控用户的指定行为，并上报数据。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\dom.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TrackerCls</span> <span class="keyword">from</span> <span class="string">&quot;./trackerCls&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">DomTracker</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TrackerCls</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options, reportTracker);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">domTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">domEventReport</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">additionalDestroy</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="comment">// 监听dom事件，并上报相关数据</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">domEventReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">domEventsList</span>?.<span class="title function_">forEach</span>(<span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> target = e.<span class="property">target</span> <span class="keyword">as</span> <span class="title class_">HTMLElement</span>;</span><br><span class="line">        <span class="comment">// 设置target-events属性，元素层次限制上报的事件</span></span><br><span class="line">        <span class="keyword">const</span> targetEvents = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(target.<span class="title function_">getAttribute</span>(<span class="string">&#x27;target-events&#x27;</span>));</span><br><span class="line">        <span class="keyword">if</span> (targetEvents &amp;&amp; !targetEvents.<span class="title function_">includes</span>(e.<span class="property">type</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取目标key，设置key分辨不同元素</span></span><br><span class="line">        <span class="comment">// &lt;button target-key=&quot;btn&quot; target-events=&quot;[&#x27;click&#x27;]&quot;&gt;dom事件上报测试&lt;/button&gt;</span></span><br><span class="line">        <span class="keyword">const</span> targetKey = target.<span class="title function_">getAttribute</span>(<span class="string">&#x27;target-key&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (targetKey) &#123;</span><br><span class="line">          <span class="comment">// console.log(e);</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">            event,</span><br><span class="line">            targetKey,</span><br><span class="line">            <span class="comment">// 元素的基本信息，便于定位</span></span><br><span class="line">            <span class="attr">elementInfo</span>: &#123;</span><br><span class="line">              <span class="attr">name</span>: target.<span class="property">localName</span> ?? target.<span class="property">nodeName</span>,</span><br><span class="line">              <span class="attr">id</span>: target.<span class="property">id</span> || <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">class</span>: target.<span class="property">className</span> || <span class="literal">null</span>,</span><br><span class="line">              <span class="comment">// innerText: target.innerText,</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, <span class="string">&#x27;dom&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(event, eventHandler)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心是 <code>domEventReport()</code> 方法，遍历了配置项中的 <code>domEventsList</code>，并监听对应的事件。</p>
<p>再看看 <code>addEventListener</code> 方法，它是 <code>TrackerCls</code> 类提供的方法，封装了 <code>window.addEventListener</code>。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\trackerCls.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 封装addEventListener</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">addEventListener</span>(<span class="params"></span></span><br><span class="line"><span class="params">  name: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  handler: EventListenerOrEventListenerObject,</span></span><br><span class="line"><span class="params">  options: <span class="built_in">boolean</span> | AddEventListenerOptions = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果没有该事件的监听数组，就初始化一个空的</span></span><br><span class="line">  !<span class="variable language_">this</span>.<span class="property">eventListeners</span>.<span class="title function_">hasOwnProperty</span>(name) &amp;&amp;</span><br><span class="line">    (<span class="variable language_">this</span>.<span class="property">eventListeners</span>[name] = []);</span><br><span class="line">  <span class="comment">// 将事件监听器存入数组</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">eventListeners</span>[name].<span class="title function_">push</span>(handler);</span><br><span class="line">  <span class="comment">// 添加事件监听</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(name, handler, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有事件都绑定在 <code>window</code> 上，利用冒泡机制，可以监听到所有元素上的大部分事件。</p>
<ol>
<li>先判断元素是否有 <code>target-events</code> 属性，如果有，则判断当前触发的事件是否在 <code>target-events</code> 中，不在则直接返回。</li>
<li>再判断元素是否有 <code>target-key</code> 属性，如果有，就上报监控数据。</li>
</ol>
<p>也就是有两个埋点<strong>属性</strong>：</p>
<ol>
<li><code>target-key</code> <strong>必须</strong>，用于标识元素，也是启用埋点的标志。</li>
<li><code>target-events</code> <strong>非必须</strong>，用于在元素上限制可监控的事件，颗粒度更小，应该是配置项的 <code>domEventsList</code> 的子集，在 <code>domEventsList</code> 之外的事件不会被监控。若没有该属性，则会监控该元素上所有 <code>domEventsList</code> 罗列的事件。</li>
</ol>
<p>这种策略类似一些日志库，除了在初始化日志类时可以指定要输出的最低日志等级，还可以通过装饰器或者其他方式，控制某个区域输出的最低日志等级。</p>
<figure class="highlight html"><figcaption><span>埋点的例子</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">target-key</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">target-events</span>=<span class="string">&quot;[&#x27;click&#x27;]&quot;</span>&gt;</span>dom事件上报测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="ErrorTracker类"><a href="#ErrorTracker类" class="headerlink" title="ErrorTracker类"></a>ErrorTracker类</h1><p><code>ErrorTracker</code> 类用于监控错误信息，包括JS错误、资源加载错误、Promise错误。</p>
<p><strong>注意：</strong>Promise错误并不是一个真正的错误，而是指未处理的rejected状态的Promise，它会触发 <code>unhandledrejection</code> 事件。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\error.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TrackerCls</span> <span class="keyword">from</span> <span class="string">&quot;./trackerCls&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ErrorTracker</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TrackerCls</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options, reportTracker);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">errorTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">errorReport</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">additionalDestroy</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">  <span class="comment">// 启用错误上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">errorReport</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">errorEvent</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">promiseReject</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 监听error事件，并上报相关数据</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">errorEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">    <span class="comment">// 回调</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> [info, targetKey] = <span class="variable language_">this</span>.<span class="title function_">analyzeError</span>(e)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">        <span class="attr">targetKey</span>: targetKey,</span><br><span class="line">        <span class="attr">event</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">        <span class="attr">info</span>: info</span><br><span class="line">      &#125;, <span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 错误事件不会冒泡，需在捕获阶段监听</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(eventName, eventHandler, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析错误信息,区分js错误和资源加载错误,返回错误信息和错误分类</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">analyzeError</span>(<span class="attr">event</span>: <span class="title class_">Event</span>): [<span class="built_in">object</span> | <span class="built_in">string</span>, <span class="built_in">string</span>] &#123;</span><br><span class="line">    <span class="keyword">const</span> target = event.<span class="property">target</span> || event.<span class="property">srcElement</span>;</span><br><span class="line">    <span class="comment">// 如果是dom元素,说明是资源加载错误</span></span><br><span class="line">    <span class="keyword">if</span> (target <span class="keyword">instanceof</span> <span class="title class_">HTMLElement</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [&#123;</span><br><span class="line">        <span class="attr">name</span>: target.<span class="property">tagName</span> || target.<span class="property">localName</span> || target.<span class="property">nodeName</span>,</span><br><span class="line">        <span class="attr">class</span>: target.<span class="property">className</span> || <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">id</span>: target.<span class="property">id</span> || <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">url</span>: (target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">src</span> || (target <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">href</span> || <span class="literal">null</span>,</span><br><span class="line">      &#125;, <span class="string">&quot;resourceError&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果event是ErrorEvent类型,说明是js错误</span></span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> <span class="title class_">ErrorEvent</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [event.<span class="property">message</span>, <span class="string">&quot;jsError&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 兜底返回</span></span><br><span class="line">    <span class="keyword">return</span> [event, <span class="string">&quot;otherError&quot;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 监控未捕获的Promise Reject，可以认为是Promise错误</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">promiseReject</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = <span class="string">&#x27;unhandledrejection&#x27;</span>;</span><br><span class="line">    <span class="comment">// 回调</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      (event <span class="keyword">as</span> <span class="title class_">PromiseRejectionEvent</span>).<span class="property">promise</span>.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(&#123;</span><br><span class="line">          <span class="attr">targetKey</span>: <span class="string">&quot;reject&quot;</span>,</span><br><span class="line">          <span class="attr">event</span>: <span class="string">&quot;promise&quot;</span>,</span><br><span class="line">          <span class="attr">info</span>: error</span><br><span class="line">        &#125;, <span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(eventName, eventHandler)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>区分js和资源加载错误:</strong></p>
<ol>
<li>js和资源加载错误都会触发 <code>error</code> 事件，但是 <code>event</code> 对象的类型不同。js错误是 <code>ErrorEvent</code> 类型，资源加载错误是 <code>Event</code> 类型。</li>
<li>脚本运行错误事件是由 <code>window</code> 触发的，而资源加载错误事件是由DOM元素触发的，所以可以通过 <code>event.target</code> 判断。</li>
</ol>
<p><strong>注意：</strong>error事件是不会冒泡的，所以只能在捕获阶段监听。</p>
<h2 id="error事件"><a href="#error事件" class="headerlink" title="error事件"></a>error事件</h2><p>除了判断类型，还可以分别监听 <code>error</code> 事件来区分js和资源加载错误。</p>
<p><strong>小知识：</strong></p>
<ol>
<li>DOM2级事件规定事件流包括三个阶段，事件捕获阶段、处于目标阶段和事件冒泡阶段。</li>
<li>触发事件的目标对象，不管事件是否支持冒泡，始终可以监听到该事件的触发。</li>
</ol>
<p><strong>捕获阶段：</strong><br>window =&gt; document =&gt; 父级元素 =&gt; 目标元素。</p>
<p>js 错误是由 <code>window</code> 触发的，始终可以监听到，无需在捕获阶段监听。</p>
<p>而资源加载错误是由DOM元素触发的，想要事件委托，那就只能在捕获阶段监听。所以可以在 <code>document</code> 上监听 <code>error</code> 事件，捕获资源加载错误。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听脚本运行错误</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, runtimeErrorHandler, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 监听资源加载错误</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, resourceErrorHandler, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p><strong>发生了什么：</strong></p>
<ol>
<li>js错误在<code>window</code>上触发，目标元素就是<code>window</code>，所以可以在<code>window</code>上通过冒泡阶段监听js错误。</li>
<li>资源加载错误的目标元素是dom元素，在 <code>document</code> 上通过捕获阶段监听，就可以委托监听资源加载错误。error事件不会冒泡，所以 <code>window</code> 上监听不到该错误。</li>
</ol>
<h1 id="PerformanceTracker"><a href="#PerformanceTracker" class="headerlink" title="PerformanceTracker"></a>PerformanceTracker</h1><p><code>PerformanceTracker</code> 类用于监控性能，包括dom性能、资源加载性能。</p>
<figure class="highlight ts"><figcaption><span>src\core\tracker\performance.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Options</span>, <span class="title class_">Resource</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TrackerCls</span> <span class="keyword">from</span> <span class="string">&quot;./trackerCls&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  getDomPerformance,</span><br><span class="line">  getResourcePerformance,</span><br><span class="line">  listenResourceLoad,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;../../utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">PerformanceTracker</span> <span class="keyword">extends</span> <span class="title class_ inherited__">TrackerCls</span> &#123;</span><br><span class="line">  <span class="comment">// 保存PerformanceObserver性能监控观察者实例。</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">performanceObserver</span>: <span class="title class_">PerformanceObserver</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: Options, reportTracker: <span class="built_in">Function</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(options, reportTracker);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">performanceTracker</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">performanceReport</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开启性能监控上报</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">performanceReport</span>(<span class="params">accuracy: <span class="built_in">number</span> = <span class="number">2</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = <span class="string">&quot;load&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">performance</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 页面加载完后上报dom性能数据</span></span><br><span class="line">      <span class="keyword">const</span> domPerformance = <span class="title function_">getDomPerformance</span>(accuracy);</span><br><span class="line">      <span class="comment">// 页面加载完后上报已加载完毕的资源性能数据</span></span><br><span class="line">      <span class="keyword">const</span> resourcePerformance = <span class="title function_">getResourcePerformance</span>(accuracy);</span><br><span class="line">      <span class="comment">// 上报的数据</span></span><br><span class="line">      <span class="keyword">const</span> data = &#123;</span><br><span class="line">        <span class="attr">targetKey</span>: <span class="string">&quot;performance&quot;</span>,</span><br><span class="line">        <span class="attr">event</span>: <span class="string">&quot;load&quot;</span>,</span><br><span class="line">        domPerformance,</span><br><span class="line">        resourcePerformance,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// 上报数据，类型key为performance</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, <span class="string">&quot;performance&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// load完后开启资源的持续监控，例如后续请求以及图片的懒加载</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">performanceObserver</span> = <span class="title function_">listenResourceLoad</span>(</span><br><span class="line">        <span class="function">(<span class="params">entry: PerformanceResourceTiming</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">resource</span>: <span class="title class_">Resource</span> = &#123;</span><br><span class="line">            <span class="attr">name</span>: entry.<span class="property">name</span>, <span class="comment">// 资源名称，通常为url</span></span><br><span class="line">            <span class="attr">duration</span>: entry.<span class="property">duration</span>.<span class="title function_">toFixed</span>(accuracy), <span class="comment">// 资源加载耗时</span></span><br><span class="line">            <span class="attr">type</span>: entry.<span class="property">entryType</span>, <span class="comment">// 资源类型</span></span><br><span class="line">            <span class="attr">initiatorType</span>: entry.<span class="property">initiatorType</span>, <span class="comment">// 发起资源请求的类型（标签名、请求方式等）</span></span><br><span class="line">            <span class="attr">size</span>: entry.<span class="property">decodedBodySize</span> || entry.<span class="property">transferSize</span>, <span class="comment">// 资源大小</span></span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="keyword">const</span> data = &#123;</span><br><span class="line">            <span class="attr">targetKey</span>: <span class="string">&quot;resourceLoad&quot;</span>,</span><br><span class="line">            <span class="attr">event</span>: <span class="string">&quot;load&quot;</span>,</span><br><span class="line">            resource,</span><br><span class="line">          &#125;;</span><br><span class="line">          <span class="comment">// 上报数据，类型key为performance</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">reportTracker</span>(data, <span class="string">&quot;performance&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">eventHandler</span>: <span class="title class_">EventListenerOrEventListenerObject</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 将性能监控函数放到微/宏任务队列中执行，这样就能保证在load事件完成之后执行</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(performance, <span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(performance, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 监听load事件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(eventName, eventHandler);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 销毁时额外需要销毁的内容</span></span><br><span class="line">  <span class="title function_">additionalDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 断开资源监控</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">performanceObserver</span>?.<span class="title function_">disconnect</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于window对象的load事件来说，当整个HTML页面的所有依赖资源（JS文件、CSS文件、图片等）加载完成时将会触发。</p>
<p>核心方法 <code>performanceReport</code> 监听 <code>load</code> 事件，在页面加载完后，通过 <code>getDomPerformance</code> 获取dom性能，通过 <code>getResourcePerformance</code> 获取已加载完毕的资源性能数据，并上报。然后通过性能监控器 <code>PerformanceObserver</code> 监控后续资源的加载。</p>
<p>所以性能监控可以分为两部分：</p>
<ol>
<li>页面加载完后的性能上报。</li>
<li>后续资源的持续监控。</li>
</ol>
<h2 id="performance-API"><a href="#performance-API" class="headerlink" title="performance API"></a>performance API</h2><p><code>performance</code> API 提供了非常多的属性和方法，用于获取页面性能数据。这个 API 的内容非常多，这里也只能讲用到的。</p>
<p>兼容的获取方式，但现在大多已经不需要这么做了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">performance</span> || <span class="variable language_">window</span>.<span class="property">mozPerformance</span> || <span class="variable language_">window</span>.<span class="property">msPerformance</span> || <span class="variable language_">window</span>.<span class="property">webkitPerformance</span> || &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><code>performance.getEntries()</code> 用于获页面中的<strong>所有</strong>的性能数据，返回一个包含各种性能对象的数组。</p>
<ol>
<li><code>PerformanceNavigationTiming</code> 包含有关页面导航和重定向的时间信息，如 unload、redirect、domInteractive 等。</li>
<li><code>PerformanceResourceTiming</code> 提供了有关页面加载过程中每个资源的时间信息，如加载开始时间、结束时间、传输协议等。</li>
<li><code>PerformancePaintTiming</code> 提供有关页面绘制过程中的重要时间点的信息，例如首次绘制（first-paint）和首次内容绘制（first-contentful-paint）。</li>
</ol>
<p>我们通常不会想一次性获取这么一大堆东西，所以需要使用 <code>performance.getEntriesByType(type)</code> 传入 <code>entryType</code> 获取指定的性能对象。返回的都是数组。</p>
<ol>
<li><code>navigation</code> 返回包含<strong>一个</strong>元素的数组，元素类型为 <code>PerformanceNavigationTiming</code></li>
<li><code>paint</code> 返回包含<strong>两个</strong>元素的数组，元素类型都是 <code>PerformanceResourceTiming</code>，其中 <code>[0]</code> 为首次绘制（first-paint），<code>[1]</code> 为首次内容绘制（first-contentful-paint）。</li>
<li><code>resource</code> 返回当前<strong>已加载完</strong>的资源的性能信息数组，元素类型为 <code>PerformanceResourceTiming</code>，每个元素都代表一个资源。</li>
</ol>
<p><strong>参考：</strong><br><a target="_blank" rel="noopener" href="https://heapdump.cn/article/5401439">前端性能精进之优化方法论（一）——测量</a><br><a target="_blank" rel="noopener" href="https://fecommunity.github.io/front-end-interview/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/8.performance%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7.html">前端性能监控指标</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7078875439950725128">前端性能指标浅析</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/584767348">前端性能指标</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904112450994189">性能监控指标分析</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6973567030528065573">使用 Performance API 获取页面性能</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904182202253325">Navigation Timing API 入门</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7268663683881025597">PerformanceObserver前端性能测量方法</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7140171382742548511">首屏事件计算方式</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7163046672874864676">你只会用前端数据埋点 SDK 吗？</a></p>
<h3 id="导航计时"><a href="#导航计时" class="headerlink" title="导航计时"></a>导航计时</h3><p>导航计时（Navigation Timing） API 是 Web 性能 API 的起点。</p>
<p><strong>功能：</strong>用于记录并检测用户的设备，网络等环境，以及页面初始资源加载和解析耗时。</p>
<p>在以前通过 <code>performance.navigation</code> 和 <code>performance.timing</code> 获取，但现在通常使用 <code>performance.getEntriesByType(&#39;navigation&#39;)</code> 获取。</p>
<p><code>PerformanceNavigationTiming</code> 有着更全面的导航信息，且精度更高，包括重定向、卸载、重定向、DNS查询、TCP连接、SSL握手、请求、响应等时间。</p>
<figure class="highlight txt"><figcaption><span>PerformanceNavigationTiming 属性</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">(1) navigationStart</span><br><span class="line">navigationStart 表示同一个浏览器上下文中，上一个文档卸载结束的 UNIX 时间戳。如果没有上一个文档，这个值与 fetchStart 相同。</span><br><span class="line"></span><br><span class="line">(2) unloadEventStart</span><br><span class="line">unloadEventStart 表示 unload 事件抛出时的 UNIX 时间戳。如果没有上一个文档，或者重定向中的一个与当前文档不同源，该值为 0。</span><br><span class="line"></span><br><span class="line">(3) unloadEventEnd</span><br><span class="line">unloadEventEnd 表示 unload 事件处理完成时的 UNIX 时间戳。如果没有上一个文档，或者重定向中的一个与当前文档不同源，该值为 0。</span><br><span class="line"></span><br><span class="line">(4) redirectStart</span><br><span class="line">redirectStart 表示第一个 HTTP 重定向开始时的 UNIX 时间戳。如果没有重定向，或者重定向中的一个不同源，该值为 0。</span><br><span class="line"></span><br><span class="line">(5) redirectEnd</span><br><span class="line">redirectEnd 表示最后一个 HTTP 重定向完成时（即最后一个 HTTP 响应的最后一个比特被接收到的时间）的 UNIT 时间戳。如果额米有重定向，或者重定向中的一个不同源，该值为 0。</span><br><span class="line"></span><br><span class="line">(6) fetchStart</span><br><span class="line">fetchStart 表示浏览器准备好用 HTTP 请求来获取文档的 UNIX 时间戳。这个时间早于检查应用缓存。</span><br><span class="line"></span><br><span class="line">(7) domainLookupStart</span><br><span class="line">domainLookupStart 表示域名查询开始的 UNIX 时间戳。如果使用了持续连接，或者这个信息被存储到了缓存或本地资源，那么该值与 fetchStart 相同。</span><br><span class="line"></span><br><span class="line">(8) domainLookupEnd</span><br><span class="line">domainLookupEnd 表示域名查询结束的 UNIX 时间戳。如果使用了持续连接，或者这个信息被存储到了缓存或本地资源，那么该值与 fetchStart 相同。</span><br><span class="line"></span><br><span class="line">(9) connectStart</span><br><span class="line">connectStart 表示 HTTP 请求开始向服务器发送时的 UNIX 时间戳。如果使用持久连接，则该值与 fetchStart 相同。</span><br><span class="line"></span><br><span class="line">(10) connectEnd</span><br><span class="line">connectEnd 表示浏览器与服务器之间的连接建立（即握手与认证等过程全部结束）的 UNIX 时间戳。如果使用持久连接，则该值与 fetchStart 相同。</span><br><span class="line"></span><br><span class="line">(11) secureConnectionStart</span><br><span class="line">secureConnectionStart 表示浏览器与服务器开始安全链接的握手时的 UNIX 时间戳。如果当前网页不要求安全链接，该值为 0。</span><br><span class="line"></span><br><span class="line">(12) requestStart</span><br><span class="line">requestStart 表示浏览器向服务器发送 HTTP 请求时的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(13) responseStart</span><br><span class="line">responseStart 表示浏览器从服务器收到（或从本地缓存读取）第一个字节时的 UNIX 时间戳。如果传输层从开始请求后失败并连接被重开，该值会被重置为新的请求的相应的时间。</span><br><span class="line"></span><br><span class="line">(14) responseEnd</span><br><span class="line">responseEnd 表示浏览器从服务器收到（或从本地缓存读取，或从本地资源读取）最后一个字节时（如果在此之前HTTP连接已经关闭，则返回关闭的时间）的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(15) domLoading</span><br><span class="line">Performance.domLoading 表示当前网页 DOM 结构开始解析时（即 Document.readyState 属性变为 loading，相应的 readystatechange 事件触发时）的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(16) domInteractive</span><br><span class="line">Performance.domInteractive 表示当前网页 DOM 结构解析结束，开始加载内嵌资源时（即 Document.readyState 的属性为 interactive，相应的 readystatechange 事件触发时）的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(17) domContentLoadedEventStart</span><br><span class="line">domContentLoadedEventStart 表示解析器触发 DomContentLoaded 事件，即所有需要被执行的脚本已经被解析时的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(18) domContentLoadedEventEnd</span><br><span class="line">domContentLoadedEventEnd 表示所有需要被执行的脚本均已被执行完成时的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(19) domComplete</span><br><span class="line">domComplete 表示文档解析完成，即 Document.readyState 变为 complete 且相应的 readystatechange 事件被触发时的 UNIX 时间戳。</span><br><span class="line"></span><br><span class="line">(20) loadEventStart</span><br><span class="line">loadEventStart 表示该文档下，load 事件被触发的 UNIX 时间戳。如果还未发送，值为 0。</span><br><span class="line"></span><br><span class="line">(21) loadEventEnd</span><br><span class="line">loadEventEnd 表示该文档下，load 事件结束，即加载事件完成时的 UNIX 时间戳，如果事件未触发或未完成，值为 0。</span><br></pre></td></tr></table></figure>
<h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><p>常见的前端性能指标：</p>
<ol>
<li><strong>FP</strong>(First paint) <strong>首屏绘制</strong>，常被用来衡量白屏时间。</li>
<li><strong>FCP</strong>(First Contentful Paint) <strong>首屏内容绘制</strong>，页面从开始加载到页面内容的任何部分在屏幕上完成渲染的时间。</li>
<li><strong>LCP</strong>(Largest Contentful Paint) <strong>最大内容绘制</strong>，页面首次开始加载的时间点来报告可视区域内可见的最大图像或者文本块完成渲染的相对时间。</li>
<li><strong>FID</strong>(First Input Delay) <strong>首次输入延迟时间</strong>，从用户第一次与页面交互，到浏览器对交互作出响应，并实际能够开始处理事件所经过的时间。</li>
<li><strong>TTI</strong>(Time to Interactive) <strong>首次可交互时间</strong>，页面从开始加载到主要子资源完成渲染，并能够快速、可靠地响应用户输入所需的时间。</li>
<li><strong>CLS</strong>(Cumulative Layout Shift) <strong>累计位移偏移</strong>，计算页面的视觉稳定性，即页面整个生命周期中所有发生的预料之外的布局偏移的得分的总和。每当一个可视元素位置发生改变，就是发生了布局偏移。</li>
<li><strong>TTFB</strong>(Time to First Byte) <strong>首字节时间</strong>，从发起请求到服务器响应后收到的第一个字节的时间差，用于衡量服务器处理能力和网络的延迟。</li>
</ol>
<h2 id="getDomPerformance"><a href="#getDomPerformance" class="headerlink" title="getDomPerformance"></a>getDomPerformance</h2><p><code>getDomPerformance</code> 方法用于获取页面加载完后的dom性能数据。</p>
<p>通过 <code>PerformanceNavigationTiming</code> 和 <code>PerformancePaintTiming</code> 的属性，计算各种性能指标。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取dom加载性能指标</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getDomPerformance</span>(<span class="params">accuracy: <span class="built_in">number</span> = <span class="number">2</span></span>): <span class="built_in">object</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="comment">// 获取导航计时</span></span><br><span class="line">  <span class="keyword">const</span> navigationTiming = performance.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;navigation&#x27;</span>)[<span class="number">0</span>] <span class="keyword">as</span> <span class="title class_">PerformanceNavigationTiming</span> || performance.<span class="property">timing</span>;</span><br><span class="line">  <span class="comment">// 获取首次渲染计时</span></span><br><span class="line">  <span class="keyword">const</span> firstPaintTiming = performance.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;paint&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// 获取首次内容渲染计时</span></span><br><span class="line">  <span class="keyword">const</span> firstContentfulPaintTiming = performance.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;paint&#x27;</span>)[<span class="number">1</span>];</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(firstContentfulPaintTiming, firstPaintTiming)</span><br><span class="line">  <span class="keyword">if</span> (!navigationTiming) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 浏览器与服务器开始SSL安全链接的握手时间</span></span><br><span class="line">  <span class="keyword">const</span> sslTime = navigationTiming.<span class="property">secureConnectionStart</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 页面加载开始时间</span></span><br><span class="line">    <span class="attr">startTime</span>: navigationTiming.<span class="property">startTime</span>.<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 页面加载总耗时</span></span><br><span class="line">    <span class="attr">duration</span>: (navigationTiming.<span class="property">duration</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// DNS查询耗时</span></span><br><span class="line">    <span class="attr">DNS</span>: (navigationTiming.<span class="property">domainLookupEnd</span> - navigationTiming.<span class="property">domainLookupStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// TCP连接耗时</span></span><br><span class="line">    <span class="attr">TCP</span>: (navigationTiming.<span class="property">connectEnd</span> - navigationTiming.<span class="property">connectStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// SSL连接耗时</span></span><br><span class="line">    <span class="attr">SSL</span>: (sslTime &gt; <span class="number">0</span> ? navigationTiming.<span class="property">connectEnd</span> - sslTime : <span class="number">0</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 首字节时间，即服务器响应时间</span></span><br><span class="line">    <span class="attr">TTFB</span>: (navigationTiming.<span class="property">responseStart</span> - navigationTiming.<span class="property">requestStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 白屏时间，首屏绘制</span></span><br><span class="line">    <span class="attr">FP</span>: (firstPaintTiming ? firstPaintTiming.<span class="property">startTime</span> - navigationTiming.<span class="property">fetchStart</span> : navigationTiming.<span class="property">responseEnd</span> - navigationTiming.<span class="property">fetchStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 首次内容渲染时间</span></span><br><span class="line">    <span class="attr">FCP</span>: (firstContentfulPaintTiming ? firstContentfulPaintTiming.<span class="property">startTime</span> - navigationTiming.<span class="property">fetchStart</span> : <span class="number">0</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 首次可交互时间</span></span><br><span class="line">    <span class="attr">TTI</span>: (navigationTiming.<span class="property">domInteractive</span> - navigationTiming.<span class="property">startTime</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 页面重定向耗时</span></span><br><span class="line">    <span class="attr">redirect</span>: (navigationTiming.<span class="property">redirectEnd</span> - navigationTiming.<span class="property">redirectStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 重定向次数</span></span><br><span class="line">    <span class="attr">redirectCount</span>: navigationTiming.<span class="property">redirectCount</span>,</span><br><span class="line">    <span class="comment">// 前一个页面卸载耗时</span></span><br><span class="line">    <span class="attr">unload</span>: (navigationTiming.<span class="property">unloadEventEnd</span> - navigationTiming.<span class="property">unloadEventStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// HTML 加载完成时间</span></span><br><span class="line">    <span class="attr">ready</span>: (navigationTiming.<span class="property">domContentLoadedEventEnd</span> - navigationTiming.<span class="property">startTime</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 页面加载总耗时，此时触发完成了onload事件</span></span><br><span class="line">    <span class="attr">load</span>: (navigationTiming.<span class="property">loadEventEnd</span> - navigationTiming.<span class="property">startTime</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// DOM解析耗时，页面请求完成后，到整个DOM解析完所用的时间</span></span><br><span class="line">    <span class="attr">dom</span>: (navigationTiming.<span class="property">domContentLoadedEventEnd</span> - navigationTiming.<span class="property">responseEnd</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// html文档完全解析完毕的时间节点</span></span><br><span class="line">    <span class="attr">domComplete</span>: navigationTiming.<span class="property">domComplete</span>.<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// 资源加载耗时</span></span><br><span class="line">    <span class="attr">resource</span>: (navigationTiming.<span class="property">domComplete</span> - navigationTiming.<span class="property">domInteractive</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// HTML加载完时间，指页面所有 HTML 加载完成（不包括页面渲染时间）</span></span><br><span class="line">    <span class="attr">htmlLoad</span>: (navigationTiming.<span class="property">responseEnd</span> - navigationTiming.<span class="property">startTime</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// DOMContentLoaded 事件耗时</span></span><br><span class="line">    <span class="attr">DCL</span>: (navigationTiming.<span class="property">domContentLoadedEventEnd</span> - navigationTiming.<span class="property">domContentLoadedEventStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">    <span class="comment">// onload事件耗时</span></span><br><span class="line">    <span class="attr">onload</span>: (navigationTiming.<span class="property">loadEventEnd</span> - navigationTiming.<span class="property">loadEventStart</span>).<span class="title function_">toFixed</span>(accuracy),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getResourcePerformance"><a href="#getResourcePerformance" class="headerlink" title="getResourcePerformance"></a>getResourcePerformance</h2><p><code>getResourcePerformance</code> 用于获取首屏已经加载完毕的资源的性能信息。</p>
<p>通过 <code>PerformanceResourceTiming</code> 数组，遍历每个资源的性能信息，分类并计算各种性能指标。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取首屏已经加载完毕的资源的性能信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getResourcePerformance</span>(<span class="params">accuracy: <span class="built_in">number</span> = <span class="number">2</span></span>): <span class="title class_">InitiatorTypeLiteral</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">performance</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 获取 PerformanceResourceTiming 数组</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="variable language_">window</span>.<span class="property">performance</span>.<span class="title function_">getEntriesByType</span>(<span class="string">&#x27;resource&#x27;</span>) <span class="keyword">as</span> <span class="title class_">PerformanceResourceTiming</span>[];</span><br><span class="line">  <span class="comment">// 保存资源分类</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">resources</span>: <span class="title class_">InitiatorTypeLiteral</span> = &#123;&#125;</span><br><span class="line">  data.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> key = i.<span class="property">initiatorType</span> || <span class="string">&#x27;other&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&#x27;beacon&#x27;</span>) <span class="keyword">return</span>; <span class="comment">// 跳过beacon上报请求</span></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&#x27;other&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> extension = <span class="title function_">urlHandle</span>(i.<span class="property">name</span>, <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">switch</span> (extension) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;css&#x27;</span>: key = <span class="string">&#x27;css&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;js&#x27;</span>: key = <span class="string">&#x27;js&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;json&#x27;</span>: key = <span class="string">&#x27;json&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;png&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;jpg&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;jpeg&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;gif&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;svg&#x27;</span>: key = <span class="string">&#x27;img&#x27;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>: <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    !resources.<span class="title function_">hasOwnProperty</span>(key) &amp;&amp; (resources[key] = [])</span><br><span class="line">    resources[key].<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: i.<span class="property">name</span>, <span class="comment">// 资源的名称</span></span><br><span class="line">      <span class="attr">duration</span>: i.<span class="property">duration</span>.<span class="title function_">toFixed</span>(accuracy), <span class="comment">// 资源加载耗时</span></span><br><span class="line">      <span class="attr">type</span>: i.<span class="property">entryType</span>, <span class="comment">// 资源类型</span></span><br><span class="line">      <span class="attr">initiatorType</span>: i.<span class="property">initiatorType</span>, <span class="comment">// 发起资源请求的类型（标签名）</span></span><br><span class="line">      <span class="attr">size</span>: i.<span class="property">decodedBodySize</span> || i.<span class="property">transferSize</span>, <span class="comment">// 资源大小</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> resources;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取url中需要的数据  type  1: 获取文件名  2：获取后缀  3：获取文件名+后缀  4:获取文件前缀</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">urlHandle</span>(<span class="params">url: <span class="built_in">string</span>, <span class="keyword">type</span>: <span class="built_in">number</span></span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> filename = url.<span class="title function_">substring</span>(url.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> filename; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> filename.<span class="title function_">substring</span>(filename.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> filename.<span class="title function_">substring</span>(<span class="number">0</span>, filename.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> url.<span class="title function_">substring</span>(<span class="number">0</span>, url.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="attr">default</span>: <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>若涉及跨域，并且其响应头没有声明 <code>timing-allow-origin</code>，那么 <code>PerformanceResourceTiming</code> 中的大部分属性可能都是 0。<br>可以将 timing-allow-origin 设为星号，或指定域名。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Timing-Allow-Origin<span class="punctuation">:</span> *</span><br></pre></td></tr></table></figure>
<h2 id="listenResourceLoad"><a href="#listenResourceLoad" class="headerlink" title="listenResourceLoad"></a>listenResourceLoad</h2><p><code>listenResourceLoad</code> 方法用于监听<strong>后续资源</strong>的加载情况。</p>
<p>通过 <code>PerformanceObserver</code> 监控资源加载，当资源加载完毕后，上报资源性能数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听资源加载</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenResourceLoad</span>(<span class="params">callback: (arg0: PerformanceResourceTiming) =&gt; <span class="built_in">void</span></span>): <span class="title class_">PerformanceObserver</span> &#123;</span><br><span class="line">  <span class="comment">// 创建一个PerformanceObserver性能观察者实例</span></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">list, _observer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 因为只观察了resource，可以将 PerformanceEntryList 作为 PerformanceResourceTiming[] 类型进行遍历</span></span><br><span class="line">    (list.<span class="title function_">getEntries</span>() <span class="keyword">as</span> <span class="title class_">PerformanceResourceTiming</span>[]).<span class="title function_">forEach</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 如果不是beacon请求，就执行回调</span></span><br><span class="line">      <span class="keyword">if</span> (e.<span class="property">initiatorType</span> !== <span class="string">&quot;beacon&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">callback</span>(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 开始观察entryTypes为resource的性能条目，也就是资源加载性能</span></span><br><span class="line">  observer.<span class="title function_">observe</span>(&#123;</span><br><span class="line">    <span class="attr">entryTypes</span>: [<span class="string">&quot;resource&quot;</span>],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回观察者实例</span></span><br><span class="line">  <span class="keyword">return</span> observer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><p>项目中一些其它的内容。</p>
<h2 id="canvas指纹"><a href="#canvas指纹" class="headerlink" title="canvas指纹"></a>canvas指纹</h2><p><a target="_blank" rel="noopener" href="https://github.com/fingerprintjs/fingerprintjs">fingerprint</a> 等浏览器指纹识别库太大了，监控项目应该尽量减少第三方依赖，而为了标识用户，canvas 指纹是不错的选择。</p>
<p>不同设备、不同浏览器、不同版本，canvas 生成的图像数据都不同，获取其 Base64 编码的图像数据，然后生成8位hash值，就可以作为浏览器指纹ID。</p>
<figure class="highlight ts"><figcaption><span>src\utils\uuid.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串生成8位hash值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateHash</span>(<span class="params">str: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="comment">// 使用 atob 函数将 Base64 编码的图像数据解码为二进制字符串。</span></span><br><span class="line">  str = <span class="title function_">atob</span>(str);</span><br><span class="line">  <span class="keyword">let</span> hash = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 遍历字符串</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// charCodeAt() 方法可返回指定位置的字符的 Unicode 编码</span></span><br><span class="line">    <span class="comment">// &lt;&lt; 5 位运算符，将二进制数据后向左移动5位，相当于乘以2的5次方</span></span><br><span class="line">    <span class="comment">// 目的是提高 hash 的复杂度</span></span><br><span class="line">    hash = (hash &lt;&lt; <span class="number">5</span>) - hash + str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">    <span class="comment">// 当JS进行位运算时，它会将操作数视为 32 位整数，忽略其它位。</span></span><br><span class="line">    hash |= <span class="number">0</span>; <span class="comment">// 位运算符，将 hash 强制转换为 32 位整数</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 一个32位整数的十六进制位8位，所以就生成了一个8位的hash值</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(hash).<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过canvas获取浏览器指纹ID</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getCanvasID</span>(<span class="params">str: <span class="built_in">string</span> = <span class="string">&#x27;#qx.chuckle,123456789&lt;canvas&gt;&#x27;</span></span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>); <span class="comment">// 创建一个 canvas 元素</span></span><br><span class="line">  <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>); <span class="comment">// 获取 canvas 的 2D 渲染上下文</span></span><br><span class="line">  <span class="keyword">if</span> (!ctx) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.<span class="property">font</span> = <span class="string">&quot;14px &#x27;Arial&#x27;&quot;</span>; <span class="comment">// 设置字体</span></span><br><span class="line">  ctx.<span class="property">textBaseline</span> = <span class="string">&quot;bottom&quot;</span>; <span class="comment">// 设置基线</span></span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&quot;#f60&quot;</span>; <span class="comment">// 设置填充颜色</span></span><br><span class="line">  <span class="comment">// 在 canvas 上绘制一个橙色的矩形，矩形的左上角坐标为 (125, 1)，宽度为 62 像素，高度为 20 像素。</span></span><br><span class="line">  ctx.<span class="title function_">fillRect</span>(<span class="number">125</span>, <span class="number">1</span>, <span class="number">62</span>, <span class="number">20</span>);</span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&quot;#069&quot;</span>; <span class="comment">// 设置填充颜色</span></span><br><span class="line">  <span class="comment">// 在坐标 (2, 15) 的位置绘制深蓝色的文本，文本内容为 str。</span></span><br><span class="line">  ctx.<span class="title function_">fillText</span>(str, <span class="number">2</span>, <span class="number">15</span>);</span><br><span class="line">  ctx.<span class="property">fillStyle</span> = <span class="string">&quot;rgba(102, 204, 0, 0.7)&quot;</span>; <span class="comment">// 设置填充颜色</span></span><br><span class="line">  <span class="comment">// 在坐标 (4, 17) 的位置绘制半透明绿色的文本，文本内容为 str。</span></span><br><span class="line">  ctx.<span class="title function_">fillText</span>(str, <span class="number">4</span>, <span class="number">17</span>);</span><br><span class="line">  <span class="comment">// toDataURL将canvas转换为dataUrl也就是base64编码的图像数据，并去掉前缀保留数据部分</span></span><br><span class="line">  <span class="keyword">const</span> b64 = canvas.<span class="title function_">toDataURL</span>().<span class="title function_">replace</span>(<span class="string">&quot;data:image/png;base64,&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">generateHash</span>(b64);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>qx-tracker</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.qcqx.cn/article/31416cf6.html">https://www.qcqx.cn/article/31416cf6.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>轻笑Chuckle</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-01-18</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-01-18</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/TS/">TS</a></div><div class="post_share"></div></div><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投 喂</span><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/blog/pay/weixin.webp" alt="微信" loading="lazy"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/blog/pay/alipay.webp" alt="支付宝" loading="lazy"/></a><div class="post-qr-code-desc">支付宝</div></li><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">一个博客 一叶孤舟 一方世界</div></a></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/7c45abd.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/77-0.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">⇦上一篇</div><div class="prev_info">NestJS[一]-基础</div></div></a></div><div class="next-post pull-right"><a href="/article/9b01fd71.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇⇨</div><div class="next_info">Node-回眸[三]</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" data-no-lazy="data-no-lazy" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div></div><a class="card-widget" id="card-tuijian" href="https://afdian.net/a/chuckle" target="_blank" style="display:block"><div id="tj-box"><div id="tj-box1"><div id="tj-left"><p>扫一扫</p>
<span>快速打开移动端➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACC0lEQVR42u3aQXbDIAwFwNz/0u0B8ux+ITA0Ga+yiEHDwtKTeP189PPCw8PDw8PDw8PDw8PDw8PDw8PD+2LeK37e37pa7Y9Q3tYciwEPDw9vLy8JKA86CWhuDHh4eHi7eFfBXf2nmiqSd5MY8PDw8P47Ly+O7/fFw8PD+2ze1Zb36aF6fHh4eHjn8/IjSNapJoMjei14eHh4CwZg634fMd/Dw8PDC3jVZ+4HfVpUeHh4eA/yOk3YsXRSTU54eHh4p/GqjdQk9LEW7T2pVVLj4eHhTeXlW+YB5aliVsGNh4eH9yQv/wR32qxX60wbj+Hh4eEdwBv7iFfHZtUjwMPDwzuBNziqb5fX90e5sBmBh4eHt4zX2b6aSDor4OHh4T3P6xS1/WupeWrBw8PDO42Xb5CPyqoXsBYmBjw8PLwFJXWCTIrs6rXUWc1fPDw8vF28damiekx5MY2Hh4e3l1e9ODU2ssrBE5oReHh4eIt5Y82F6jrJLnmCwcPDw3ueN3cw1imgczYeHh7eXt5YGhhr1OaN4Icu+uPh4eFNbeMmrYe8mdtPLXh4eHhn8qoj/E5ZvKHXgoeHh7eV1xnzJxcFJjcj8PDw8A7jJaVzJ0lMvhmBh4eHN5U39p+xVJGACxHi4eHhPc7rf8SrgH4ZjYeHh7eL9xkPHh4eHh4eHh4eHh4eHh4eHh4e3hfwfgEcOCQOuR1J+AAAAABJRU5ErkJggg=="/></div></div></div><div id="tj-box2"><div id="tj-left"><p>爱发电</p>
<span>扫码或<span class="tj-light">点击跳转</span>➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACEElEQVR42u3bQXKDMAwFUO5/6fYAmbRfEhiTPK8YhiR+XtiKJI6fjx4HHh4eHh4eHh4eHh4eHh4eHh4e3hfzjnj88wMvz7x+9t33zOeAh4eHt56XT/31OrmTX/fmiYeHh3cX791GnPCSY+DdFl+dAx4eHt4TeclWXiXh4eHhfSqvGgRXkxR4eHh4z+JNUrTl9MGeuRY8PDy8Cwpg111vUd/Dw8PDC3jVkS9BHlKfMCs8PDy8hbxe60C+cfeSwuWWLzw8PLybeHm6tpfwrR4YeHh4eDvz8ibUKiAJu+ehNh4eHt5KXh7CzstU+fPl78HDw8NbzpuAJ4mG/Eg4uQCGh4eHN+ZNylr5ElxXMMPDw8O7i5ds7tV2qPwI6ZW+8PDw8NbzquWrfMvu3U+WAA8PD28fXu+oOOtIqIbReHh4ePvwJlPptZ/2khR4eHh49/KqbVVRmNsqjCWLjoeHh7cDL5/iJNQ+N3WLh4eHtxuvWhLLExB/H0iX/2PAw8PDG/PKW3ALk0+3dzzg4eHhreQd8chD7XlJ7OQCGB4eHt5l/ZyThMVZjftLcy14eHh4Y97fSYFeeF09fi4JqfHw8PA24FVfmuotXOEVLDw8PLxH8arg5Ek8PDy8p/DmRa9ei391UfDw8PB24OVbc34/b+fqvUiAh4eHdxfvMwYeHh4eHh4eHh4eHh4eHh4eHh7eF/B+Acr1Qv2GlsE8AAAAAElFTkSuQmCC"/></div></div></div></div></a><div class="card-widget card-announcement"><div class="item-headline"><i class="iconfont icon-gonggao"></i><span>公告</span></div><div class="announcement_content">欢迎来到『轻笑Chuckle』的小站<br>(￣▽￣)～■干杯□～(￣▽￣)<br>如果有什么加载不出来或者其它滴小bug,「刷新网页/Ctrl+F5」应该、也许能解决</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">构建环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#package-json"><span class="toc-number">2.1.</span> <span class="toc-text">package.json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rollup%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">rollup配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">项目结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">入口文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TrackerOptions%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">3.1.</span> <span class="toc-text">TrackerOptions配置类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trackerCls"><span class="toc-number">3.2.</span> <span class="toc-text">trackerCls</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tracker%E4%B8%BB%E7%B1%BB"><span class="toc-number">3.3.</span> <span class="toc-text">Tracker主类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8A%E6%8A%A5"><span class="toc-number">4.</span> <span class="toc-text">数据上报</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85sendBeacon"><span class="toc-number">4.1.</span> <span class="toc-text">封装sendBeacon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reportTracker%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.</span> <span class="toc-text">reportTracker方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sendReport%E7%B4%AF%E7%A7%AF%E4%B8%8A%E6%8A%A5"><span class="toc-number">4.3.</span> <span class="toc-text">sendReport累积上报</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sendTracker%E7%94%A8%E6%88%B7%E4%B8%BB%E5%8A%A8%E4%B8%8A%E6%8A%A5"><span class="toc-number">4.4.</span> <span class="toc-text">sendTracker用户主动上报</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LocationTracker%E7%B1%BB"><span class="toc-number">5.</span> <span class="toc-text">LocationTracker类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E8%B7%AF%E7%94%B1%E5%8F%98%E5%8C%96"><span class="toc-number">5.1.</span> <span class="toc-text">监听路由变化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#navigatorTracker%E7%B1%BB"><span class="toc-number">6.</span> <span class="toc-text">navigatorTracker类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DomTracker%E7%B1%BB"><span class="toc-number">7.</span> <span class="toc-text">DomTracker类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ErrorTracker%E7%B1%BB"><span class="toc-number">8.</span> <span class="toc-text">ErrorTracker类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#error%E4%BA%8B%E4%BB%B6"><span class="toc-number">8.1.</span> <span class="toc-text">error事件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PerformanceTracker"><span class="toc-number">9.</span> <span class="toc-text">PerformanceTracker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#performance-API"><span class="toc-number">9.1.</span> <span class="toc-text">performance API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E8%88%AA%E8%AE%A1%E6%97%B6"><span class="toc-number">9.1.1.</span> <span class="toc-text">导航计时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">9.2.</span> <span class="toc-text">性能指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getDomPerformance"><span class="toc-number">9.3.</span> <span class="toc-text">getDomPerformance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getResourcePerformance"><span class="toc-number">9.4.</span> <span class="toc-text">getResourcePerformance</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#listenResourceLoad"><span class="toc-number">9.5.</span> <span class="toc-text">listenResourceLoad</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">10.</span> <span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#canvas%E6%8C%87%E7%BA%B9"><span class="toc-number">10.1.</span> <span class="toc-text">canvas指纹</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/6ae8614b.html" title="Vue+TS 实现虚拟列表"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/98-0.webp" alt="Vue+TS 实现虚拟列表"></a><div class="content"><a class="title" href="/article/6ae8614b.html" title="Vue+TS 实现虚拟列表">Vue+TS 实现虚拟列表</a><time datetime="2024-07-04" title="发表于 2024-07-04">2024-07-04</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最近更新</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/1be64a8d.html" title="NestJS实践杂记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/77-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="NestJS实践杂记"/></a><div class="content"><a class="title" href="/article/1be64a8d.html" title="NestJS实践杂记">NestJS实践杂记</a><time datetime="2024-12-09T07:10:08.000Z" title="更新于 2024-12-09 15:10:08">2024-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/55cefeb1.html" title="React-记-3"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-3"/></a><div class="content"><a class="title" href="/article/55cefeb1.html" title="React-记-3">React-记-3</a><time datetime="2024-10-12T17:26:31.000Z" title="更新于 2024-10-13 01:26:31">2024-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/f17dfea3.html" title="React-记-2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-2"/></a><div class="content"><a class="title" href="/article/f17dfea3.html" title="React-记-2">React-记-2</a><time datetime="2024-09-26T11:26:24.000Z" title="更新于 2024-09-26 19:26:24">2024-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/cb488cbf.html" title="React-记-1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-1"/></a><div class="content"><a class="title" href="/article/cb488cbf.html" title="React-记-1">React-记-1</a><time datetime="2024-09-23T13:15:26.000Z" title="更新于 2024-09-23 21:15:26">2024-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/d186ebdd.html" title="闭包与内存泄漏"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/103-4.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="闭包与内存泄漏"/></a><div class="content"><a class="title" href="/article/d186ebdd.html" title="闭包与内存泄漏">闭包与内存泄漏</a><time datetime="2024-09-12T12:04:03.000Z" title="更新于 2024-09-12 20:04:03">2024-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(0, 0, 0, 0);"><div id="footer-wrap"><div id="footer_icon"><div class="icon_left"><a class="icon_link" target="_blank" href="http://foreverblog.cn/go.html" rel="noopener external nofollow" title="虫洞-随机访问十年之约成员博客"><i class="fa-solid fa-circle-notch fa-fw"></i></a><a class="icon_link" target="_blank" href="https://travellings.cn" rel="noopener external nofollow" title="开往-随机跳转到另一个加入开往的网页"><i class="fa-solid fa-subway fa-fw"></i></a><a class="icon_link" href="/link/" title="友链"><i class="fa-solid fa-link fa-fw"></i></a><a class="icon_link" href="/messageboard/" title="留言"><i class="fa-regular fa-comment fa-fw"></i></a></div><img class="footer_logo entered loaded" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" onclick="btf.scrollToDest(0,500)" title="返回顶部"/><div class="icon_left"><a class="icon_link" target="_blank" rel="noopener" href="https://www.qcqx.cn/" title="我的主页"><i class="fa-solid fa-compass fa-fw"></i></a><a class="icon_link" target="_blank" href="https://res.abeim.cn/api/qq/?qq=1934009145" rel="noopener external nofollow" title="联系QQ"><i class="fa-brands fa-qq fa-fw"></i></a><a class="icon_link" target="_blank" href="https://github.com/qxchuckle" rel="noopener external nofollow" title="我的Github主页"><i class="fa-brands fa-github fa-fw"></i></a><a class="icon_link" href="mailto:chuckle@chuckle.top" rel="noopener external nofollow" title="邮件联系"><i class="fa-solid fa-envelope fa-fw"></i></a></div></div><div class="copyright">&copy;2022 - 2026 By 『轻笑Chuckle』<a id="beianhao" style="color:#fff;font-size:0.9rem;font-weight:400;" href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2022076449号</a></div><div class="footer_custom_text">『Another branch will grow and flourish in the future』</div><div class="footer-banner"><div id="footer-banner-time"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>if(! (navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))){
function createtime() {
var now = new Date();
var grt= new Date("03/10/2022 00:00:00");
now.setTime(now.getTime()+1000);
days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
document.getElementById("timeDate").innerHTML = "自 2022-3-10 建站以来，小站已苟活 "+dnum+" 天 ";
document.getElementById("times").innerHTML = hnum + " 时 " + mnum + " 分 ( =•ω•= )m";
}
createtime();
if(typeof footer_time == "undefined"){
  var footer_time = setInterval("createtime()",1000*60);
}else{
  clearInterval(footer_time);
  footer_time = setInterval("createtime()",1000*60);
}
}
</script></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/hexo.svg"/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/butterfly.svg"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/github.svg"/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20220160" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/20220160.svg"/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/2022076449.svg"/></a><a class="github-badge" target="_blank" href="https://cloud.tencent.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/tx.svg"/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/vercel.svg"/></a><a class="github-badge" target="_blank" href="https://tianli-blog.club/jsd/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/tianlicdn.svg"/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/ypy.svg"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/cc.svg"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="refresh-cache" type="button" title="刷新缓存" onclick="refreshCache()"><i class="fas fa-refresh fa-spin"></i></button><button id="enlargePage-btn" type="button" title="放大页面" onclick="enlargePage()"><i class="fa fa-plus"></i></button><button id="narrowPage-btn" type="button" title="缩小页面" onclick="narrowPage()"><i class="fa fa-minus"></i></button><button type="button" title="切换背景" onclick="toggleWinbox()"><i class="fa fa-images"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn();"><i class="fas fa-comments"></i></button><button id="share-link" type="button" title="分享链接"><i class="fa fa-share-alt"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-top"><i class="fa fa-angles-up"></i></div></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:kk.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-magnifying-glass"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-read"><a class="rightMenu-item" href="javascript:kk.pasteText();"><i class="fa fa-paste"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" id="menu-radompage" href="/"><i class="fa-solid fa-shoe-prints"></i><span>博客主页</span></a><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-adjust"></i><span>昼夜切换</span></div><div class="rightMenu-item" id="share-chuckle"><i class="fa fa-share-alt"></i><span>分享本页</span></div><a class="rightMenu-item" id="menu-radompage" href="/categories/"><i class="fa fa-archive"></i><span>分类</span></a><a class="rightMenu-item" id="menu-radompage" href="/tags/"><i class="fa fa-tags"></i><span>标签</span></a></div></div><div id="rightmenu-mask" onclick="RemoveRightMenu()"></div><div><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/utils.js"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/main.js?6"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/search/local-search.js?2"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 2500);</script><div class="js-pjax"><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.qcqx.cn',
      path: location.pathname,
      visitor: true,
      dark: 'html[data-theme="dark"]'
    }, {"requiredMeta":["nick","mail"],"wordLimit":400,"placeholder":"来评论交流吧，通过邮件通知（表情点不出来请刷新页面）"}))
  }

  if (typeof Waline === 'function') initWaline()
  else getScript('https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/waline.min.js?7').then(initWaline)
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/qx-tracker.min.js?1"></script><script>const tracker = new Tracker({requestUrl:'https://tracker-api.qcqx.cn/api/tracker',historyTracker:true,realTime:true});</script><script defer="true" src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/random.min.js?14"></script><script defer="true" src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/chuckle.js?15"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/chuckle-post-ai.js?11"></script><script defer>new ChucklePostAI({el:'#post>#article-container',key:'tN2jLmG7fX9zHk5dVbQr',title_el:'.post-title',rec_method:'web',whitelist:['article/17d3383a.html'],pjax:true})</script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#fixedcard-dashboard","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div id="fixedcard-dashboard"><button class="fixedcard-activebtn" type="button" title="用户信息" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-info&quot;,&quot;0&quot;)"><i class="fas fa-address-book"></i></button><button class="fixedcard-activebtn" type="button" title="公告" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-announcement&quot;,&quot;0&quot;)"><i class="fa fa-bullhorn"></i></button><button class="fixedcard-activebtn" type="button" title="相关推荐" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recommend-post&quot;,&quot;0&quot;)"><i class="fas fa-dharmachakra"></i></button><button class="fixedcard-activebtn" type="button" title="最近更新" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recent-post&quot;,&quot;0&quot;)"><i class="fas fa-history"></i></button><div class="fixedcard-user-avatar fixedcard-activebtn" onclick="RemoveFixedCardWidget()"><img class="fixedcard-user-avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/head.webp" title="『轻笑Chuckle』"></div></div></div><!-- hexo injector body_end start --><script data-pjax>function hope_light_loader_injector_config(){
                var parent_div_git = document.getElementById('body-wrap');
                var item_html = '<div id="loading-bar-wrapper">';
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementById('body-wrap') && (location.pathname ==='all'|| 'all' ==='all')){
            hope_light_loader_injector_config()
        } </script>
    <script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/nprogress.min.js"></script>
    <script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script data-pjax>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
      document.addEventListener('pjax:send', window.ShowLoading)
      document.addEventListener('pjax:success', window.HideLoading)
      document.addEventListener('pjax:error', window.HideLoading)
    </script>
<!-- hexo injector body_end end --></body></html>