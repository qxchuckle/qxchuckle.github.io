<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><script>if ('serviceWorker' in navigator) {
  if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 1) {
    (async()=>{window.stop()})()
    window.localStorage.setItem('ChenBlogHelper_Set', 1)
  }
  navigator.serviceWorker.register('/giggles.js')
    .then(async () => {
      if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 2) {
        window.localStorage.setItem('ChenBlogHelper_Set', 2)
        setTimeout(() => {
          window.location.reload()
        }, 150)
      }
    })
}
//- function setQXCookies(obj, limitTime, customDomain) {
//-     let data = new Date(new Date().getTime() + limitTime * 24 * 60 * 60 * 1000).toGMTString();
//-     for (let i in obj) {
//-       document.cookie = i + '=' + obj[i] + ';expires=' + data + ';domain=' + customDomain;
//-     }
//- }
//- function getQXCookie(name) {
//-     var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
//-     if (arr = document.cookie.match(reg))
//-         return decodeURIComponent(arr[2]);
//-     else
//-         return null;
//- }
//- if(getQXCookie('qcqx')!=="chuckle"){
//-   setQXCookies({ qcqx: 'chuckle' }, 365, 'qcqx.cn');
//- }else{
//-   console.log("qcqx");
//- }</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>NestJS[三]-进阶 | 轻笑Chuckle</title><meta name="keywords" content="NestJS,后端"><meta name="author" content="『轻笑Chuckle』"><meta name="copyright" content="『轻笑Chuckle』"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="baidu-site-verification" content="codeva-BLXfA46XrF"><meta name="description" content="Logger、ModuleRef、生命周期、Swagger、JWT、config">
<meta property="og:type" content="article">
<meta property="og:title" content="NestJS[三]-进阶">
<meta property="og:url" content="https://www.qcqx.cn/article/73b2ab6d.html">
<meta property="og:site_name" content="轻笑Chuckle">
<meta property="og:description" content="Logger、ModuleRef、生命周期、Swagger、JWT、config">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://qxchuckle.github.io/images/77-0.webp">
<meta property="article:published_time" content="2024-02-16T16:47:16.000Z">
<meta property="article:modified_time" content="2024-02-16T16:47:16.000Z">
<meta property="article:author" content="『轻笑Chuckle』">
<meta property="article:tag" content="NestJS">
<meta property="article:tag" content="后端">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qxchuckle.github.io/images/77-0.webp"><link rel="shortcut icon" href="https://qxchuckle.github.io/img/head.webp"><link rel="canonical" href="https://www.qcqx.cn/article/73b2ab6d"><link rel="stylesheet" href="https://qxchuckle.github.io/css/index.css?280"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.json","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":160},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NestJS[三]-进阶',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-17 00:47:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://qxchuckle.github.io/css/tag_plugins.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="轻笑Chuckle" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/head.webp" data-lazy-src="https://qxchuckle.github.io/img/head.webp"/></div></div><div id="web_bg"></div><div id="svg_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="is-center" id="sidebar-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/head.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="menu-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><div id="chuckle_home"><div class="back-home-button"><i class="back-home-button-icon fas fa-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">传送门</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="前往博客主页" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/head.webp" loading="lazy"/><span class="back-menu-item-text">博客主页</span></a><a class="back-menu-item" href="https://waline.qcqx.cn/ui" rel="external nofollow" title="前往评论后端" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/c4.webp" loading="lazy"/><span class="back-menu-item-text">评论管理</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客线路</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.qcqx.cn/" title="前往博客主站" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/h4.webp" loading="lazy"/><span class="back-menu-item-text">主域名线路</span></a><a class="back-menu-item" href="https://qxchuckle.github.io/" title="前往博客Github线路" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/c6.webp" loading="lazy"/><span class="back-menu-item-text">Github线路</span></a></div></div></div></div></div><span id="blog_name"><a id="site-name" href="/">轻笑Chuckle</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div><div id="buttons"><div id="switch-bg"><a class="site-page social-icon search" href="javascript:;" rel="noopener external nofollow" onclick="toggleWinbox()" title="切换背景-换一种感觉。"><i class="fas fa-images fa-fw"></i></a></div><div id="switch-darkmode"><a class="site-page social-icon" onclick="kk.switchDarkMode()" title="切换模式"><i class="fas fa-adjust fa-fw"></i></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info" style="background-image: url('https://qxchuckle.github.io/images/77-0.webp')"><div id="post-meta-top"><span class="post-categories"><i class="iconfont icon-fenlei fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span><span class="post-tags"><a class="post-meta-tags" href="/tags/NestJS/">NestJS</a><a class="post-meta-tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a></span></div><h1 class="post-title">NestJS[三]-进阶<a class="post-share" id="share-post" href="javascript:;" rel="noopener external nofollow" onclick="kk.postURL()"><i class="fa fa-share-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="iconfont icon-shalou fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-16T16:47:16.000Z" title="发表于 2024-02-17 00:47:16">2024-02-17</time></span><span class="post-meta-date"><i class="iconfont icon-gengxin fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-16T16:47:16.000Z" title="更新于 2024-02-17 00:47:16">2024-02-17</time></span></div><div class="meta-secondline"><span class="post-meta-wordcount"><i class="iconfont icon-tongji1 fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.6k</span></span><span class="post-meta-wordcount"><i class="iconfont icon-tubiaozhizuomoban- fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="leancloud_visitors" id="/article/73b2ab6d.html" data-flag-title="NestJS[三]-进阶"><i class="iconfont icon-yanjing fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-commentcount"><i class="iconfont icon-pinglun fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/article/73b2ab6d.html#post-comment"><span class="waline-comment-count" id="/article/73b2ab6d.html"></span></a></span></div></div></div><article class="post-content" id="article-container"><div class="Copyright-Notice" id="Copyright-Notice"><div id="post-Copyright-bar"></div><div id="Copyright-box"><span>本站博文未在任何平台</span><span class="copyright-phone-none">以任何形式</span><span>售卖，详情:</span><a href="/agreement/">协议</a></div></div><div class="post-series"><div class="post-series-title"> <span class="arrowhead">▸</span><span>NestJS-系列</span></div><div class="post-series-box"><script>if(1){
let series_title=document.querySelector('.post-series-title')
let arrowhead=document.querySelector('.arrowhead')
var arrowhead_n = 1;
series_title.addEventListener('click',function(){
    let content=document.querySelector('.post-series-box')
    content.classList.toggle("show")
    if(arrowhead_n){
      arrowhead.innerHTML = "▾"
      arrowhead_n = 0
    }else{
      arrowhead.innerHTML = "▸"
      arrowhead_n = 1
    }
})
}</script><div class="post-series-item"><a class="title" href="/article/7c45abd.html" title="NestJS[一]-基础">NestJS[一]-基础</a></div><div class="post-series-item"><a class="title" href="/article/c79e1541.html" title="RxJS">RxJS</a></div><div class="post-series-item"><a class="title" href="/article/c81f9b65.html" title="NestJS[二]-核心">NestJS[二]-核心</a></div><div class="post-series-item"><a class="title" href="/article/73b2ab6d.html" title="NestJS[三]-进阶">NestJS[三]-进阶</a></div><div class="post-series-item"><a class="title" href="/article/e18aeaaa.html" title="NestJS[四]-数据库">NestJS[四]-数据库</a></div></div></div><h1 id="Logger日志"><a href="#Logger日志" class="headerlink" title="Logger日志"></a>Logger日志</h1><p>node服务端常用的日志收集工具：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/winston">winston</a>、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/log4js">log4js</a>、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bunyan">bunyan</a>、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/npmlog">npmlog</a>等</p>
<p>Nest内置了一个基于文本的日志记录器：<a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/logger">Logger</a></p>
<p><strong>类结构：</strong></p>
<ol>
<li><code>LoggerService</code> 是接口标准，如果要替换掉内置的日志类，最低要求是得符合这个接口。</li>
<li><code>ConsoleLogger</code> 日志主要业务类，主要负责处理格式化日志字符串输出。</li>
<li><code>Logger</code> 更高层封装，加入了输出缓存，并统一管理日志等级。自身有一个ConsoleLogger的默认单例。</li>
</ol>
<h2 id="配置Logger"><a href="#配置Logger" class="headerlink" title="配置Logger"></a>配置Logger</h2><p>在创建Nest应用时,通过<code>NestApplicationOptions.logger</code>来配置Logger，用于系统日志记录。</p>
<p><strong>注意：</strong>这些配置不会影响到<strong>自定义Logger</strong>，只作用于<strong>内置Logger类</strong>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger?: <span class="title class_">LoggerService</span> | <span class="title class_">LogLevel</span>[] | <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>设置为<strong>false</strong>时，将<strong>禁用</strong>Logger日志</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">  <span class="attr">logger</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>还可以指定输出的<strong>最低日志等级</strong>，优先级更高的也将被输出。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">  <span class="attr">logger</span>: [<span class="string">&#x27;log&#x27;</span>], <span class="comment">// log及以上等级的日志将被输出，如warn、error</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Logger默认提供了6个日志等级</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">LogLevel</span> = <span class="string">&#x27;log&#x27;</span> | <span class="string">&#x27;error&#x27;</span> | <span class="string">&#x27;warn&#x27;</span> | <span class="string">&#x27;debug&#x27;</span> | <span class="string">&#x27;verbose&#x27;</span> | <span class="string">&#x27;fatal&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LOG_LEVEL_VALUES</span> = &#123;</span><br><span class="line">  <span class="comment">// 优先级从低到高</span></span><br><span class="line">  <span class="attr">verbose</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">debug</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">log</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">warn</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">error</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">fatal</span>: <span class="number">5</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="自定义Logger"><a href="#自定义Logger" class="headerlink" title="自定义Logger"></a>自定义Logger</h2><p>实现了<code>LoggerService</code>接口的自定义Logger，可以被Nest应用使用，相当于完全<strong>重写并覆盖</strong>内置Logger</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">LoggerService</span> &#123;</span><br><span class="line">  <span class="title function_">log</span>(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  <span class="title function_">error</span>(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  <span class="title function_">warn</span>(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  debug?(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  verbose?(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  fatal?(<span class="attr">message</span>: <span class="built_in">any</span>, ...<span class="attr">optionalParams</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br><span class="line">  setLogLevels?(<span class="attr">levels</span>: <span class="title class_">LogLevel</span>[]): <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若只需要<strong>扩展</strong>内置的Logger，可以继承<code>ConsoleLogger</code>类，覆盖需要扩展的方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class ConsoleLogger implements LoggerService &#123;&#125;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyLogger</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ConsoleLogger</span> &#123;</span><br><span class="line">  <span class="title function_">error</span>(<span class="params">message: <span class="built_in">any</span>, stack?: <span class="built_in">string</span>, context?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>.<span class="title function_">error</span>(...<span class="variable language_">arguments</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Nest应用中使用自定义Logger，用于系统日志记录</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">  <span class="attr">logger</span>: <span class="keyword">new</span> <span class="title class_">MyLogger</span>(), <span class="comment">// 使用自定义Logger</span></span><br><span class="line">  <span class="comment">// logger: console // 使用console对象</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以通过 <code>set*()</code> 等实例方法配置自定义Logger，如 <code>setLogLevels()</code> 设置输出的最低日志等级。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">setLogLevels</span>([<span class="string">&#x27;error&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h2><p>Logger默认的日志格式如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">AppName</span>] [<span class="variable constant_">PID</span>] [<span class="title class_">Timestamp</span>] [<span class="title class_">LogLevel</span>] [<span class="title class_">Context</span>] <span class="title class_">Message</span> [+ms]</span><br></pre></td></tr></table></figure>
<ol>
<li><strong>AppName</strong> 应用程序名，被固定为[Nest]</li>
<li><strong>PID</strong>：系统分配的进程编号</li>
<li><strong>Timestamp</strong>：当前日志输出的格式化系统时间</li>
<li><strong>LogLevel</strong>：日志等级文本</li>
<li><strong>Context</strong>：上下文</li>
<li><strong>Message</strong>：输出的消息，可以是对象类型输出</li>
<li><strong>+ms</strong>：两次输出日志的时间间隔，时间戳</li>
</ol>
<h2 id="使用Logger"><a href="#使用Logger" class="headerlink" title="使用Logger"></a>使用Logger</h2><p>通过<code>Logger</code>类手动实例化一个Logger对象，用于输出日志，还可以使用<code>app.useLogger()</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span> <span class="keyword">implements</span> <span class="title class_">LoggerService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">context: <span class="built_in">string</span>, options?: &#123;</span></span><br><span class="line"><span class="params">    timestamp?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  &#125;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其构造函数接受两个参数：</p>
<ol>
<li><strong>context</strong>：上下文，用于标识日志输出的位置</li>
<li><strong>options</strong>：配置项，只有一个<code>timestamp</code>属性，表示是否输出 <strong>+ms</strong>，默认为<strong>false</strong></li>
</ol>
<p>其日志方法接收两个参数：</p>
<ol>
<li><strong>message</strong>：输出的消息，可以是对象类型，配合<code>format()</code>方法，用于格式化输出多个消息</li>
<li><strong>context</strong>：上下文，用于标识日志输出的位置。</li>
</ol>
<p><strong>注意：</strong>当Logger实例也配置了context时，以Logger实例的context为准，并且会在输出的日志中追加一条日志方法的context信息。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Logger</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> <span class="title class_">Logger</span>(<span class="string">&#x27;app&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line">logger.<span class="title function_">log</span>(<span class="title function_">format</span>(<span class="string">&#x27;%s %s %s&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/test&#x27;</span>, <span class="string">&#x27;test&#x27;</span>), <span class="string">&#x27;log&#x27;</span>);</span><br><span class="line"><span class="comment">// [Nest] 28128  - 2024/02/17 14:08:45     LOG [app] GET /test test +1107ms</span></span><br><span class="line"><span class="comment">// [Nest] 28128  - 2024/02/17 14:08:45     LOG [app] log +1ms // 追加的日志方法的context信息</span></span><br></pre></td></tr></table></figure>
<h2 id="依赖注入Logger"><a href="#依赖注入Logger" class="headerlink" title="依赖注入Logger"></a>依赖注入Logger</h2><p>手动实例化Logger对象，破坏了单例，不利于统一日志。</p>
<p>包装一层 <code>LoggerModule</code>，通过依赖注入的方式，统一管理Logger实例。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MyLoggerService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./my-logger.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">MyLoggerService</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">MyLoggerService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MyLoggerModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConsoleLogger</span>, <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">MyLoggerService</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ConsoleLogger</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>设置为全局模块，或在需要的地方导入使用，使用 <code>setContext()</code> 设置上下文。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MyLoggerService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./my-logger/my-logger.service&#x27;</span>;</span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> logger: MyLoggerService,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">setContext</span>(<span class="title class_">AppController</span>.<span class="property">name</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  <span class="title function_">getTest</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">log</span>(<span class="title function_">format</span>(<span class="string">&#x27;%s %s %s&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/test&#x27;</span>, <span class="string">&#x27;test&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若需用于系统日志记录，还需要通过 <code>app.useLogger()</code> 应用自定义Logger，并开启 <code>bufferLogs</code> 日志缓冲。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>, &#123;</span><br><span class="line">  <span class="attr">bufferLogs</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// app.get()调用检索MyLoggerService的单例实例，并依赖于首先在另一个模块中注入该实例</span></span><br><span class="line">app.<span class="title function_">useLogger</span>(app.<span class="title function_">get</span>(<span class="title class_">MyLoggerService</span>));</span><br></pre></td></tr></table></figure>
<p><code>app.get()</code> 可以检索某个类型的单例实例，依赖于首先在另一个模块中注入该实例。无需再重复实例化。</p>
<h1 id="ModuleRef模块引用"><a href="#ModuleRef模块引用" class="headerlink" title="ModuleRef模块引用"></a>ModuleRef模块引用</h1><p><a target="_blank" rel="noopener" href="https://docs.nestjs.com/fundamentals/module-ref">ModuleRef</a> 类用于检索模块中的<strong>提供者实例</strong>，并使用注入令牌作为查找键名来获取实例的引用。</p>
<p><code>ModuleRef</code> 可以通过常规方法注入到类中。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ModuleRef</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> moduleRef: ModuleRef</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取实例"><a href="#获取实例" class="headerlink" title="获取实例"></a>获取实例</h2><p><code>ModuleRef.get()</code> 使用注入标记/类名检索当前模块中存在（已实例化）的提供者、控制器或可注入项（例如，守卫、拦截器等）</p>
<p>若该提供者是其它模块定义并暴露的，需要将<code>strict</code>设置为<strong>false</strong>，从全局上下文中检索。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./user/user.service&#x27;</span>;</span><br><span class="line">moduleRef.<span class="title function_">get</span>(<span class="title class_">UserService</span>, &#123; <span class="attr">strict</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure>
<p><code>ModuleRef</code> 无视了模块的依赖关系，能直接从全局上下文中检索提供者实例。<br>若需要另一个模块的提供者实例，可以不暴露该提供者、不导入该模块，直接通过<code>ModuleRef</code>检索。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;download&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DownloadController</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">userService</span>: <span class="title class_">UserService</span>;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> moduleRef: ModuleRef,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userService</span> = moduleRef.<span class="title function_">get</span>(<span class="title class_">UserService</span>, &#123; <span class="attr">strict</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userService</span>.<span class="title function_">findOne</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>不能通过<code>get()</code>方法检索作用域提供者（瞬态或请求作用域）</p>
<h2 id="解析作用域提供者"><a href="#解析作用域提供者" class="headerlink" title="解析作用域提供者"></a>解析作用域提供者</h2><p>通过 <code>ModuleRef.resolve()</code> 方法解析作用域提供者，返回该提供者的<strong>唯一实例</strong>(Promise)。</p>
<p>多次调用该方法，返回的是不同的实例。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transientServices = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>),</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>),</span><br><span class="line">]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(transientServices[<span class="number">0</span>] === transientServices[<span class="number">1</span>]); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>为了在多个 <code>resolve()</code> 调用之间生成<strong>单个实例</strong>，可以通过 <code>ContextIdFactory</code> 创建一个上下文标识，并传递给 <code>resolve()</code> 方法。相同的上下文标识，返回的是相同的实例。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contextId = <span class="title class_">ContextIdFactory</span>.<span class="title function_">create</span>();</span><br><span class="line"><span class="keyword">const</span> transientServices = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">  <span class="comment">// 传递相同的上下文标识</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>, contextId),</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>, contextId),</span><br><span class="line">]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(transientServices[<span class="number">0</span>] === transientServices[<span class="number">1</span>]); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h3 id="请求提供者"><a href="#请求提供者" class="headerlink" title="请求提供者"></a>请求提供者</h3><p>若通过 <code>resolve()</code> 解析<strong>请求作用域提供者</strong>，会导致 <code>REQUEST</code> 提供者注入为 <code>undefined</code>。因为它们不是由 Nest 依赖注入系统实例化和管理的。</p>
<figure class="highlight ts"><figcaption><span>一个请求作用域提供者</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">REQUEST</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">  <span class="meta">@Inject</span>(<span class="variable constant_">REQUEST</span>)</span><br><span class="line">  <span class="attr">res</span>: <span class="title class_">Request</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getHello</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">res</span>.<span class="property">url</span>); <span class="comment">// /value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要使用 <code>registerRequestByContextId()</code> 方法，先将请求对象注册到上下文中，再通过 <code>resolve()</code> 方法解析请求作用域提供者。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contextId = <span class="title class_">ContextIdFactory</span>.<span class="title function_">create</span>();</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">registerRequestByContextId</span>(<span class="comment">/* YOUR_REQUEST_OBJECT */</span>, contextId);</span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>, contextId),</span><br></pre></td></tr></table></figure>
<p>若在请求提供者中解析另一个请求提供者，可以更方便地通过 <code>getByRequest()</code> 方法基于请求对象创建一个上下文标识，并将其传递给 <code>resolve()</code> 调用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contextId = <span class="title class_">ContextIdFactory</span>.<span class="title function_">getByRequest</span>(<span class="variable language_">this</span>.<span class="property">request</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">resolve</span>(<span class="title class_">TransientService</span>, contextId);</span><br></pre></td></tr></table></figure>
<h2 id="动态实例化"><a href="#动态实例化" class="headerlink" title="动态实例化"></a>动态实例化</h2><p><code>ModuleRef.create()</code> 动态实例化一个之前没有注册为提供者的类。</p>
<p>即使该类已经被注册为提供者且已经实例化，也会创建一个新的实例(Promise)。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">moduleRef</span>.<span class="title function_">create</span>(oneService);</span><br></pre></td></tr></table></figure>
<p>与直接 <code>new</code> 不同，<code>create()</code> 会处理依赖注入，但这些依赖必须是执行 <code>create()</code> 所在的模块中能访问到的，缺失的依赖需要导入到该模块中。</p>
<h1 id="生命周期事件"><a href="#生命周期事件" class="headerlink" title="生命周期事件"></a>生命周期事件</h1><p>Nest 应用以及每个应用元素都有一个由 Nest 管理的生命周期。<a target="_blank" rel="noopener" href="https://docs.nestjs.com/fundamentals/lifecycle-events">文档</a></p>
<p>Nest 提供了许多钩子方法，用于在生命周期的不同阶段执行自定义逻辑。</p>
<ol>
<li><code>onModuleInit()</code> 一旦解决了模块的依赖，就会调用。</li>
<li><code>onApplicationBootstrap()</code> 在所有模块初始化后调用，但在监听连接之前。</li>
<li><code>onModuleDestroy()</code>* 在收到终止信号（如 SIGINT）或 <code>app.close()</code> 后调用。</li>
<li><code>beforeApplicationShutdown()</code>* 在所有 onModuleDestroy 完成后调用。</li>
<li><code>onApplicationShutdown()</code>* 在连接关闭后调用。</li>
</ol>
<p><strong>注意：</strong>请求作用域的类没有生命周期钩子。它们专门为每个请求创建，并在发送响应后自动进行垃圾回收。</p>
<p>*若没有显式调用 <code>app.close()</code>，则三个关闭钩子默认是不会监听系统信号（如 SIGINT）的，监听系统信号会消耗较多的系统资源。可以通过 <code>app.enableShutdownHooks()</code> 启用对系统信号的监听，但信号在windows上可能无法预期地工作。</p>
<h2 id="使用钩子"><a href="#使用钩子" class="headerlink" title="使用钩子"></a>使用钩子</h2><p>每个生命周期钩子都由一个接口表示。</p>
<p>以 <code>onModuleInit()</code> 为例：需要实现 <code>OnModuleInit</code> 接口。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">OnModuleInit</span> &#123;</span><br><span class="line">  <span class="title function_">onModuleInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`The UserService has been initialized.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果生命周期钩子返回一个 Promise，Nest 将等待这个 Promise 完成（或者解决）之后再继续生命周期。</p>
<p>所以<code>onModuleInit()</code>和<code>onApplicationBootstrap()</code>钩子可以是异步的，以<strong>推迟</strong>模块的初始化，可以完成如数据库连接等异步工作后，在完成应用初始化、监听连接。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">OnModuleInit</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">onModuleInit</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;初始化完成&#x27;</span>);</span><br><span class="line">        <span class="title function_">resolve</span>();</span><br><span class="line">      &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整体案例：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;</span><br><span class="line">  <span class="title function_">onModuleInit</span>(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;onModuleInit.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onApplicationBootstrap</span>(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;onApplicationBootstrap down.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onModuleDestroy</span>(): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;onModuleDestroy&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">beforeApplicationShutdown</span>(signal?: <span class="built_in">string</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;beforeApplicationShutdown:&#x27;</span>, signal);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">onApplicationShutdown</span>(signal?: <span class="built_in">string</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;OnApplicationShutdown:&#x27;</span>, signal);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">onModuleInit.</span><br><span class="line">onApplicationBootstrap down.</span><br><span class="line">[Nest] 20808  - 2024/02/17 18:03:51     LOG [NestApplication] Nest application successfully started</span><br><span class="line">onModuleDestroy</span><br><span class="line">beforeApplicationShutdown: SIGINT</span><br><span class="line">OnApplicationShutdown: SIGINT</span><br></pre></td></tr></table></figure>
<h1 id="swagger接口文档"><a href="#swagger接口文档" class="headerlink" title="swagger接口文档"></a>swagger接口文档</h1><p><a target="_blank" rel="noopener" href="https://swagger.io/">Swagger</a> 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务的接口文档。</p>
<p><a target="_blank" rel="noopener" href="https://swagger.io/tools/swagger-ui/">Swagger UI</a> 用于将 Swagger 规范生成的文档呈现为交互式的、动态的 API 文档。</p>
<p>在Nset中使用需安装<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@nestjs/swagger">@nestjs/swagger</a>，<code>npm i -S @nestjs/swagger</code>，<a target="_blank" rel="noopener" href="https://docs.nestjs.com/openapi/introduction">文档</a></p>
<p>使用 <code>SwaggerModule</code> 类初始化 Swagger 文档，<code>DocumentBuilder</code> 类配置文档。</p>
<figure class="highlight ts"><figcaption><span>main.ts 基本使用</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SwaggerModule</span>, <span class="title class_">DocumentBuilder</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/swagger&#x27;</span>;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="comment">// 配置Swagger</span></span><br><span class="line">  <span class="keyword">const</span> config = <span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>()</span><br><span class="line">    .<span class="title function_">setTitle</span>(<span class="string">&#x27;接口文档&#x27;</span>)</span><br><span class="line">    .<span class="title function_">setDescription</span>(<span class="string">&#x27;一个API文档&#x27;</span>)</span><br><span class="line">    .<span class="title function_">setVersion</span>(<span class="string">&#x27;1.0&#x27;</span>)</span><br><span class="line">    .<span class="title function_">build</span>();</span><br><span class="line">  <span class="comment">// 生成文档</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">document</span> = <span class="title class_">SwaggerModule</span>.<span class="title function_">createDocument</span>(app, config);</span><br><span class="line">  <span class="comment">// 启动文档</span></span><br><span class="line">  <span class="title class_">SwaggerModule</span>.<span class="title function_">setup</span>(<span class="string">&#x27;api&#x27;</span>, app, <span class="variable language_">document</span>);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DocumentBuilder</code> 提供了一系列的方法用于构建符合 OpenAPI 规范的基本文档。</p>
<figure class="highlight ts"><figcaption><span>DocumentBuilder类</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DocumentBuilder</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> logger;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="variable language_">document</span>;</span><br><span class="line">  <span class="title function_">setTitle</span>(<span class="attr">title</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setDescription</span>(<span class="attr">description</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setVersion</span>(<span class="attr">version</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setTermsOfService</span>(<span class="attr">termsOfService</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setContact</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">email</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setLicense</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">url</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addServer</span>(<span class="attr">url</span>: <span class="built_in">string</span>, description?: <span class="built_in">string</span>, variables?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">ServerVariableObject</span>&gt;): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setExternalDoc</span>(<span class="attr">description</span>: <span class="built_in">string</span>, <span class="attr">url</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">setBasePath</span>(<span class="attr">path</span>: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addTag</span>(<span class="attr">name</span>: <span class="built_in">string</span>, description?: <span class="built_in">string</span>, externalDocs?: <span class="title class_">ExternalDocumentationObject</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addExtension</span>(<span class="attr">extensionKey</span>: <span class="built_in">string</span>, <span class="attr">extensionProperties</span>: <span class="built_in">any</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addSecurity</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">SecuritySchemeObject</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addGlobalParameters</span>(...<span class="attr">parameters</span>: <span class="title class_">ParameterObject</span>[]): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addSecurityRequirements</span>(<span class="attr">name</span>: <span class="built_in">string</span> | <span class="title class_">SecurityRequirementObject</span>, requirements?: <span class="built_in">string</span>[]): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addBearerAuth</span>(options?: <span class="title class_">SecuritySchemeObject</span>, name?: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addOAuth2</span>(options?: <span class="title class_">SecuritySchemeObject</span>, name?: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addApiKey</span>(options?: <span class="title class_">SecuritySchemeObject</span>, name?: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addBasicAuth</span>(options?: <span class="title class_">SecuritySchemeObject</span>, name?: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">addCookieAuth</span>(cookieName?: <span class="built_in">string</span>, options?: <span class="title class_">SecuritySchemeObject</span>, securityName?: <span class="built_in">string</span>): <span class="variable language_">this</span>;</span><br><span class="line">  <span class="title function_">build</span>(): <span class="title class_">Omit</span>&lt;<span class="title class_">OpenAPIObject</span>, <span class="string">&#x27;paths&#x27;</span>&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SwaggerModule.createDocument</code> 返回的是一个符合<a target="_blank" rel="noopener" href="https://swagger.io/specification/#openapi-document">OpenAPI</a>规范的 <code>OpenAPIObject</code> 可序列化对象，不仅可以通过 HTTP 进行托管，还可以将其保存为 JSON/YAML 文件，并以不同的方式使用。</p>
<figure class="highlight ts"><figcaption><span>SwaggerModule类</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SwaggerModule</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> metadataLoader;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">createDocument</span>(<span class="attr">app</span>: <span class="title class_">INestApplication</span>, <span class="attr">config</span>: <span class="title class_">Omit</span>&lt;<span class="title class_">OpenAPIObject</span>, <span class="string">&#x27;paths&#x27;</span>&gt;, options?: <span class="title class_">SwaggerDocumentOptions</span>): <span class="title class_">OpenAPIObject</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">loadPluginMetadata</span>(<span class="attr">metadataFn</span>: <span class="function">() =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt;): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> serveStatic;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> serveDocuments;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">setup</span>(<span class="attr">path</span>: <span class="built_in">string</span>, <span class="attr">app</span>: <span class="title class_">INestApplication</span>, <span class="attr">documentOrFactory</span>: <span class="title class_">OpenAPIObject</span> | (<span class="function">() =&gt;</span> <span class="title class_">OpenAPIObject</span>), options?: <span class="title class_">SwaggerCustomOptions</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">OperationIdFactory</span> = <span class="function">(<span class="params">controllerKey: <span class="built_in">string</span>, methodKey: <span class="built_in">string</span>, version?: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">string</span>;</span><br><span class="line"><span class="comment">// 文档选项，createDocument()方法的第三个参数</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SwaggerDocumentOptions</span> &#123;</span><br><span class="line">  include?: <span class="title class_">Function</span>[]; <span class="comment">// 要包含在规范中的模块列表</span></span><br><span class="line">  extraModels?: <span class="title class_">Function</span>[]; <span class="comment">// 额外的模型，应该被检查并包含在规范中</span></span><br><span class="line">  ignoreGlobalPrefix?: <span class="built_in">boolean</span>; <span class="comment">// 如果为 `true`，Swagger 将忽略通过 `setGlobalPrefix()` 方法设置的全局前缀</span></span><br><span class="line">  deepScanRoutes?: <span class="built_in">boolean</span>; <span class="comment">// 如果为 `true`，Swagger 还将从 `include` 模块导入的模块中加载路由</span></span><br><span class="line">  operationIdFactory?: <span class="title class_">OperationIdFactory</span>; <span class="comment">// 用于生成操作 ID 的工厂函数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 设置选项，setup()方法的第四个参数</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SwaggerCustomOptions</span> &#123;</span><br><span class="line">  useGlobalPrefix?: <span class="built_in">boolean</span>;</span><br><span class="line">  explorer?: <span class="built_in">boolean</span>;</span><br><span class="line">  swaggerOptions?: <span class="title class_">SwaggerUiOptions</span>;</span><br><span class="line">  customCss?: <span class="built_in">string</span>;</span><br><span class="line">  customCssUrl?: <span class="built_in">string</span> | <span class="built_in">string</span>[];</span><br><span class="line">  customJs?: <span class="built_in">string</span> | <span class="built_in">string</span>[];</span><br><span class="line">  customJsStr?: <span class="built_in">string</span> | <span class="built_in">string</span>[];</span><br><span class="line">  customfavIcon?: <span class="built_in">string</span>;</span><br><span class="line">  customSwaggerUiPath?: <span class="built_in">string</span>;</span><br><span class="line">  swaggerUrl?: <span class="built_in">string</span>;</span><br><span class="line">  customSiteTitle?: <span class="built_in">string</span>;</span><br><span class="line">  validatorUrl?: <span class="built_in">string</span>;</span><br><span class="line">  url?: <span class="built_in">string</span>;</span><br><span class="line">  urls?: <span class="title class_">Record</span>&lt;<span class="string">&#x27;url&#x27;</span> | <span class="string">&#x27;name&#x27;</span>, <span class="built_in">string</span>&gt;[];</span><br><span class="line">  jsonDocumentUrl?: <span class="built_in">string</span>;</span><br><span class="line">  yamlDocumentUrl?: <span class="built_in">string</span>;</span><br><span class="line">  patchDocumentOnRequest?: <span class="language-xml"><span class="tag">&lt;<span class="name">TRequest</span> = <span class="string">any,</span> <span class="attr">TResponse</span> = <span class="string">any</span>&gt;</span>(req: TRequest, res: TResponse, document: OpenAPIObject) =&gt; OpenAPIObject;</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Swagger 提供了许多 <code>@Api*()</code> 装饰器，用于描述 API，在Swagger UI中显示。</p>
<p>下面是常用的装饰器简介。<a target="_blank" rel="noopener" href="https://docs.nestjs.com/openapi/introduction">详细文档</a></p>
<h2 id="ApiTags分组"><a href="#ApiTags分组" class="headerlink" title="ApiTags分组"></a>ApiTags分组</h2><p><code>@ApiTags()</code> 将控制器、路由方法分组。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiTags</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ApiOperation描述路由"><a href="#ApiOperation描述路由" class="headerlink" title="ApiOperation描述路由"></a>ApiOperation描述路由</h2><p><code>@ApiOperation()</code> 描述路由方法。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(&#123;</span><br><span class="line">  <span class="attr">summary</span>: <span class="string">&#x27;创建登录&#x27;</span>, <span class="comment">// 接口简介</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;创建登录&#x27;</span>, <span class="comment">// 接口描述</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="描述参数"><a href="#描述参数" class="headerlink" title="描述参数"></a>描述参数</h2><p>有一些装饰器用于描述路由方法的参数，也就是接口所需的参数。作用于路由方法。</p>
<ol>
<li><code>@ApiParam()</code> 描述动态路由参数。</li>
<li><code>@ApiQuery()</code> 描述查询字符串参数。</li>
<li><code>@ApiBody()</code> 描述请求体参数。</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ApiParam描述动态路由参数</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@ApiParam</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;id&#x27;</span>, <span class="comment">// 参数名</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;用户id&#x27;</span>, <span class="comment">// 参数描述</span></span><br><span class="line">  <span class="attr">required</span>: <span class="literal">true</span>, <span class="comment">// 是否必须</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">findOne</span>(<span class="params"><span class="meta">@Param</span>(<span class="string">&#x27;id&#x27;</span>, ParseIntPipe) id: <span class="built_in">number</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ApiQuery描述查询字符串参数</span></span><br><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@ApiQuery</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;page&#x27;</span>, <span class="comment">// 参数名</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;页码&#x27;</span>, <span class="comment">// 参数描述</span></span><br><span class="line">  <span class="attr">required</span>: <span class="literal">false</span>, <span class="comment">// 是否必须</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&#x27;page&#x27;</span>, <span class="keyword">new</span> DefaultValuePipe(<span class="number">0</span>), ParseIntPipe) page: <span class="built_in">number</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ApiBody描述请求体参数</span></span><br><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@ApiBody</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">CreateLoginDto</span>, <span class="comment">// 请求体类型</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">create</span>(<span class="params"><span class="meta">@Body</span>() createLoginDto: CreateLoginDto</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ApiProperty描述属性"><a href="#ApiProperty描述属性" class="headerlink" title="ApiProperty描述属性"></a>ApiProperty描述属性</h2><p>在Nest中使用DTO来约束、验证请求体的结构。使用 <code>@ApiProperty()</code> 描述DTO的属性。</p>
<p><strong>ApiBody</strong>和<strong>ApiProperty</strong>共同完成请求体的描述。有些时候<strong>ApiBody</strong>可以省略。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CreateLoginDto</span> &#123;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;用户名&#x27;</span>, <span class="comment">// 属性描述</span></span><br><span class="line">    <span class="attr">example</span>: <span class="string">&#x27;user1&#x27;</span>, <span class="comment">// 示例</span></span><br><span class="line">    <span class="attr">minLength</span>: <span class="number">3</span>, <span class="comment">// 最小长度</span></span><br><span class="line">    <span class="attr">maxLength</span>: <span class="number">10</span>, <span class="comment">// 最大长度</span></span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span>, <span class="comment">// 是否必填</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@IsNotEmpty</span>() <span class="comment">// 验证是否为空</span></span><br><span class="line">  <span class="meta">@IsString</span>() <span class="comment">// 验证是否为字符串</span></span><br><span class="line">  <span class="meta">@Length</span>(<span class="number">3</span>, <span class="number">10</span>, &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;用户名长度必须为3到10位&#x27;</span>, <span class="comment">// 自定义错误信息</span></span><br><span class="line">  &#125;) <span class="comment">// 验证字符串长度</span></span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">    <span class="attr">example</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="meta">@IsNotEmpty</span>()</span><br><span class="line">  <span class="meta">@IsString</span>()</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>@ApiProperty()</code> 可以设置属性的描述、示例、必填等信息，但对每个属性手动添加 <code>@ApiProperty()</code> 过于繁琐，且与 <code>class-validator</code> 的验证装饰器的意义重复。一旦拥有大量的DTO类，代码会变得冗长且难以维护。</p>
<p>Nest提供了<a target="_blank" rel="noopener" href="http://nestjs.inode.club/openapi/cli-plugin">CLI插件</a>(Swagger插件)与 <code>class-validator</code> 结合使用，自动生成DTO描述。而无需手动添加 <code>@ApiProperty()</code>。</p>
<h2 id="CLI插件"><a href="#CLI插件" class="headerlink" title="CLI插件"></a>CLI插件</h2><p><a target="_blank" rel="noopener" href="http://nestjs.inode.club/openapi/cli-plugin">CLI插件</a>(Swagger插件)将自动执行以下操作：</p>
<ol>
<li>除非使用<code>@ApiHideProperty</code>，否则会对所有DTO属性进行注解，使用<code>@ApiProperty</code>。</li>
<li>根据问号（例如 name?: string）设置required属性（将设置为false）。</li>
<li>根据类型设置type或enum属性（还支持数组）。</li>
<li>根据分配的默认值设置default属性。</li>
<li>根据<code>class-validator</code>装饰器设置多个验证规则（如果将<code>classValidatorShim</code>设置为true）。</li>
<li>为每个具有适当状态和type（响应模型）的端点添加响应装饰器。</li>
<li>根据注释为属性和端点生成描述（如果将<code>introspectComments</code>设置为true）。</li>
<li>根据注释为属性生成示例值（如果将<code>introspectComments</code>设置为true）。</li>
</ol>
<p>修改 <code>nest-cli.json</code> 配置文件，启用插件。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@nestjs/swagger&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;classValidatorShim&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;introspectComments&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>options</code>属性用于自定义插件的行为。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">PluginOptions</span> &#123;</span><br><span class="line">  dtoFileNameSuffix?: <span class="built_in">string</span>[]; <span class="comment">// DTO文件名后缀</span></span><br><span class="line">  controllerFileNameSuffix?: <span class="built_in">string</span>[]; <span class="comment">// 控制器文件名后缀</span></span><br><span class="line">  classValidatorShim?: <span class="built_in">boolean</span>; <span class="comment">// 配合class-validator</span></span><br><span class="line">  dtoKeyOfComment?: <span class="built_in">string</span>; <span class="comment">// DTO注释的键名</span></span><br><span class="line">  controllerKeyOfComment?: <span class="built_in">string</span>; <span class="comment">// 控制器注释的键名</span></span><br><span class="line">  introspectComments?: <span class="built_in">boolean</span>; <span class="comment">// 是否解析注释</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启用注释自省<code>introspectComments</code>功能后，CLI插件将根据注释为属性生成描述和示例值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span> <span class="variable">user1</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">  <span class="attr">description</span>: <span class="string">`用户名`</span>,</span><br><span class="line">  <span class="attr">example</span>: <span class="string">&#x27;user1&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>一些注意事项：</strong></p>
<ol>
<li>文件名必须为 <code>.dto.ts</code> 或 <code>.entity.ts</code> 后缀，以便插件识别。也可以通过<code>dtoFileNameSuffix</code>自定义后缀名。</li>
<li>在更新插件选项时，请确保删除dist文件夹并重新构建应用程序。</li>
<li>即使启用了插件，仍然可以手动添加<code>@ApiProperty()</code>装饰器，以<strong>扩展</strong>或<strong>覆盖</strong>插件生成的描述。这对于添加描述和示例值非常有用。</li>
<li>在DTO中使用映射类型工具（例如<code>PartialType</code>）时，应该从<code>@nestjs/swagger</code>导入，而不是<code>@nestjs/mapped-types</code>，以便插件能够获取模式信息。</li>
<li>如果不使用CLI，而是使用自定义的webpack配置，可以将此插件与<code>ts-loader</code>结合使用</li>
</ol>
<h2 id="ApiResponse描述响应"><a href="#ApiResponse描述响应" class="headerlink" title="ApiResponse描述响应"></a>ApiResponse描述响应</h2><p><code>@ApiResponse()</code> 描述路由方法的响应。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiResponse</span>(&#123;</span><br><span class="line">  <span class="attr">status</span>: <span class="number">200</span>, <span class="comment">// 状态码</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;成功&#x27;</span>, <span class="comment">// 响应描述</span></span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">String</span>, <span class="comment">// 响应体类型</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Nest提供了一些简写的API响应装饰器，它们都继承自<code>@ApiResponse</code>装饰器</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOkResponse</span>()</span><br><span class="line"><span class="meta">@ApiCreatedResponse</span>()</span><br><span class="line"><span class="meta">@ApiAcceptedResponse</span>()</span><br><span class="line"><span class="meta">@ApiNoContentResponse</span>()</span><br><span class="line"><span class="meta">@ApiMovedPermanentlyResponse</span>()</span><br><span class="line"><span class="meta">@ApiFoundResponse</span>()</span><br><span class="line"><span class="meta">@ApiBadRequestResponse</span>()</span><br><span class="line"><span class="meta">@ApiUnauthorizedResponse</span>()</span><br><span class="line"><span class="meta">@ApiNotFoundResponse</span>()</span><br><span class="line"><span class="meta">@ApiForbiddenResponse</span>()</span><br><span class="line"><span class="meta">@ApiMethodNotAllowedResponse</span>()</span><br><span class="line"><span class="meta">@ApiNotAcceptableResponse</span>()</span><br><span class="line"><span class="meta">@ApiRequestTimeoutResponse</span>()</span><br><span class="line"><span class="meta">@ApiConflictResponse</span>()</span><br><span class="line"><span class="meta">@ApiPreconditionFailedResponse</span>()</span><br><span class="line"><span class="meta">@ApiTooManyRequestsResponse</span>()</span><br><span class="line"><span class="meta">@ApiGoneResponse</span>()</span><br><span class="line"><span class="meta">@ApiPayloadTooLargeResponse</span>()</span><br><span class="line"><span class="meta">@ApiUnsupportedMediaTypeResponse</span>()</span><br><span class="line"><span class="meta">@ApiUnprocessableEntityResponse</span>()</span><br><span class="line"><span class="meta">@ApiInternalServerErrorResponse</span>()</span><br><span class="line"><span class="meta">@ApiNotImplementedResponse</span>()</span><br><span class="line"><span class="meta">@ApiBadGatewayResponse</span>()</span><br><span class="line"><span class="meta">@ApiServiceUnavailableResponse</span>()</span><br><span class="line"><span class="meta">@ApiGatewayTimeoutResponse</span>()</span><br><span class="line"><span class="meta">@ApiDefaultResponse</span>()</span><br></pre></td></tr></table></figure>
<p>要为请求指定返回模型，必须创建一个DTO类，并将其传递给 <code>type</code> 属性。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CreateLoginResDto</span> &#123;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;用户名&#x27;</span>, <span class="comment">// 属性描述</span></span><br><span class="line">    <span class="attr">example</span>: <span class="string">&#x27;user1&#x27;</span>, <span class="comment">// 示例</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@ApiProperty</span>(&#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;消息&#x27;</span>,</span><br><span class="line">    <span class="attr">example</span>: <span class="string">&#x27;登陆成功&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="attr">message</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiResponse</span>(&#123;</span><br><span class="line">  <span class="attr">status</span>: <span class="number">200</span>, <span class="comment">// 状态码</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;成功&#x27;</span>, <span class="comment">// 响应描述</span></span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">CreateLoginResDto</span>, <span class="comment">// 响应类型</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="ApiHeader描述请求头"><a href="#ApiHeader描述请求头" class="headerlink" title="ApiHeader描述请求头"></a>ApiHeader描述请求头</h2><p><code>@ApiHeader()</code> 描述请求头。<code>@ApiHeaders()</code> 传入数组，描述多个请求头。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiHeader</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Authorization&#x27;</span>, <span class="comment">// 请求头名称</span></span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;token&#x27;</span>, <span class="comment">// 请求头描述</span></span><br><span class="line">  <span class="attr">required</span>: <span class="literal">true</span>, <span class="comment">// 是否必须</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="全局参数"><a href="#全局参数" class="headerlink" title="全局参数"></a>全局参数</h2><p><code>addGlobalParameters()</code> 添加全局参数，它们将出现在每个路由方法的参数中。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addGlobalParameters</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Authorization&#x27;</span>,</span><br><span class="line">  <span class="attr">description</span>: <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">  <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">in</span>: <span class="string">&#x27;header&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="安全机制"><a href="#安全机制" class="headerlink" title="安全机制"></a>安全机制</h2><p><code>@ApiSecurity()</code> 定义特定操作应使用的安全机制</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiSecurity</span>(<span class="string">&#x27;basic&#x27;</span>)</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>需要提前在 <code>DocumentBuilder</code> 中配置安全机制。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addSecurity</span>(<span class="string">&#x27;basic&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;http&#x27;</span>,</span><br><span class="line">  <span class="attr">scheme</span>: <span class="string">&#x27;basic&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>一些常用的身份验证机制是内置的，而不必手动定义，如<code>basic</code>、<code>bearer</code>等。</p>
<ol>
<li><code>@ApiBasicAuth()</code> 基本身份验证</li>
<li><code>@ApiBearerAuth()</code> Bearer身份验证</li>
<li><code>@ApiOAuth2()</code> OAuth2身份验证</li>
<li><code>@ApiCookieAuth()</code> Cookie身份验证</li>
</ol>
<p>还需要在 <code>DocumentBuilder</code> 中添加安全定义。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiBasicAuth</span>()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addBasicAuth</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiBearerAuth</span>()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addBearerAuth</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOAuth2</span>([<span class="string">&#x27;pets:write&#x27;</span>])</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addOAuth2</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiCookieAuth</span>()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">DocumentBuilder</span>().<span class="title function_">addCookieAuth</span>(<span class="string">&#x27;optional-session-id&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h1 id="swagger-typescript-api"><a href="#swagger-typescript-api" class="headerlink" title="swagger-typescript-api"></a>swagger-typescript-api</h1><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/swagger-typescript-api">swagger-typescript-api</a> 可以根据 Swagger 规范生成接口的 TS 类型和axios/fetch请求函数。</p>
<p>该库提供了全局命令行工具，也可以导入为模块，使用 <code>generateApi</code> 方法生成接口文件。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">  <span class="keyword">await</span> app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line">  <span class="comment">// 生成接口</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">generateApi</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;api.ts&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: <span class="title function_">resolve</span>(process.<span class="title function_">cwd</span>(), <span class="string">&#x27;./api&#x27;</span>),</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://localhost:3000/api-json&#x27;</span>,</span><br><span class="line">    <span class="attr">httpClientType</span>: <span class="string">&#x27;axios&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">bootstrap</span>();</span><br></pre></td></tr></table></figure>
<p>生成的接口文件：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable */</span></span><br><span class="line"><span class="comment">/* tslint:disable */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * ## THIS FILE WAS GENERATED VIA SWAGGER-TYPESCRIPT-API        ##</span></span><br><span class="line"><span class="comment"> * ##                                                           ##</span></span><br><span class="line"><span class="comment"> * ## AUTHOR: acacode                                           ##</span></span><br><span class="line"><span class="comment"> * ## SOURCE: https://github.com/acacode/swagger-typescript-api ##</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CreateLoginDto</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@minLength</span> 3</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@maxLength</span> 10</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ......省略</span></span><br></pre></td></tr></table></figure>
<h1 id="JWT-token"><a href="#JWT-token" class="headerlink" title="JWT token"></a>JWT token</h1><p>一个通用的后端通常使用JWT（JSON Web Token）进行会话控制、身份验证。至于session，详见<a href="/article/7c45abd.html#session案例">session案例</a></p>
<p><a href="/article/a1e193d6.html#token">NodeJS接口、会话控制-token</a>、<a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">JSON Web Token 入门教程-阮一峰</a></p>
<p><strong>流程：</strong>服务端登陆接口验证账号密码，签发token，客户端携带token访问受保护的资源，服务端通过守卫验证token，放行受保护的路由。在token中保存角色身份，以实现基于角色的鉴权。</p>
<h2 id="在Nest中使用JWT"><a href="#在Nest中使用JWT" class="headerlink" title="在Nest中使用JWT"></a>在Nest中使用JWT</h2><p>安装 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@nestjs/jwt">@nestjs/jwt</a> 用于生成和验证JWT。<a target="_blank" rel="noopener" href="https://docs.nestjs.com/security/authentication">文档</a></p>
<p><code>JwtModule</code> 用于配置JWT。</p>
<figure class="highlight ts"><figcaption><span>src\auth\auth.module.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">JwtModule</span>.<span class="title function_">register</span>(&#123;</span><br><span class="line">      <span class="attr">global</span>: <span class="literal">true</span>, <span class="comment">// 全局模块</span></span><br><span class="line">      <span class="attr">secret</span>: <span class="string">&#x27;123456&#x27;</span>, <span class="comment">// 密钥，应该由环境变量或配置文件提供</span></span><br><span class="line">      <span class="comment">// 签名选项</span></span><br><span class="line">      <span class="attr">signOptions</span>: &#123;</span><br><span class="line">        <span class="attr">expiresIn</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>, <span class="comment">// 过期时间</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AuthController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AuthService</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">AuthService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><code>JwtService</code> 用于生成和验证JWT</p>
<ol>
<li><code>JwtService.sign()</code> 生成JWT，Async为异步方法</li>
<li><code>JwtService.verify()</code> 验证JWT</li>
</ol>
<p>在 <code>AuthService</code> 中使用 <code>sign()</code> 生成token，将用户名、角色、id等信息保存在token中。使用 <code>verify()</code> 验证token。</p>
<figure class="highlight ts"><figcaption><span>src\auth\auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> jwtService: JwtService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">signIn</span>(<span class="params">user: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123;</span><br><span class="line">      <span class="attr">username</span>: user.<span class="property">username</span>, <span class="comment">// 用户名</span></span><br><span class="line">      <span class="attr">id</span>: user.<span class="property">userId</span>, <span class="comment">// 用户id</span></span><br><span class="line">      <span class="attr">role</span>: user.<span class="property">role</span>, <span class="comment">// 用户角色</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">access_token</span>: <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">signAsync</span>(payload),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">verifyToken</span>(<span class="params">token: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verifyAsync</span>(token, &#123;</span><br><span class="line">      <span class="comment">// 密钥，与JwtModule.register中的secret一致</span></span><br><span class="line">      <span class="comment">// 应该从环境变量或配置文件中获取</span></span><br><span class="line">      <span class="attr">secret</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试登陆接口，获取token。实际应该通过账号密码，验证成功后生成token。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;testLogin&#x27;</span>)</span><br><span class="line"><span class="title function_">testLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">signIn</span>(&#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;user1&#x27;</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">role</span>: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI...&quot;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p>生成后的token一般由客户端保存在本地，每次请求时携带token，以一定格式放在请求头 <code>Authorization</code> 字段中。</p>
<figure class="highlight txt"><figcaption><span>token放在请求头中</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsI....</span><br></pre></td></tr></table></figure>
<p>在 <code>AuthGuard</code> 守卫中调用 <code>AuthService.verifyToken()</code> 验证token。<br>并将用户信息存入请求对象，以便后续守卫(角色鉴权)、路由(获取用户信息)等使用。</p>
<figure class="highlight ts"><figcaption><span>src\auth\auth.guard.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthGuard</span> <span class="keyword">implements</span> <span class="title class_">CanActivate</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> authService: AuthService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">canActivate</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> request = context.<span class="title function_">switchToHttp</span>().<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> token = <span class="variable language_">this</span>.<span class="title function_">extractTokenFromHeader</span>(request);</span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 验证token</span></span><br><span class="line">      <span class="keyword">const</span> payload = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">authService</span>.<span class="title function_">verifyToken</span>(token);</span><br><span class="line">      <span class="comment">// 将用户信息存入请求对象，以便路由等使用</span></span><br><span class="line">      request[<span class="string">&#x27;user&#x27;</span>] = payload;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从请求头中提取token</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">extractTokenFromHeader</span>(<span class="attr">request</span>: <span class="title class_">Request</span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [<span class="keyword">type</span>, token] = request.<span class="title function_">get</span>(<span class="string">&#x27;authorization&#x27;</span>)?.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>) ?? [];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">type</span> === <span class="string">&#x27;Bearer&#x27;</span> ? token : <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试受保护的路由</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiBearerAuth</span>()</span><br><span class="line"><span class="meta">@UseGuards</span>(<span class="title class_">AuthGuard</span>)</span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line"><span class="title function_">list</span>(<span class="params"><span class="meta">@Req</span>() req: Request</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">  <span class="comment">// &#123;</span></span><br><span class="line">  <span class="comment">//   username: &#x27;user1&#x27;,</span></span><br><span class="line">  <span class="comment">//   id: 1,</span></span><br><span class="line">  <span class="comment">//   role: &#x27;admin&#x27;,</span></span><br><span class="line">  <span class="comment">//   iat: 1708243192,</span></span><br><span class="line">  <span class="comment">//   exp: 1708329592</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;list&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="config配置"><a href="#config配置" class="headerlink" title="config配置"></a>config配置</h1><p>一些关键的信息如jwt的加密密钥、数据库链接等，应该通过配置提供，而不是硬编码，<a target="_blank" rel="noopener" href="https://12factor.net/config">12-Factor应用原则</a></p>
<p>在Node中，可以使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/dotenv">dotenv</a>，将环境变量保存在<code>.env</code>文件中，通过<code>process.env</code>读取。</p>
<p>Nest提供了更好的做法，导入 <code>ConfigModule</code> 模块，使用 <code>ConfigService</code> 服务，该服务加载适当的 <code>.env</code> 文件，这样一个通用的配置模块Nest已经提供了<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@nestjs/config">@nestjs/config</a>，其底层也使用了<strong>dotenv</strong>。<a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/configuration">文档</a></p>
<p><strong>安装：</strong><code>npm i -S @nestjs/config</code></p>
<p>键冲突：当一个键同时存在于运行时环境变量和 .env 文件中时，运行时环境变量优先。</p>
<h2 id="使用ConfigModule"><a href="#使用ConfigModule" class="headerlink" title="使用ConfigModule"></a>使用ConfigModule</h2><p><code>ConfigModule</code> 模块用于加载配置文件，通常导入到根模块中，并设为全局模块。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">forRoot</span>(options?: <span class="title class_">ConfigModuleOptions</span>): <span class="title class_">DynamicModule</span>;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ConfigModuleOptions</span> &#123;</span><br><span class="line">  cache?: <span class="built_in">boolean</span>; <span class="comment">// 缓存环境变量</span></span><br><span class="line">  isGlobal?: <span class="built_in">boolean</span>; <span class="comment">// 全局模块</span></span><br><span class="line">  ignoreEnvFile?: <span class="built_in">boolean</span>; <span class="comment">// 忽略环境变量文件，只使用运行时环境变量</span></span><br><span class="line">  ignoreEnvVars?: <span class="built_in">boolean</span>; <span class="comment">// 忽略所有环境变量</span></span><br><span class="line">  envFilePath?: <span class="built_in">string</span> | <span class="built_in">string</span>[]; <span class="comment">// 环境变量文件</span></span><br><span class="line">  validate?: <span class="function">(<span class="params">config: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;</span>) =&gt;</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;; <span class="comment">// 自定义验证环境变量</span></span><br><span class="line">  validationSchema?: <span class="built_in">any</span>; <span class="comment">// 模式验证</span></span><br><span class="line">  validationOptions?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;; <span class="comment">// 配置验证选项</span></span><br><span class="line">  load?: <span class="title class_">Array</span>&lt;<span class="title class_">ConfigFactory</span>&gt;; <span class="comment">// 自定义加载配置文件</span></span><br><span class="line">  expandVariables?: <span class="built_in">boolean</span> | <span class="title class_">DotenvExpandOptions</span>; <span class="comment">// 扩展变量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该模块使用 <code>forRoot()</code> 静态方法来控制其行为。</p>
<ol>
<li><code>isGlobal</code> 是否全局模块</li>
<li><code>envFilePath</code> 环境变量文件</li>
<li><code>ignoreEnvFile</code> 忽略环境变量文件</li>
<li><code>load</code> 自定义加载配置文件</li>
<li><code>expandVariables</code> 扩展变量</li>
<li><code>cache</code> 缓存环境变量</li>
<li><code>validationSchema</code> 模式验证</li>
<li><code>validationOptions</code> 配置验证选项</li>
<li><code>validate</code> 自定义验证环境变量</li>
</ol>
<figure class="highlight ts"><figcaption><span>配置案例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> configuration <span class="keyword">from</span> <span class="string">&#x27;./configuration&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">ConfigModule</span>.<span class="title function_">forRoot</span>(&#123;</span><br><span class="line">      <span class="attr">isGlobal</span>: <span class="literal">true</span>, <span class="comment">// 全局模块</span></span><br><span class="line">      <span class="attr">envFilePath</span>: <span class="string">&#x27;.env&#x27;</span>, <span class="comment">// 环境变量文件</span></span><br><span class="line">      <span class="comment">// ignoreEnvFile: true, // 忽略环境变量文件</span></span><br><span class="line">      <span class="attr">load</span>: [configuration], <span class="comment">// 自定义加载配置文件</span></span><br><span class="line">      <span class="attr">expandVariables</span>: <span class="literal">true</span>, <span class="comment">// 扩展变量，允许在.env文件中嵌套变量</span></span><br><span class="line">      <span class="attr">cache</span>: <span class="literal">true</span>, <span class="comment">// 缓存环境变量</span></span><br><span class="line">      <span class="comment">// validationSchema: Joi.object(&#123;&#125;), // 模式验证</span></span><br><span class="line">      <span class="comment">// 配置验证选项</span></span><br><span class="line">      <span class="attr">validationOptions</span>: &#123;</span><br><span class="line">        <span class="attr">allowUnknown</span>: <span class="literal">false</span>, <span class="comment">// 是否允许环境变量中存在未知的键</span></span><br><span class="line">        <span class="attr">abortEarly</span>: <span class="literal">true</span>, <span class="comment">// 早期中止, 一旦发现错误就停止验证</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 自定义验证，传入配置对象，返回配置对象</span></span><br><span class="line">      <span class="title function_">validate</span>(<span class="params">config</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="env相关选项"><a href="#env相关选项" class="headerlink" title="env相关选项"></a>env相关选项</h3><p><code>envFilePath</code> 用于指定环境变量文件，<code>string | string[]</code>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">envFilePath</span>: <span class="string">&#x27;.development.env&#x27;</span>,</span><br><span class="line"><span class="attr">envFilePath</span>: [<span class="string">&#x27;.env.development.local&#x27;</span>, <span class="string">&#x27;.env.development&#x27;</span>],</span><br></pre></td></tr></table></figure>
<p><code>ignoreEnvFile</code> 忽略环境变量文件，只使用运行时环境变量。<br><code>ignoreEnvVars</code> 忽略所有环境变量。</p>
<p><code>expandVariables</code> 启用扩展变量，允许在env文件中嵌套变量。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APP_URL=mywebsite.com</span><br><span class="line">SUPPORT_EMAIL=support@$&#123;APP_URL&#125; # &#x27;support@mywebsite.com&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="自定义配置文件"><a href="#自定义配置文件" class="headerlink" title="自定义配置文件"></a>自定义配置文件</h3><p><code>load</code> 用于自定义加载配置文件，值为 <code>ConfigFactory</code> 数组，它是一个工厂函数，返回一个配置对象。</p>
<p>在 <code>ConfigFactory</code> 中可以访问到已经解析完环境变量的 <code>process.env</code>。</p>
<figure class="highlight ts"><figcaption><span>src/configuration.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">configFactory</span> = (<span class="params"></span>) =&gt; (&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">PORT</span>, <span class="number">10</span>) || <span class="number">3000</span>,</span><br><span class="line">  <span class="attr">database</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: process.<span class="property">env</span>.<span class="property">DATABASE_HOST</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">DATABASE_PORT</span>, <span class="number">10</span>) || <span class="number">5432</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">jwt</span>: &#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="attr">expiresIn</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 导出配置类型，以便在其他地方使用，通过ReturnType获取函数返回类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Configuration</span> = <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> configFactory&gt;;</span><br><span class="line"><span class="comment">// 需要导出一个工厂函数，返回配置对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (): <span class="function"><span class="params">Configuration</span> =&gt;</span> configFactory;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configuration <span class="keyword">from</span> <span class="string">&#x27;./configuration&#x27;</span>;</span><br><span class="line"><span class="attr">load</span>: [configuration],</span><br></pre></td></tr></table></figure>
<p>配置文件除了导出一个工厂函数外，还应该导出一个配置类型，以便在其他地方使用，获得类型提示。</p>
<p><strong>注意：</strong>多个配置文件最终会合并为一个配置对象。要区分不同的配置文件，可以使用命名空间。</p>
<h3 id="配置命名空间"><a href="#配置命名空间" class="headerlink" title="配置命名空间"></a>配置命名空间</h3><p><code>load</code> 允许加载多个配置文件，每个配置文件可以返回一个对象，这些对象将被合并到一个配置对象中。</p>
<p>为了避免冲突，可以通过 <code>registerAs()</code> 为每个配置文件指定一个命名空间。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; registerAs &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">configFactory</span> = (<span class="params"></span>) =&gt; (&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">PORT</span>, <span class="number">10</span>) || <span class="number">3000</span>,</span><br><span class="line">  <span class="attr">database</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: process.<span class="property">env</span>.<span class="property">DATABASE_HOST</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">DATABASE_PORT</span>, <span class="number">10</span>) || <span class="number">5432</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">jwt</span>: &#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">    <span class="attr">expiresIn</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 导出配置类型，以便在其他地方使用，通过ReturnType获取函数返回类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Configuration</span> = <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> configFactory&gt;;</span><br><span class="line"><span class="comment">// 导出命名空间token(名称)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> configToken = <span class="string">&#x27;configuration&#x27;</span>;</span><br><span class="line"><span class="comment">// 使用registerAs为该配置文件创建一个命名空间</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">registerAs</span>(configToken, configFactory);</span><br></pre></td></tr></table></figure>
<h2 id="使用ConfigService"><a href="#使用ConfigService" class="headerlink" title="使用ConfigService"></a>使用ConfigService</h2><p><code>ConfigService</code> 服务使用 <code>get()</code> 读取配置对象中的值。</p>
<p>对于普通的 <code>ConfigFactory</code> 配置文件，可以直接获取配置对象的属性。<br>对于 <code>registerAs()</code> 创建的具有命名空间的配置，需要先获取命名空间，再获取属性，或者使用点表示法获取属性。</p>
<p>下面以jwt配置为例。将jwt的密钥通过配置对象获取。</p>
<figure class="highlight ts"><figcaption><span>src\auth\auth.service.ts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Configuration</span>, configToken &#125; <span class="keyword">from</span> <span class="string">&#x27;src/configuration&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> jwtService: JwtService,</span></span><br><span class="line"><span class="params">    <span class="comment">// 注入ConfigService</span></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="keyword">readonly</span> configService: ConfigService,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">verifyToken</span>(<span class="params">token: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">jwtService</span>.<span class="title function_">verifyAsync</span>(token, &#123;</span><br><span class="line">      <span class="comment">// 通过配置对象获取密钥</span></span><br><span class="line">      <span class="attr">secret</span>: <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="title class_">Configuration</span>&gt;(configToken).<span class="property">jwt</span>.<span class="property">secret</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 <code>JwtModule</code> 的配置，也可以通过 <code>ConfigService</code> 获取。</p>
<p>为了注入 <code>ConfigService</code>，需使用 <code>JwtModule.registerAsync()</code> 异步配置方法。<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/54308318/how-to-get-the-configurations-from-within-a-module-import-in-nestjs">问题参考</a></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JwtModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/jwt&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/config&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Configuration</span>, configToken &#125; <span class="keyword">from</span> <span class="string">&#x27;src/configuration&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">JwtModule</span>.<span class="title function_">registerAsync</span>(&#123;</span><br><span class="line">      <span class="attr">useFactory</span>: <span class="function">(<span class="params">configService: ConfigService</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">secret</span>: configService.<span class="property">get</span>&lt;<span class="title class_">Configuration</span>&gt;(configToken).<span class="property">jwt</span>.<span class="property">secret</span>,</span><br><span class="line">        <span class="attr">signOptions</span>: &#123;</span><br><span class="line">          <span class="attr">expiresIn</span>:</span><br><span class="line">            configService.<span class="property">get</span>&lt;<span class="title class_">Configuration</span>&gt;(configToken).<span class="property">jwt</span>.<span class="property">expiresIn</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="attr">inject</span>: [<span class="title class_">ConfigService</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AuthController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AuthService</span>],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="title class_">AuthService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AuthModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><code>get()</code> 方法还可以接收第二个参数，用于定义默认值。当键不存在时，将返回该默认值。</p>
<p><code>ConfigService</code> 可以接收两个泛型</p>
<ol>
<li>第一个泛型用于防止访问不存在的配置属性</li>
<li>第二个泛型为boolean，以消除tsconfig选项 <code>strictNullChecks</code> 打开时，可能返回的所有undefined类型</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">EnvironmentVariables</span> &#123;</span><br><span class="line">  <span class="attr">PORT</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">TIMEOUT</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> configService: ConfigService&lt;EnvironmentVariables&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> port = <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="title function_">get</span>(<span class="string">&#x27;PORT&#x27;</span>, &#123; <span class="attr">infer</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  <span class="comment">// infer: true 根据接口自动推断属性的类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="validate验证环境变量"><a href="#validate验证环境变量" class="headerlink" title="validate验证环境变量"></a>validate验证环境变量</h2><p><code>validate(config)</code> 是<strong>同步</strong>的，<strong>参数为所有环境变量</strong>，用于验证所需的环境变量是否符合某些验证规则，防止预期之外的环境变量值被传入配置对象。</p>
<p>与自定义类验证管道类似，使用 <code>class-validator</code> 和 <code>class-transformer</code> 库。</p>
<figure class="highlight ts"><figcaption><span>编写验证类和验证函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; plainToInstance &#125; <span class="keyword">from</span> <span class="string">&#x27;class-transformer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IsDefined</span>, <span class="title class_">IsNumber</span>, <span class="title class_">IsString</span>, validateSync &#125; <span class="keyword">from</span> <span class="string">&#x27;class-validator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnvironmentVariables</span> &#123;</span><br><span class="line">  <span class="meta">@IsNumber</span>()</span><br><span class="line">  <span class="variable constant_">PORT</span>?: <span class="built_in">number</span>;</span><br><span class="line">  <span class="meta">@IsString</span>()</span><br><span class="line">  <span class="meta">@IsDefined</span>()</span><br><span class="line">  <span class="attr">DATABASE_HOST</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="meta">@IsNumber</span>()</span><br><span class="line">  <span class="variable constant_">DATABASE_PORT</span>?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">validate</span>(<span class="params">config: Record&lt;<span class="built_in">string</span>, unknown&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> validatedConfig = <span class="title function_">plainToInstance</span>(<span class="title class_">EnvironmentVariables</span>, config, &#123;</span><br><span class="line">    <span class="attr">enableImplicitConversion</span>: <span class="literal">true</span>, <span class="comment">// 启用隐式转换，这对于环境变量来说是必要的</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> errors = <span class="title function_">validateSync</span>(validatedConfig, &#123;</span><br><span class="line">    <span class="attr">skipMissingProperties</span>: <span class="literal">true</span>, <span class="comment">// 是否跳过缺失的属性，关闭后所有所需的环境变量都必须存在</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errors.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errors.<span class="title function_">toString</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> validatedConfig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为 <code>validate()</code> 是<strong>同步</strong>的，所以必须使用 <code>validateSync()</code> 同步方法。</p>
<figure class="highlight ts"><figcaption><span>应用验证函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; validate &#125; <span class="keyword">from</span> <span class="string">&#x27;./config.validation&#x27;</span>;</span><br><span class="line"><span class="title class_">ConfigModule</span>.<span class="title function_">forRoot</span>(&#123;</span><br><span class="line">  validate,</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p>若验证失败，则会直接抛出错误，并终止应用程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Error: An instance of EnvironmentVariables has failed the validation:    </span><br><span class="line"> - property NODE_ENV has failed the following constraints: isEnum        </span><br><span class="line">,An instance of EnvironmentVariables has failed the validation:</span><br><span class="line"> - property PORT has failed the following constraints: isNumber</span><br><span class="line">,An instance of EnvironmentVariables has failed the validation:</span><br><span class="line"> - property DATABASE_HOST has failed the following constraints: isNumber </span><br><span class="line">,An instance of EnvironmentVariables has failed the validation:</span><br><span class="line"> - property DATABASE_PORT has failed the following constraints: isNumber</span><br></pre></td></tr></table></figure>
<h2 id="在main中使用"><a href="#在main中使用" class="headerlink" title="在main中使用"></a>在main中使用</h2><p>在 <code>main.ts</code> 中通过 <code>app.get()</code> 获取已存在的 <code>ConfigService</code> 实例引用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> configService = app.<span class="title function_">get</span>(<span class="title class_">ConfigService</span>);</span><br><span class="line"><span class="keyword">await</span> app.<span class="title function_">listen</span>(configService.<span class="property">get</span>&lt;<span class="title class_">Configuration</span>&gt;(configToken).<span class="property">port</span>);</span><br></pre></td></tr></table></figure>
<h2 id="局部注册配置文件"><a href="#局部注册配置文件" class="headerlink" title="局部注册配置文件"></a>局部注册配置文件</h2><p>一些配置文件可能只在特定模块中使用，可以使用 <code>forFeature()</code> 方法注册配置文件。而不必将所有配置文件都在 <code>forRoot()</code> 中注册。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">registerAs</span>(<span class="string">&#x27;db&#x27;</span>, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">  <span class="attr">s1</span>: <span class="number">222</span>,</span><br><span class="line">  <span class="attr">s2</span>: <span class="number">111</span>,</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dbConfig <span class="keyword">from</span> <span class="string">&#x27;./db.configuration&#x27;</span>;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">ConfigModule</span>.<span class="title function_">forFeature</span>(dbConfig)],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DbModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在该模块的控制器中访问配置。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">configService</span>.<span class="title function_">get</span>(<span class="string">&#x27;db&#x27;</span>).<span class="property">s1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">dbService</span>.<span class="title function_">findAll</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>统一注册和局部注册<strong>效果是差不多的</strong>，都能在所需的地方通过注入 <code>ConfigService</code> 来访问，只是局部注册需要注意模块依赖和模块的初始化顺序。</p>
<p>若在<strong>依赖该模块</strong>的模块中访问局部注册的配置，可能需要使用 <code>onModuleInit()</code> 钩子，而不是在构造函数中，因为 <code>forFeature()</code> 方法在模块初始化期间运行，而模块初始化的顺序是不确定的，这些配置所依赖的模块可能尚未初始化。<code>onModuleInit()</code> 方法仅在所有依赖的模块都已初始化后才运行，因此是安全的。</p>
<blockquote>
<p>所以配置文件不是太多的话，还是统一注册比较方便。</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>NestJS[三]-进阶</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.qcqx.cn/article/73b2ab6d.html">https://www.qcqx.cn/article/73b2ab6d.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>轻笑Chuckle</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-02-17</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-02-17</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/NestJS/">NestJS</a><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a></div><div class="post_share"></div></div><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂[点击投币]</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/weixin.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/blog/pay/weixin.webp" alt="微信" loading="lazy"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/blog/pay/alipay.webp" alt="支付宝" loading="lazy"/></a><div class="post-qr-code-desc">支付宝</div></li><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">一个博客 一叶孤舟 一方世界</div></a></ul></div></button></div><script defer="defer" src="https://qxchuckle.github.io/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/e18aeaaa.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/77-0.webp" onerror="onerror=null;src='https://qxchuckle.github.io/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">⇦上一篇</div><div class="prev_info">NestJS[四]-数据库</div></div></a></div><div class="next-post pull-right"><a href="/article/c81f9b65.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/77-0.webp" onerror="onerror=null;src='https://qxchuckle.github.io/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇⇨</div><div class="next_info">NestJS[二]-核心</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://qxchuckle.github.io/img/head.webp" data-no-lazy="data-no-lazy" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div></div><a class="card-widget" id="card-tuijian" href="https://afdian.net/a/chuckle" target="_blank" style="display:block"><div id="tj-box"><div id="tj-box1"><div id="tj-left"><p>扫一扫</p>
<span>快速打开移动端➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACGUlEQVR42u3bQZaDIBAFQO9/6cwJ4vymATWWq7yZPO1iAeQ3Hp+fvg48PDw8PDw8PDw8PDw8PDw8PDy8F/OO+PrnAY1v9mvAw8PD289LCkow1UHp1ICHh4d3B9634s4/J9RkUPIa8PDw8J7Iy7fF50sLHh4e3nt4CSkJGvDw8PCezhsbgm93qC4Gt8ha8PDw8BY0wNZ9vkV/Dw8PDy/glY83xc2wfNKfUBUeHh7eRl4+QVephWm9cdgLDw8P7ypeNTYdCw7y5tnCMAIPDw+vzTtfHpJN89gdqlN/6xcDHh4e3oJf69XHdJaQ/NBqoT2Gh4eHdzPe0bgGy10RRuDh4eEtiHGTiTvfWJ8PzflWe3LWgoeHh7c9xk2Kzv+bb6M3NcDw8PDw2ryxRlRS3FgDbFoYgYeHhzeJlwQB/UKrm+ZpCwMeHh7exi118shkOcnxnfAXDw8Pbz9vrN3Vmdbz5WdhAwwPDw+vzeuUVSgleA1gctaCh4eHt5g31uLqHBrovDqFh4eHt59XvcY2wdXDVXlDDg8PD28/byx6yO+Tx8HVxQAPDw/vWl5/MRgbiLF68PDw8O7Dq7bwkxgi+cvWrAUPDw/vIl41hsiPLOQxMR4eHt6zeNUjBZ1FYsnJCDw8PLxJvPw7nVLGYl88PDy8u/HyqTkvovN6wGX9PTw8PLyA9xsXHh4eHh4eHh4eHh4eHh4eHh4e3gt4fyt93Ede7FFyAAAAAElFTkSuQmCC"/></div></div></div><div id="tj-box2"><div id="tj-left"><p>爱发电</p>
<span>扫码或<span class="tj-light">点击跳转</span>➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACEElEQVR42u3bQXKDMAwFUO5/6fYAmbRfEhiTPK8YhiR+XtiKJI6fjx4HHh4eHh4eHh4eHh4eHh4eHh4e3hfzjnj88wMvz7x+9t33zOeAh4eHt56XT/31OrmTX/fmiYeHh3cX791GnPCSY+DdFl+dAx4eHt4TeclWXiXh4eHhfSqvGgRXkxR4eHh4z+JNUrTl9MGeuRY8PDy8Cwpg111vUd/Dw8PDC3jVkS9BHlKfMCs8PDy8hbxe60C+cfeSwuWWLzw8PLybeHm6tpfwrR4YeHh4eDvz8ibUKiAJu+ehNh4eHt5KXh7CzstU+fPl78HDw8NbzpuAJ4mG/Eg4uQCGh4eHN+ZNylr5ElxXMMPDw8O7i5ds7tV2qPwI6ZW+8PDw8NbzquWrfMvu3U+WAA8PD28fXu+oOOtIqIbReHh4ePvwJlPptZ/2khR4eHh49/KqbVVRmNsqjCWLjoeHh7cDL5/iJNQ+N3WLh4eHtxuvWhLLExB/H0iX/2PAw8PDG/PKW3ALk0+3dzzg4eHhreQd8chD7XlJ7OQCGB4eHt5l/ZyThMVZjftLcy14eHh4Y97fSYFeeF09fi4JqfHw8PA24FVfmuotXOEVLDw8PLxH8arg5Ek8PDy8p/DmRa9ei391UfDw8PB24OVbc34/b+fqvUiAh4eHdxfvMwYeHh4eHh4eHh4eHh4eHh4eHh7eF/B+Acr1Qv2GlsE8AAAAAElFTkSuQmCC"/></div></div></div></div></a><div class="card-widget card-announcement"><div class="item-headline"><i class="iconfont icon-gonggao"></i><span>公告</span></div><div class="announcement_content">欢迎来到『轻笑Chuckle』的小站<br>(￣▽￣)～■干杯□～(￣▽￣)<br>如果有什么加载不出来或者其它滴小bug,「刷新网页/Ctrl+F5」应该、也许能解决</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Logger%E6%97%A5%E5%BF%97"><span class="toc-number">1.</span> <span class="toc-text">Logger日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AELogger"><span class="toc-number">1.1.</span> <span class="toc-text">配置Logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Logger"><span class="toc-number">1.2.</span> <span class="toc-text">自定义Logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">日志格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Logger"><span class="toc-number">1.4.</span> <span class="toc-text">使用Logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5Logger"><span class="toc-number">1.5.</span> <span class="toc-text">依赖注入Logger</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ModuleRef%E6%A8%A1%E5%9D%97%E5%BC%95%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">ModuleRef模块引用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.1.</span> <span class="toc-text">获取实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">2.2.</span> <span class="toc-text">解析作用域提供者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">2.2.1.</span> <span class="toc-text">请求提供者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">2.3.</span> <span class="toc-text">动态实例化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%BA%8B%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">生命周期事件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%92%A9%E5%AD%90"><span class="toc-number">3.1.</span> <span class="toc-text">使用钩子</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#swagger%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-number">4.</span> <span class="toc-text">swagger接口文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ApiTags%E5%88%86%E7%BB%84"><span class="toc-number">4.1.</span> <span class="toc-text">ApiTags分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApiOperation%E6%8F%8F%E8%BF%B0%E8%B7%AF%E7%94%B1"><span class="toc-number">4.2.</span> <span class="toc-text">ApiOperation描述路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.</span> <span class="toc-text">描述参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApiProperty%E6%8F%8F%E8%BF%B0%E5%B1%9E%E6%80%A7"><span class="toc-number">4.4.</span> <span class="toc-text">ApiProperty描述属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CLI%E6%8F%92%E4%BB%B6"><span class="toc-number">4.5.</span> <span class="toc-text">CLI插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApiResponse%E6%8F%8F%E8%BF%B0%E5%93%8D%E5%BA%94"><span class="toc-number">4.6.</span> <span class="toc-text">ApiResponse描述响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApiHeader%E6%8F%8F%E8%BF%B0%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">4.7.</span> <span class="toc-text">ApiHeader描述请求头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0"><span class="toc-number">4.8.</span> <span class="toc-text">全局参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">4.9.</span> <span class="toc-text">安全机制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#swagger-typescript-api"><span class="toc-number">5.</span> <span class="toc-text">swagger-typescript-api</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT-token"><span class="toc-number">6.</span> <span class="toc-text">JWT token</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8Nest%E4%B8%AD%E4%BD%BF%E7%94%A8JWT"><span class="toc-number">6.1.</span> <span class="toc-text">在Nest中使用JWT</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#config%E9%85%8D%E7%BD%AE"><span class="toc-number">7.</span> <span class="toc-text">config配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ConfigModule"><span class="toc-number">7.1.</span> <span class="toc-text">使用ConfigModule</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#env%E7%9B%B8%E5%85%B3%E9%80%89%E9%A1%B9"><span class="toc-number">7.1.1.</span> <span class="toc-text">env相关选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.2.</span> <span class="toc-text">自定义配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">7.1.3.</span> <span class="toc-text">配置命名空间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ConfigService"><span class="toc-number">7.2.</span> <span class="toc-text">使用ConfigService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#validate%E9%AA%8C%E8%AF%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">7.3.</span> <span class="toc-text">validate验证环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8main%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-number">7.4.</span> <span class="toc-text">在main中使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E6%B3%A8%E5%86%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.5.</span> <span class="toc-text">局部注册配置文件</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/7c45abd.html" title="NestJS[一]-基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/77-0.webp" alt="NestJS[一]-基础"></a><div class="content"><a class="title" href="/article/7c45abd.html" title="NestJS[一]-基础">NestJS[一]-基础</a><time datetime="2024-01-22" title="发表于 2024-01-22">2024-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/c81f9b65.html" title="NestJS[二]-核心"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/77-0.webp" alt="NestJS[二]-核心"></a><div class="content"><a class="title" href="/article/c81f9b65.html" title="NestJS[二]-核心">NestJS[二]-核心</a><time datetime="2024-02-04" title="发表于 2024-02-04">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/e18aeaaa.html" title="NestJS[四]-数据库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/77-0.webp" alt="NestJS[四]-数据库"></a><div class="content"><a class="title" href="/article/e18aeaaa.html" title="NestJS[四]-数据库">NestJS[四]-数据库</a><time datetime="2024-02-19" title="发表于 2024-02-19">2024-02-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/c79e1541.html" title="RxJS"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/79-0.webp" alt="RxJS"></a><div class="content"><a class="title" href="/article/c79e1541.html" title="RxJS">RxJS</a><time datetime="2024-02-03" title="发表于 2024-02-03">2024-02-03</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最近更新</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/f17dfea3.html" title="React-记-2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/104-0.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.jpg'" alt="React-记-2"/></a><div class="content"><a class="title" href="/article/f17dfea3.html" title="React-记-2">React-记-2</a><time datetime="2024-09-26T11:26:24.000Z" title="更新于 2024-09-26 19:26:24">2024-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/cb488cbf.html" title="React-记-1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.jpg'" alt="React-记-1"/></a><div class="content"><a class="title" href="/article/cb488cbf.html" title="React-记-1">React-记-1</a><time datetime="2024-09-23T13:15:26.000Z" title="更新于 2024-09-23 21:15:26">2024-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/d186ebdd.html" title="闭包与内存泄漏"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/103-4.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.jpg'" alt="闭包与内存泄漏"/></a><div class="content"><a class="title" href="/article/d186ebdd.html" title="闭包与内存泄漏">闭包与内存泄漏</a><time datetime="2024-09-12T12:04:03.000Z" title="更新于 2024-09-12 20:04:03">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/d22c87fc.html" title="Vue3.5 更新了啥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/images/102-0.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.jpg'" alt="Vue3.5 更新了啥"/></a><div class="content"><a class="title" href="/article/d22c87fc.html" title="Vue3.5 更新了啥">Vue3.5 更新了啥</a><time datetime="2024-09-12T06:33:20.000Z" title="更新于 2024-09-12 14:33:20">2024-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/93c63660.html" title="Git lint 相关"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/1.webp" onerror="this.onerror=null;this.src='https://qxchuckle.github.io/img/404.jpg'" alt="Git lint 相关"/></a><div class="content"><a class="title" href="/article/93c63660.html" title="Git lint 相关">Git lint 相关</a><time datetime="2024-09-10T02:09:48.000Z" title="更新于 2024-09-10 10:09:48">2024-09-10</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(0, 0, 0, 0);"><div id="footer-wrap"><div id="footer_icon"><div class="icon_left"><a class="icon_link" target="_blank" href="http://foreverblog.cn/go.html" rel="noopener external nofollow" title="虫洞-随机访问十年之约成员博客"><i class="fa-solid fa-circle-notch fa-fw"></i></a><a class="icon_link" target="_blank" href="https://travellings.cn" rel="noopener external nofollow" title="开往-随机跳转到另一个加入开往的网页"><i class="fa-solid fa-subway fa-fw"></i></a><a class="icon_link" href="/link/" title="友链"><i class="fa-solid fa-link fa-fw"></i></a><a class="icon_link" href="/messageboard/" title="留言"><i class="fa-regular fa-comment fa-fw"></i></a></div><img class="footer_logo entered loaded" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/head.webp" onclick="btf.scrollToDest(0,500)" title="返回顶部"/><div class="icon_left"><a class="icon_link" target="_blank" rel="noopener" href="https://www.qcqx.cn/" title="我的主页"><i class="fa-solid fa-compass fa-fw"></i></a><a class="icon_link" target="_blank" href="https://res.abeim.cn/api/qq/?qq=1934009145" rel="noopener external nofollow" title="联系QQ"><i class="fa-brands fa-qq fa-fw"></i></a><a class="icon_link" target="_blank" href="https://github.com/qxchuckle" rel="noopener external nofollow" title="我的Github主页"><i class="fa-brands fa-github fa-fw"></i></a><a class="icon_link" href="mailto:chuckle@chuckle.top" rel="noopener external nofollow" title="邮件联系"><i class="fa-solid fa-envelope fa-fw"></i></a></div></div><div class="copyright">&copy;2022 - 2024 By 『轻笑Chuckle』<a id="beianhao" style="color:#fff;font-size:0.9rem;font-weight:400;" href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2022076449号</a></div><div class="footer_custom_text">『Another branch will grow and flourish in the future』</div><div class="footer-banner"><div id="footer-banner-time"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>if(! (navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))){
function createtime() {
var now = new Date();
var grt= new Date("03/10/2022 00:00:00");
now.setTime(now.getTime()+1000);
days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
document.getElementById("timeDate").innerHTML = "自 2022-3-10 建站以来，小站已苟活 "+dnum+" 天 ";
document.getElementById("times").innerHTML = hnum + " 时 " + mnum + " 分 ( =•ω•= )m";
}
createtime();
if(typeof footer_time == "undefined"){
  var footer_time = setInterval("createtime()",1000*60);
}else{
  clearInterval(footer_time);
  footer_time = setInterval("createtime()",1000*60);
}
}
</script></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/hexo.svg"/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/butterfly.svg"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/github.svg"/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20220160" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/20220160.svg"/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/2022076449.svg"/></a><a class="github-badge" target="_blank" href="https://cloud.tencent.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/tx.svg"/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/vercel.svg"/></a><a class="github-badge" target="_blank" href="https://tianli-blog.club/jsd/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/tianlicdn.svg"/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/ypy.svg"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/img/cc.svg"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="refresh-cache" type="button" title="刷新缓存" onclick="refreshCache()"><i class="fas fa-refresh fa-spin"></i></button><button id="enlargePage-btn" type="button" title="放大页面" onclick="enlargePage()"><i class="fa fa-plus"></i></button><button id="narrowPage-btn" type="button" title="缩小页面" onclick="narrowPage()"><i class="fa fa-minus"></i></button><button type="button" title="切换背景" onclick="toggleWinbox()"><i class="fa fa-images"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn();"><i class="fas fa-comments"></i></button><button id="share-link" type="button" title="分享链接"><i class="fa fa-share-alt"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-top"><i class="fa fa-angles-up"></i></div></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:kk.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-magnifying-glass"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-read"><a class="rightMenu-item" href="javascript:kk.pasteText();"><i class="fa fa-paste"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" id="menu-radompage" href="/"><i class="fa-solid fa-shoe-prints"></i><span>博客主页</span></a><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-adjust"></i><span>昼夜切换</span></div><div class="rightMenu-item" id="share-chuckle"><i class="fa fa-share-alt"></i><span>分享本页</span></div><a class="rightMenu-item" id="menu-radompage" href="/categories/"><i class="fa fa-archive"></i><span>分类</span></a><a class="rightMenu-item" id="menu-radompage" href="/tags/"><i class="fa fa-tags"></i><span>标签</span></a></div></div><div id="rightmenu-mask" onclick="RemoveRightMenu()"></div><div><script src="https://qxchuckle.github.io/js/utils.js"></script><script src="https://qxchuckle.github.io/js/main.js?6"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script><script src="https://qxchuckle.github.io/js/search/local-search.js?2"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 2500);</script><div class="js-pjax"><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.qcqx.cn',
      path: location.pathname,
      visitor: true,
      dark: 'html[data-theme="dark"]'
    }, {"requiredMeta":["nick","mail"],"wordLimit":400,"placeholder":"来评论交流吧，通过邮件通知（表情点不出来请刷新页面）"}))
  }

  if (typeof Waline === 'function') initWaline()
  else getScript('https://qxchuckle.github.io/js/waline.min.js?7').then(initWaline)
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="https://qxchuckle.github.io/js/qx-tracker.min.js?1"></script><script>const tracker = new Tracker({requestUrl:'https://tracker-api.qcqx.cn/api/tracker',historyTracker:true,realTime:true});</script><script defer="true" src="https://qxchuckle.github.io/random.min.js?14"></script><script defer="true" src="https://qxchuckle.github.io/js/chuckle.js?15"></script><script src="https://qxchuckle.github.io/js/chuckle-post-ai.js?11"></script><script defer>new ChucklePostAI({el:'#post>#article-container',key:'tN2jLmG7fX9zHk5dVbQr',title_el:'.post-title',rec_method:'web',whitelist:['article/17d3383a.html'],pjax:true})</script><link rel="stylesheet" href="/" media="print" onload="this.media='all'"><script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-heo/metingjs/Meting.min.js"></script><script src="https://qxchuckle.github.io/js/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#fixedcard-dashboard","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div id="fixedcard-dashboard"><button class="fixedcard-activebtn" type="button" title="用户信息" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-info&quot;,&quot;0&quot;)"><i class="fas fa-address-book"></i></button><button class="fixedcard-activebtn" type="button" title="公告" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-announcement&quot;,&quot;0&quot;)"><i class="fa fa-bullhorn"></i></button><button class="fixedcard-activebtn" type="button" title="相关推荐" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recommend-post&quot;,&quot;0&quot;)"><i class="fas fa-dharmachakra"></i></button><button class="fixedcard-activebtn" type="button" title="最近更新" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recent-post&quot;,&quot;0&quot;)"><i class="fas fa-history"></i></button><div class="fixedcard-user-avatar fixedcard-activebtn" onclick="RemoveFixedCardWidget()"><img class="fixedcard-user-avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/head.webp" title="『轻笑Chuckle』"></div></div></div><div class="contact-info"><div class="option" id="anything"><i class="fas fa-dove"></i><div class="bloktop"></div><div class="text">一切所逝去的<div class="strip"></div><div class="something"></div></div></div><div class="option"><i class="fas fa-burn"></i><div class="blok"></div><div class="text"><div class="strip"></div><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂</span><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a class="about-reward" href="/img/weixin.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/blog/pay/weixin.webp" loading="lazy" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a class="about-reward" href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://qxchuckle.github.io/blog/pay/alipay.webp" loading="lazy" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div></div></div><div class="option"><i class="fas fa-music"></i><div class="blokbottom"></div><div class="text aplayertext"><script>var meting_api='https://qxchuckle.github.io/qx-meting.json?7';
//-https://meting-api.qcqx.cn/api/?server=netease&type=playlist&id=6609736315</script><div class="strip"></div><div class="aplayer no-destroy" mutex="true" listfolded="true" data-id="6609736315" data-preload="none" data-server="netease" data-volume="0.25" data-order="random" data-type="playlist" data-fixed="true" data-autoplay="false"></div></div></div></div><!-- hexo injector body_end start --><script data-pjax>function hope_light_loader_injector_config(){
                var parent_div_git = document.getElementById('body-wrap');
                var item_html = '<div id="loading-bar-wrapper">';
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementById('body-wrap') && (location.pathname ==='all'|| 'all' ==='all')){
            hope_light_loader_injector_config()
        } </script>
    <script src="https://qxchuckle.github.io/js/nprogress.min.js"></script>
    <script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script data-pjax>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
      document.addEventListener('pjax:send', window.ShowLoading)
      document.addEventListener('pjax:success', window.HideLoading)
      document.addEventListener('pjax:error', window.HideLoading)
    </script>
<!-- hexo injector body_end end --></body></html>