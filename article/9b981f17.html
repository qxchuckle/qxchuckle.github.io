<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><script>if ('serviceWorker' in navigator) {
  if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 1) {
    (async()=>{window.stop()})()
    window.localStorage.setItem('ChenBlogHelper_Set', 1)
  }
  navigator.serviceWorker.register('/giggles.js')
    .then(async () => {
      if (Number(window.localStorage.getItem('ChenBlogHelper_Set')) < 2) {
        window.localStorage.setItem('ChenBlogHelper_Set', 2)
        setTimeout(() => {
          window.location.reload()
        }, 150)
      }
    })
}
//- function setQXCookies(obj, limitTime, customDomain) {
//-     let data = new Date(new Date().getTime() + limitTime * 24 * 60 * 60 * 1000).toGMTString();
//-     for (let i in obj) {
//-       document.cookie = i + '=' + obj[i] + ';expires=' + data + ';domain=' + customDomain;
//-     }
//- }
//- function getQXCookie(name) {
//-     var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
//-     if (arr = document.cookie.match(reg))
//-         return decodeURIComponent(arr[2]);
//-     else
//-         return null;
//- }
//- if(getQXCookie('qcqx')!=="chuckle"){
//-   setQXCookies({ qcqx: 'chuckle' }, 365, 'qcqx.cn');
//- }else{
//-   console.log("qcqx");
//- }</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Node-回眸[二] | 轻笑Chuckle</title><meta name="keywords" content="前端,NodeJS"><meta name="author" content="『轻笑Chuckle』"><meta name="copyright" content="『轻笑Chuckle』"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="baidu-site-verification" content="codeva-BLXfA46XrF"><meta name="description" content="events、util、fs、stream、crypto、zlib">
<meta property="og:type" content="article">
<meta property="og:title" content="Node-回眸[二]">
<meta property="og:url" content="https://www.qcqx.cn/article/9b981f17.html">
<meta property="og:site_name" content="轻笑Chuckle">
<meta property="og:description" content="events、util、fs、stream、crypto、zlib">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp">
<meta property="article:published_time" content="2024-01-11T09:39:15.000Z">
<meta property="article:modified_time" content="2024-01-11T09:39:15.000Z">
<meta property="article:author" content="『轻笑Chuckle』">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="NodeJS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp"><link rel="canonical" href="https://www.qcqx.cn/article/9b981f17"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/index.css?285"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/fontawesome.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.json","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":160},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Node-回眸[二]',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-11 17:39:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/css/tag_plugins.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="轻笑Chuckle" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp"/></div></div><div id="web_bg"></div><div id="svg_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="is-center" id="sidebar-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="menu-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><div id="chuckle_home"><div class="back-home-button"><i class="back-home-button-icon fas fa-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">传送门</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="前往博客主页" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" loading="lazy"/><span class="back-menu-item-text">博客主页</span></a><a class="back-menu-item" href="https://waline.qcqx.cn/ui" rel="external nofollow" title="前往评论后端" target="_blank"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/c4.webp" loading="lazy"/><span class="back-menu-item-text">评论管理</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">博客线路</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.qcqx.cn/" title="前往博客主站" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/h4.webp" loading="lazy"/><span class="back-menu-item-text">主域名线路</span></a><a class="back-menu-item" href="https://qxchuckle.github.io" title="前往博客Github线路" target="_blank" rel="noopener nofollow"><img class="back-menu-item-icon entered loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/c6.webp" loading="lazy"/><span class="back-menu-item-text">Github线路</span></a></div></div></div></div></div><span id="blog_name"><a id="site-name" href="/">轻笑Chuckle</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-zhuye"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhang"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-bendiwenjianjia"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei1"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian1"></i><span> 标签</span></a></li><li><a class="site-page child" href="javascript:toRandomPost();"><i class="fa-fw iconfont icon-suijiceliang"></i><span> 随机文章</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw iconfont icon-tongji"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-_lianjie"></i><span> 空间</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw iconfont icon-pengyouquan"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw iconfont icon-shejiao"></i><span> 哔哔</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw iconfont icon-fasong-"></i><span> 其它</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="fa-fw iconfont icon-yuangongrizhi"></i><span> 日志</span></a></li><li><a class="site-page child" href="/agreement/"><i class="fa-fw iconfont icon-yinsixieyi"></i><span> 协议</span></a></li><li><a class="site-page child" href="/atom.xml" target="_blank"><i class="fa-fw iconfont icon-RSS"></i><span> RSS</span></a></li><li><a class="site-page child" href="/sitemap.xml" target="_blank"><i class="fa-fw iconfont icon-ditu"></i><span> Sitemap</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw iconfont icon-liuyanban"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-aixin"></i><span> 关于我</span></a></div></div><div id="buttons"><div id="switch-bg"><a class="site-page social-icon search" href="javascript:;" rel="noopener external nofollow" onclick="toggleWinbox()" title="切换背景-换一种感觉。"><i class="fas fa-images fa-fw"></i></a></div><div id="switch-darkmode"><a class="site-page social-icon" onclick="kk.switchDarkMode()" title="切换模式"><i class="fas fa-adjust fa-fw"></i></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info" style="background-image: url('https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp')"><div id="post-meta-top"><span class="post-categories"><i class="iconfont icon-fenlei fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span><span class="post-tags"><a class="post-meta-tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="post-meta-tags" href="/tags/NodeJS/">NodeJS</a></span></div><h1 class="post-title">Node-回眸[二]<a class="post-share" id="share-post" href="javascript:;" rel="noopener external nofollow" onclick="kk.postURL()"><i class="fa fa-share-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="iconfont icon-shalou fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-11T09:39:15.000Z" title="发表于 2024-01-11 17:39:15">2024-01-11</time></span><span class="post-meta-date"><i class="iconfont icon-gengxin fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-11T09:39:15.000Z" title="更新于 2024-01-11 17:39:15">2024-01-11</time></span></div><div class="meta-secondline"><span class="post-meta-wordcount"><i class="iconfont icon-tongji1 fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.7k</span></span><span class="post-meta-wordcount"><i class="iconfont icon-tubiaozhizuomoban- fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>70分钟</span></span><span class="leancloud_visitors" id="/article/9b981f17.html" data-flag-title="Node-回眸[二]"><i class="iconfont icon-yanjing fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-commentcount"><i class="iconfont icon-pinglun fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/article/9b981f17.html#post-comment"><span class="waline-comment-count" id="/article/9b981f17.html"></span></a></span></div></div></div><article class="post-content" id="article-container"><div class="Copyright-Notice" id="Copyright-Notice"><div id="post-Copyright-bar"></div><div id="Copyright-box"><span>本站博文未在任何平台</span><span class="copyright-phone-none">以任何形式</span><span>售卖，详情:</span><a href="/agreement/">协议</a></div></div><div class="post-series"><div class="post-series-title"> <span class="arrowhead">▸</span><span>NodeJS笔记-系列</span></div><div class="post-series-box"><script>if(1){
let series_title=document.querySelector('.post-series-title')
let arrowhead=document.querySelector('.arrowhead')
var arrowhead_n = 1;
series_title.addEventListener('click',function(){
    let content=document.querySelector('.post-series-box')
    content.classList.toggle("show")
    if(arrowhead_n){
      arrowhead.innerHTML = "▾"
      arrowhead_n = 0
    }else{
      arrowhead.innerHTML = "▸"
      arrowhead_n = 1
    }
})
}</script><div class="post-series-item"><a class="title" href="/article/109cbe0a.html" title="初识NodeJS">初识NodeJS</a></div><div class="post-series-item"><a class="title" href="/article/8ddaf637.html" title="Express框架">Express框架</a></div><div class="post-series-item"><a class="title" href="/article/bd0448f7.html" title="NodeJS-MongoDB">NodeJS-MongoDB</a></div><div class="post-series-item"><a class="title" href="/article/a1e193d6.html" title="NodeJS接口、会话控制">NodeJS接口、会话控制</a></div><div class="post-series-item"><a class="title" href="/article/98a1db82.html" title="Node-回眸[一]">Node-回眸[一]</a></div><div class="post-series-item"><a class="title" href="/article/9b981f17.html" title="Node-回眸[二]">Node-回眸[二]</a></div><div class="post-series-item"><a class="title" href="/article/9b01fd71.html" title="Node-回眸[三]">Node-回眸[三]</a></div></div></div><h1 id="events"><a href="#events" class="headerlink" title="events"></a>events</h1><p>Node是事件驱动的，事件模型采用了<strong>发布订阅设计模式</strong>，EventListener、Vue2 evnetBus都是这种模式</p>
<p>发布订阅模式有三个角色参与</p>
<ol>
<li>发布者（Publisher）：发布消息，制定消息的主题名</li>
<li>订阅者（Subscriber）：通过消息主题订阅消息，先订阅再等待发布消息，否则会错过消息</li>
<li>调度中心（Broker）：维护一个消息列表，并提供发布和订阅消息的方法，通过消息主题将发送者和接收者连接起来，四个基本的方法：on、once、off、emit</li>
</ol>
<p>发布者和订阅者之间完全解耦，不再直接依赖于彼此，可以独立地扩展自己，消息的传递则依靠调度中心。发布者不会将消息直接发送给订阅者，而是通过调度中心将消息和其主题广播出去，订阅了该主题则可以接收到消息</p>
<p>实现一个简单的发布订阅：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅方法</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EventFun</span> &#123;</span><br><span class="line">  (...<span class="attr">args</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EventCls</span> &#123;</span><br><span class="line">  <span class="comment">// 订阅消息</span></span><br><span class="line">  <span class="title function_">on</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="title class_">EventFun</span>): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 发布消息</span></span><br><span class="line">  <span class="title function_">emit</span>(<span class="attr">name</span>: <span class="built_in">string</span>, ...<span class="attr">args</span>: <span class="built_in">any</span>[]): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 取消订阅</span></span><br><span class="line">  <span class="title function_">off</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">fn</span>: <span class="title class_">EventFun</span>): <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// 只订阅一次</span></span><br><span class="line">  <span class="title function_">once</span>(<span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">fn</span>: <span class="title class_">EventFun</span>): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">CallbackArr</span> = <span class="title class_">Array</span>&lt;<span class="title class_">EventFun</span>&gt;</span><br><span class="line"><span class="comment">// 保存所有消息</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EventList</span> &#123;</span><br><span class="line">  <span class="comment">// 消息名:订阅的方法集合</span></span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">CallbackArr</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubPub</span> <span class="keyword">implements</span> <span class="title class_">EventCls</span> &#123;</span><br><span class="line">  <span class="attr">list</span>: <span class="title class_">EventList</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span> = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">on</span>(<span class="params">name: <span class="built_in">string</span>, callback: EventFun</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">callbackList</span>: <span class="title class_">CallbackArr</span> = <span class="variable language_">this</span>.<span class="property">list</span>[name] || [];</span><br><span class="line">    callbackList.<span class="title function_">push</span>(callback)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">list</span>[name] = callbackList</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">name: <span class="built_in">string</span>, ...args: <span class="built_in">any</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">callbackList</span>: <span class="title class_">CallbackArr</span> = <span class="variable language_">this</span>.<span class="property">list</span>[name]</span><br><span class="line">    <span class="keyword">if</span> (callbackList) &#123;</span><br><span class="line">      <span class="keyword">if</span> (callbackList.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;该消息没有订阅者&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      callbackList.<span class="title function_">forEach</span>(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">        callback.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;没有该消息&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">off</span>(<span class="params">name: <span class="built_in">string</span>, fn: EventFun</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">callbackList</span>: <span class="title class_">CallbackArr</span> = <span class="variable language_">this</span>.<span class="property">list</span>[name]</span><br><span class="line">    <span class="keyword">if</span> (callbackList) &#123;</span><br><span class="line">      <span class="keyword">if</span> (callbackList.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;该消息没有订阅者&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> index = callbackList.<span class="title function_">findIndex</span>(<span class="function"><span class="params">fns</span> =&gt;</span> fns === fn)</span><br><span class="line">      index &gt; -<span class="number">1</span> ? callbackList.<span class="title function_">splice</span>(index, <span class="number">1</span>) : <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;没有该消息&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">once</span>(<span class="params">name: <span class="built_in">string</span>, fn: EventFun</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">decor</span>: <span class="title class_">EventFun</span> = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">      fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(name, decor)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(name, decor)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> subPub = <span class="keyword">new</span> <span class="title class_">SubPub</span>()</span><br><span class="line"><span class="comment">// 测试on和off</span></span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;abc&#x27;</span>, <span class="number">678</span>) <span class="comment">// 没有该消息</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">fn</span>: <span class="title class_">EventFun</span> = <span class="function">(<span class="params">...arg</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg);</span><br><span class="line">&#125;</span><br><span class="line">subPub.<span class="title function_">on</span>(<span class="string">&#x27;abc&#x27;</span>, fn)</span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;abc&#x27;</span>, <span class="number">131</span>, <span class="literal">true</span>) <span class="comment">// [ 131, true ]</span></span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;abc&#x27;</span>, <span class="number">678</span>, <span class="literal">false</span>, <span class="string">&#x27;qx&#x27;</span>) <span class="comment">// [ 678, false, &#x27;qx&#x27; ]</span></span><br><span class="line">subPub.<span class="title function_">off</span>(<span class="string">&#x27;abc&#x27;</span>, fn)</span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;abc&#x27;</span>, <span class="number">321</span>, <span class="string">&#x27;qx&#x27;</span>) <span class="comment">// 该消息没有订阅者</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;=======================&quot;</span>);</span><br><span class="line"><span class="comment">// 测试once</span></span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">678</span>) <span class="comment">// 没有该消息</span></span><br><span class="line">subPub.<span class="title function_">once</span>(<span class="string">&#x27;a&#x27;</span>, <span class="function">(<span class="params">...arg</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg);</span><br><span class="line">&#125;)</span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">678</span>, <span class="string">&#x27;abc&#x27;</span>) <span class="comment">// [ 678, &#x27;abc&#x27; ]</span></span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">123</span>, <span class="string">&#x27;qx&#x27;</span>) <span class="comment">// 该消息没有订阅者</span></span><br><span class="line">subPub.<span class="title function_">on</span>(<span class="string">&#x27;a&#x27;</span>, <span class="function">(<span class="params">...arg</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(arg);</span><br><span class="line">&#125;)</span><br><span class="line">subPub.<span class="title function_">emit</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">123</span>, <span class="string">&#x27;qx&#x27;</span>) <span class="comment">// [ 123, &#x27;qx&#x27; ]</span></span><br></pre></td></tr></table></figure>
<h2 id="EventEmitter"><a href="#EventEmitter" class="headerlink" title="EventEmitter"></a>EventEmitter</h2><p>Node内置的 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/events.html">events</a> 模块提供了 EventEmitter 类用于处理事件的发布与订阅</p>
<p>Node中许多类都继承自它，比如 Process、Stream、HTTP 等，这些类都提供了事件处理机制，允许注册监听器以响应特定的事件，从而构建异步、事件驱动的程序</p>
<p>在Node中，消息&lt;-&gt;事件，订阅消息&lt;-&gt;监听事件，发布消息&lt;-&gt;触发事件</p>
<p>常用方法：</p>
<ol>
<li><code>on(event, listener)</code> 为指定事件添加一个监听器到监听器数组的<strong>尾部</strong></li>
<li><code>addListener(event, listener)</code> 与on等效</li>
<li><code>once(event, listener)</code> 为指定事件注册一个单次监听器到监听器数组的<strong>尾部</strong>，该监听器触发后立刻被移除</li>
<li><code>emit(event, ...argv)</code> 触发事件，传递参数，如果事件有注册监听返回 true，否则返回 false。</li>
<li><code>off(event, listener)</code> 移除指定事件的某个监听器，在监听器数组中<strong>从后往前</strong>找</li>
<li><code>removeListener(event, listener)</code> 与off等效</li>
<li><code>removeAllListeners([event])</code> 移除所有事件(或指定事件)的所有监听器</li>
<li><code>setMaxListeners(n)</code> 设置单个事件最大监听器数量，默认10，超过将发出警告，有助于排查内存泄漏，设置为 Infinity（或 0）以表示无限数量</li>
<li><code>listeners(event)</code> 返回指定事件的所有监听器组成的数组</li>
<li><code>rawListeners(event)</code> 与listeners差不多，但会将once注册的监听器标记出来</li>
<li><code>listenerCount(event)</code> 返回指定事件的监听器数量</li>
<li><code>eventNames()</code> 返回事件名列表数组</li>
<li><code>prependListener(event, listener)</code> 为指定事件添加一个监听器到监听器数组的<strong>头部</strong></li>
<li><code>prependOnceListener(event, listener)</code> 为指定事件注册一个单次监听器到监听器数组的<strong>头部</strong></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">listener</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(args)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 监听事件</span></span><br><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;test&#x27;</span>, listener)</span><br><span class="line">event.<span class="title function_">once</span>(<span class="string">&#x27;test&#x27;</span>, listener)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="title function_">eventNames</span>()) <span class="comment">// [ &#x27;test&#x27; ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="title function_">listeners</span>(<span class="string">&#x27;test&#x27;</span>)) </span><br><span class="line"><span class="comment">// [ [Function: listener], [Function: listener] ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="title function_">rawListeners</span>(<span class="string">&#x27;test&#x27;</span>))</span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//   [Function: listener],</span></span><br><span class="line"><span class="comment">//   [Function: bound onceWrapper] &#123; listener: [Function: listener] &#125;</span></span><br><span class="line"><span class="comment">// ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="title function_">listenerCount</span>(<span class="string">&#x27;test&#x27;</span>)) <span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 触发事件，传递信息</span></span><br><span class="line">event.<span class="title function_">emit</span>(<span class="string">&#x27;test&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">event.<span class="title function_">emit</span>(<span class="string">&#x27;test&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"><span class="comment">// [ 1, 2, 3, 4, 5 ] 两次on一次once</span></span><br><span class="line"><span class="comment">// [ 1, 2, 3, 4, 5 ]</span></span><br><span class="line"><span class="comment">// [ 1, 2, 3, 4, 5 ]</span></span><br></pre></td></tr></table></figure>
<p>默认情况下，每个事件最多注册 10 个监听器，超过 10 个监听器会发出警告</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">  event.<span class="title function_">on</span>(<span class="string">&#x27;test&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`test<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">event.<span class="title function_">emit</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="comment">// (node:40112) MaxListenersExceededWarning: </span></span><br><span class="line"><span class="comment">// Possible EventEmitter memory leak detected. </span></span><br><span class="line"><span class="comment">// 11 test listeners added to [EventEmitter]. </span></span><br><span class="line"><span class="comment">// Use emitter.setMaxListeners() to increase limit</span></span><br></pre></td></tr></table></figure>
<p>使用 setMaxListeners(num) 设置单个事件最大监听器数量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.<span class="title function_">setMaxListeners</span>(<span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<h2 id="错误事件"><a href="#错误事件" class="headerlink" title="错误事件"></a>错误事件</h2><p>当 EventEmitter 实例中发生错误时，会触发 error 事件</p>
<p>如果没有为 error 事件注册监听器，则会抛出错误，打印堆栈跟踪，然后 Node 进程退出</p>
<p>最佳实践：应始终为 error 事件添加监听器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message:&#x27;</span>, err.<span class="property">message</span>) <span class="comment">// message: 错误信息</span></span><br><span class="line">&#125;)</span><br><span class="line">event.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;错误信息&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>使用 events.errorMonitor 安装监听器，可以在不消费触发的错误的情况下监视 error 事件(错误会穿透监听)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; errorMonitor &#125; = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line">event.<span class="title function_">on</span>(errorMonitor, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;message:&#x27;</span>, err.<span class="property">message</span>) <span class="comment">// message: 错误信息</span></span><br><span class="line">&#125;)</span><br><span class="line">event.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;错误信息&#x27;</span>));</span><br><span class="line"><span class="comment">// Error: 错误信息</span></span><br><span class="line"><span class="comment">//     ......</span></span><br><span class="line"><span class="comment">// Emitted &#x27;error&#x27; event at:</span></span><br><span class="line"><span class="comment">//     ......</span></span><br></pre></td></tr></table></figure>
<h2 id="new-removeListener事件"><a href="#new-removeListener事件" class="headerlink" title="new/removeListener事件"></a>new/removeListener事件</h2><p><strong>newListener</strong> 当有新的监听器<strong>将要</strong>注册，触发该事件<br><strong>removeListener</strong> 当有监听器被移除后，触发该事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;newListener&#x27;</span>, <span class="function">(<span class="params">event, listener</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(event, listener)</span><br><span class="line">  <span class="comment">// removeListener [Function (anonymous)]</span></span><br><span class="line">  <span class="comment">// test [Function: listener]</span></span><br><span class="line">&#125;)</span><br><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;removeListener&#x27;</span>, <span class="function">(<span class="params">event, listener</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(event, listener)</span><br><span class="line">  <span class="comment">// test [Function: listener]</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">listener</span> = (<span class="params"></span>) =&gt; &#123; &#125;</span><br><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;test&#x27;</span>, listener)</span><br><span class="line">event.<span class="title function_">off</span>(<span class="string">&#x27;test&#x27;</span>, listener)</span><br></pre></td></tr></table></figure>
<h2 id="process底层"><a href="#process底层" class="headerlink" title="process底层"></a>process底层</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupProcessObject</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> origProcProto = <span class="title class_">ObjectGetPrototypeOf</span>(process);</span><br><span class="line">  <span class="title class_">ObjectSetPrototypeOf</span>(origProcProto, <span class="title class_">EventEmitter</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">  <span class="title class_">FunctionPrototypeCall</span>(<span class="title class_">EventEmitter</span>, process);</span><br><span class="line">  <span class="title class_">ObjectDefineProperty</span>(process, <span class="title class_">SymbolToStringTag</span>, &#123;</span><br><span class="line">    <span class="attr">__proto__</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&#x27;process&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create global.process as getters so that we have a</span></span><br><span class="line">  <span class="comment">// deprecation path for these in ES Modules.</span></span><br><span class="line">  <span class="comment">// See https://github.com/nodejs/node/pull/26334.</span></span><br><span class="line">  <span class="keyword">let</span> _process = process;</span><br><span class="line">  <span class="title class_">ObjectDefineProperty</span>(globalThis, <span class="string">&#x27;process&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">__proto__</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> _process;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">value</span>) &#123;</span><br><span class="line">      _process = value;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ObjectGetPrototypeOf() 即 Object.getPrototypeOf()，获取某个对象原型上的属性</p>
<p>在源码中，通过该API获取了process的原型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span> = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(a));</span><br><span class="line"><span class="comment">// &#123; name: &#x27;A&#x27; &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">__proto__</span>);</span><br><span class="line"><span class="comment">// &#123; name: &#x27;A&#x27; &#125;</span></span><br></pre></td></tr></table></figure>
<p>ObjectSetPrototypeOf() 即 Object.setPrototypeOf()，用于设置对象的原型</p>
<p>在源码中，将 EventEmitter 的原型对象设置为 process 的原型的原型，让 process 也能使用 events 的一些方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;</span><br><span class="line">A.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span> = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(a, &#123; <span class="attr">name</span>: <span class="string">&#x27;B&#x27;</span> &#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(a));</span><br><span class="line"><span class="comment">// &#123; name: &#x27;B&#x27; &#125;</span></span><br></pre></td></tr></table></figure>
<p>FunctionPrototypeCall() 即 Function.prototype.call()，改变 this 指向并调用函数</p>
<p>在源码中，调用 EventEmitter 构造函数，使 process 也拥有 EventEmitter 的功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">a</span> = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">B</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">18</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 A 的实例，并使用 call 将当前实例作为上下文传递给 B 的构造函数，使 B 的构造函数内的 this 指向 a 实例对象</span></span><br><span class="line"><span class="keyword">const</span> a= <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line">B.<span class="title function_">call</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">a</span>);    <span class="comment">// 输出: 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">name</span>);  <span class="comment">// 输出: B</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">age</span>);   <span class="comment">// 输出: 18</span></span><br></pre></td></tr></table></figure>
<p>通过 FunctionPrototypeCall() 和 ObjectSetPrototypeOf()，使 process 继承自 EventEmitter</p>
<p>最后，通过 ObjectDefineProperty() 将process挂载到全局变量上</p>
<h1 id="util"><a href="#util" class="headerlink" title="util"></a>util</h1><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/util.html">util</a> 提供了很多实用的、工具类型的API，方便快速开发</p>
<h2 id="类型判断"><a href="#类型判断" class="headerlink" title="类型判断"></a>类型判断</h2><p>util.types 上有很多 is***() 的方法用于判断类型，返回 boolean</p>
<p>与 instanceof 不同，util.types 不会受到原型链的影响</p>
<p>instanceof 运算符用于检查一个对象是否是某个构造函数的实例。具体而言，它检查一个对象的原型链中是否出现了指定构造函数的原型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="property">types</span>.<span class="title function_">isDate</span>(<span class="keyword">new</span> <span class="title class_">Date</span>())) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="property">types</span>.<span class="title function_">isPromise</span>(<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">() =&gt;</span> &#123; &#125;))) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>() </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(date <span class="keyword">instanceof</span> <span class="title class_">Date</span>) <span class="comment">// true</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(date, &#123;&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(date <span class="keyword">instanceof</span> <span class="title class_">Date</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="property">types</span>.<span class="title function_">isDate</span>(date)) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h2 id="promisify"><a href="#promisify" class="headerlink" title="promisify"></a>promisify</h2><p>promisify(fn) 用于将回调函数的模式转为promise模式</p>
<p>原回调函数的参数除err外，都作为对象的属性返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> execPromise = util.<span class="title function_">promisify</span>(childProcess.<span class="property">exec</span>)</span><br><span class="line"><span class="title function_">execPromise</span>(<span class="string">&#x27;node -v&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; stdout, stderr &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 原回调函数的参数除err外，都作为对象的属性返回</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(stdout) <span class="comment">// v21.2.0</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>手写 promisify</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">promisify</span> = (<span class="params">fn</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 返回一个函数，参数与原函数相同</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 返回一个 Promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 执行原函数，传入原函数的参数，最后一个参数为回调函数</span></span><br><span class="line">      <span class="title function_">fn</span>(...args, <span class="function">(<span class="params">err, ...values</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(...values)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> execPromise = <span class="title function_">promisify</span>(childProcess.<span class="property">exec</span>)</span><br><span class="line"><span class="title function_">execPromise</span>(<span class="string">&#x27;node -v&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(stdout) <span class="comment">// v21.2.0</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>自己写 promisify 是无法获取到 key 名（原参数名）的，也就不能像 util.promisify 那样resolve一个对象</p>
<p>在底层通过 kCustomPromisifyArgsSymbol 获取 key 名，但该 API 仅Node内部使用</p>
<h2 id="callbackify"><a href="#callbackify" class="headerlink" title="callbackify"></a>callbackify</h2><p>callbackify(fn) 将promise模式转为回调函数的模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">fn</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;error&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resolve</span>(type)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> newFn = util.<span class="title function_">callbackify</span>(fn)</span><br><span class="line"><span class="title function_">newFn</span>(<span class="string">&#x27;test&#x27;</span>, <span class="function">(<span class="params">err, value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value) <span class="comment">// test</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>手写 callbackify</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">fn</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&#x27;error&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resolve</span>(type)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// const newFn = util.callbackify(fn)</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callbackify</span> = (<span class="params">fn</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将回调函数取出</span></span><br><span class="line">    <span class="keyword">const</span> callback = args.<span class="title function_">pop</span>()</span><br><span class="line">    <span class="title function_">fn</span>(...args)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>(<span class="literal">null</span>, value)</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>(err)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> newFn = <span class="title function_">callbackify</span>(fn)</span><br><span class="line"><span class="title function_">newFn</span>(<span class="string">&#x27;test&#x27;</span>, <span class="function">(<span class="params">err, value</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value) <span class="comment">// test</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="inspect"><a href="#inspect" class="headerlink" title="inspect"></a>inspect</h2><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/util.html#utilinspectobject-options">inspect</a> 将对象转换为字符串，通常用于调试和错误输出</p>
<p><code>util.inspect(object[, options])</code></p>
<p>options配置项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. showHidden &lt;boolean&gt; 如果值为 true，则 object 的不可枚举符号和属性包含在格式化的结果中。WeakMap 和 WeakSet 条目以及用户定义的原型属性（不包括方法属性）也包括在内。默认值：false。</span><br><span class="line">2. depth &lt;number&gt; 表示最大递归的层数，如果对象很复杂，可以指定层数以控制输出对象的深度。如果不指定depth，默认会递归 2 层，指定为 null 表示将不限递归层数完整遍历对象（递归到最大调用堆栈大小）。</span><br><span class="line">3. color  &lt;boolean&gt; 如果为 true，输出格式将会以 ANSI 颜色编码，通常用于在终端显示更漂亮 的效果。[自定义 inspect 颜色](https://nodejs.cn/api/util.html#customizing-utilinspect-colors)</span><br><span class="line">4. breakLength &lt;integer&gt; 输入值在多行中拆分的长度。 设置为 Infinity 以将输入格式化为单行（结合 compact 设置为 true 或任何数字 &gt;= 1）。 默认值： 80。</span><br><span class="line">5. showProxy &lt;boolean&gt; 如果 true，Proxy 检查包括 target 和 handler 对象。默认值：false。</span><br><span class="line">6. compact &lt;boolean&gt; 如果为 true，则输出将尽可能紧凑，例如在数组和对象周围省略空格。默认值：false。</span><br><span class="line">7. sorted &lt;boolean&gt; 如果为 true，则输出的对象属性将按属性名排序。默认值：false。</span><br><span class="line">8. getters &lt;boolean&gt; 如果为 true，则输出将包括对象的 getter 函数的返回值。默认值：false。</span><br><span class="line">9. maxArrayLength &lt;integer&gt; 指定要格式化的数组的最大长度 设置为 Infinity 可以完整遍历数组。默认值：100。</span><br><span class="line">10. maxStringLength &lt;integer&gt; 指定要格式化的字符串的最大长度 设置为 Infinity 可以完整遍历字符串。默认值：100。</span><br><span class="line">11. breakLength &lt;integer&gt; 输入值在多行中拆分的长度。设置为 Infinity 以将输入格式化为单行（结合 compact 设置为 true 或任何数字 &gt;= 1）。默认值：80。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;qx&#x27;</span>,</span><br><span class="line">  <span class="attr">a</span>: &#123; <span class="attr">b</span>: &#123; <span class="attr">c</span>: &#123; <span class="attr">d</span>: <span class="number">1</span> &#125; &#125; &#125;,</span><br><span class="line">  <span class="attr">arr</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(obj, &#123;</span><br><span class="line">  <span class="attr">depth</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">colors</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">showHidden</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">compact</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">maxArrayLength</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">showProxy</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">sorted</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// &#123; name: &#x27;qx&#x27;,</span></span><br><span class="line"><span class="comment">// a: &#123; b: &#123; c: [Object] &#125; &#125;,</span></span><br><span class="line"><span class="comment">// arr: [ 1, 2, 3, ... 2 more items, [length]: 5 ] &#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="format"><a href="#format" class="headerlink" title="format"></a>format</h2><p>类似C中的 printf 的格式字符串</p>
<p>使用第一个参数作为类似 printf 的格式字符串（其可以包含零个或多个格式说明符）来返回格式化的字符串。每个说明符都替换为来自相应参数的转换后的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">util.<span class="title function_">format</span>(format, ...args)</span><br></pre></td></tr></table></figure>
<p>格式说明符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. `%s`: String 将用于转换除 BigInt、Object 和 -0 之外的所有值。 BigInt 值将用 n 表示，没有用户定义的 toString 函数的对象使用具有选项 &#123; depth: 0, colors: false, compact: 3 &#125; 的 util.inspect() 进行检查。</span><br><span class="line">2. `%d`: Number 将用于转换除 BigInt 和 Symbol 之外的所有值。</span><br><span class="line">3. `%i`: parseInt(value, 10) 用于除 BigInt 和 Symbol 之外的所有值。</span><br><span class="line">4. `%f`: parseFloat(value) 用于除 Symbol 之外的所有值。</span><br><span class="line">5. `%j`: JSON。 如果参数包含循环引用，则替换为字符串 &#x27;[Circular]&#x27;。</span><br><span class="line">6. `%o`: Object。 具有通用 JavaScript 对象格式的对象的字符串表示形式。 类似于具有选项 &#123; showHidden: true, showProxy: true &#125; 的 util.inspect()。 这将显示完整的对象，包括不可枚举的属性和代理。</span><br><span class="line">7. `%O`: Object。 具有通用 JavaScript 对象格式的对象的字符串表示形式。 类似于没有选项的 util.inspect()。 这将显示完整的对象，但不包括不可枚举的属性和代理。</span><br><span class="line">8. `%c`: CSS。 此说明符被忽略，将跳过任何传入的 CSS。</span><br><span class="line">9. `%%`: 单个百分号 (&#x27;%&#x27;)。 这不消费参数。</span><br></pre></td></tr></table></figure>
<p>没有匹配到的格式说明符的参数将按空格分隔的列表形式附加到字符串中，每个未匹配的参数都使用 util.inspect() 转换为一个字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">format</span>(<span class="string">&#x27;%s:%s&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>, <span class="string">&#x27;baz&#x27;</span>, &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;));</span><br><span class="line"><span class="comment">// foo:bar baz &#123; a: 1 &#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="pngquant"><a href="#pngquant" class="headerlink" title="pngquant"></a>pngquant</h1><p><a target="_blank" rel="noopener" href="http://pngquant.com/">pngquant</a> 是一个用于压缩 PNG 图像文件的工具，基于 Median Cut 算法</p>
<p>三个参数：</p>
<ol>
<li><code>--output</code> <code>-o</code> 输出文件路径</li>
<li><code>--ext</code> 为输出文件名设置自定义后缀/扩展名</li>
<li><code>--quality min-max</code> 设置压缩质量，0-100，值越大图片越大，效果越好</li>
<li><code>--speed 1-11</code> 设置压缩速度，1最慢，11最快，可能会导致输出图像质量稍微降低，默认3</li>
<li><code>--force</code> <code>-f</code> 强制覆盖已存在的输出文件</li>
<li><code>--skip-if-larger</code> 仅当压缩后的文件比原始文件更小或者压缩后的文件比原始文件更大但是质量更好时才输出文件</li>
<li><code>--strip</code> 去除所有的元数据，包括png文件头信息</li>
<li><code>--verbose</code> <code>-v</code> 输出状态信息</li>
</ol>
<p>封装函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">pngquant</span> = (<span class="params">str</span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">execFile</span>(<span class="string">&#x27;pngquant&#x27;</span>, str.<span class="title function_">split</span>(<span class="string">&quot; &quot;</span>), &#123;</span><br><span class="line">    <span class="attr">cwd</span>: __dirname</span><br><span class="line">  &#125;, <span class="function">(<span class="params">err, stdout</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">pngquant</span>(<span class="string">&#x27;./1.png --output ./2.png -f&#x27;</span>)</span><br><span class="line"><span class="comment">// quality表示图片质量0-100值越大图片越大效果越好</span></span><br><span class="line"><span class="title function_">pngquant</span>(<span class="string">&#x27;./1.png --quality=82 -o ./3.png -f&#x27;</span>)</span><br><span class="line"><span class="comment">// --speed=1: 最慢的速度，产生最高质量的输出图像。</span></span><br><span class="line"><span class="comment">// --speed=11: 最快的速度，但可能导致输出图像质量稍微降低。</span></span><br><span class="line"><span class="title function_">pngquant</span>(<span class="string">&#x27;./1.png --speed=11 --quality=80 -o ./4.png -f&#x27;</span>)</span><br><span class="line"><span class="comment">// --ext 为输出文件名设置自定义后缀/扩展名</span></span><br><span class="line"><span class="title function_">pngquant</span>(<span class="string">&#x27;./1.png --ext new.png -f -v&#x27;</span>) <span class="comment">// 1new.png</span></span><br></pre></td></tr></table></figure>
<h1 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h1><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html">fs</a> 文件系统模块，提供了与文件系统进行交互的能力</p>
<p>所有文件系统操作方法都具有同步、异步回调和基于 promise 的形式</p>
<p>绝大部分方法都能传入options配置项，用于指定编码格式、文件模式等，如果 options 是字符串，则指定编码格式（encoding）</p>
<p>默认返回Buffer，可以通过指定编码格式获取字符串</p>
<figure class="highlight js"><figcaption><span>fs的多种策略</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fsPromises = <span class="built_in">require</span>(<span class="string">&#x27;fs/promises&#x27;</span>) <span class="comment">// 引入promise版本</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="comment">// 异步</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// &lt;Buffer 31 32 33 34 35 36 0d 0a 36 35 34 33 32 31&gt;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 同步，且指定编码格式获取字符串</span></span><br><span class="line"><span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line"><span class="comment">// promise</span></span><br><span class="line">fsPromises.<span class="title function_">readFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>)).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 手动将buffer转换为字符串</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>()) <span class="comment">// 123456</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="线程池使用"><a href="#线程池使用" class="headerlink" title="线程池使用"></a>线程池使用</h2><p>所有基于回调和 promise 的文件系统 API（fs.FSWatcher() 除外）都使用 libuv 的线程池，在事件循环线程之外执行文件系统操作。这些操作不是同步的也不是线程安全的。对同一文件执行多个并发修改时必须小心，否则可能会损坏数据。</p>
<h2 id="flag文件系统标志"><a href="#flag文件系统标志" class="headerlink" title="flag文件系统标志"></a>flag文件系统标志</h2><p>以下标志在 flag 选项接受字符串的任何地方都可以使用</p>
<ol>
<li><code>a</code>: 打开文件进行追加。如果文件不存在，则创建该文件。</li>
<li><code>ax</code>: 类似于 ‘a’ 但如果路径存在则失败。</li>
<li><code>a+</code>: 打开文件进行读取和追加。如果文件不存在，则创建该文件。</li>
<li><code>ax+</code>: 类似于 ‘a+’ 但如果路径存在则失败。</li>
<li><code>as</code>: 以同步模式打开文件进行追加。如果文件不存在，则创建该文件。</li>
<li><code>as+</code>: 以同步模式打开文件进行读取和追加。如果文件不存在，则创建该文件。</li>
<li><code>r</code>: 打开文件进行读取。如果文件不存在，则会发生异常。</li>
<li><code>rs</code>: 打开文件以同步模式读取。如果文件不存在，则会发生异常。</li>
<li><code>r+</code>: 打开文件进行读写。如果文件不存在，则会发生异常。</li>
<li><code>rs+</code>: 以同步模式打开文件进行读写。指示操作系统绕过本地文件系统缓存。这主要用于在 NFS 挂载上打开文件，因为它允许跳过可能过时的本地缓存。它对 I/O 性能有非常实际的影响，因此除非需要，否则不建议使用此标志。这不会将 fs.open() 或 fsPromises.open() 变成同步阻塞调用。如果需要同步操作，应该使用类似 fs.openSync() 的东西。</li>
<li><code>w</code>: 打开文件进行写入。创建（如果它不存在）或截断（如果它存在）该文件。</li>
<li><code>wx</code>: 类似于 ‘w’ 但如果路径存在则失败。</li>
<li><code>w+</code>: 打开文件进行读写。创建（如果它不存在）或截断（如果它存在）该文件。</li>
<li><code>wx+</code>: 类似于 ‘w+’ 但如果路径存在则失败。</li>
</ol>
<p>简单记忆：</p>
<ol>
<li>r：读取</li>
<li>w：写入</li>
<li>s：同步</li>
<li>+：增加相反操作</li>
<li>x：排他方式</li>
</ol>
<h2 id="fd文件描述符"><a href="#fd文件描述符" class="headerlink" title="fd文件描述符"></a>fd文件描述符</h2><p>在 POSIX 系统上，对于每个进程，内核维护一个当前打开的文件和资源表。每个打开的文件都分配有一个简单的数字标识符，称为文件描述符。在系统级，所有文件系统操作都使用这些文件描述符来识别和跟踪每个特定文件。Windows 系统使用不同但概念上相似的机制来跟踪资源。为了方便用户，Node.js 抽象了操作系统之间的差异，并为所有打开的文件分配了一个数字文件描述符。</p>
<p>在 NodeJS 中，每操作一个文件，文件描述符是递增的，文件描述符一般从 3 开始，因为前面有 0、1、2三个比较特殊的描述符，分别代表 stdin（标准输入）、stdout（标准输出）和 stderr（错误输出）。</p>
<p>基于回调的 fs.open() 和同步 fs.openSync() 方法打开一个文件并分配一个新的文件描述符。分配后，文件描述符可用于从文件读取数据、向文件写入数据或请求有关文件的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">open</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, fd</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fd) <span class="comment">// 3，数字文件描述符</span></span><br><span class="line">  <span class="comment">// 将文件描述符传入，获取文件信息</span></span><br><span class="line">  fs.<span class="title function_">fstat</span>(fd, <span class="function">(<span class="params">err, stat</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(stat) <span class="comment">// 文件信息</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 关闭文件</span></span><br><span class="line">  fs.<span class="title function_">close</span>(fd, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;关闭成功&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>操作系统限制在任何给定时间可能打开的文件描述符的数量，因此在操作完成时关闭描述符至关重要。否则将导致内存泄漏，最终导致应用崩溃。</p>
<h2 id="fsPromises"><a href="#fsPromises" class="headerlink" title="fsPromises"></a>fsPromises</h2><p>基于 promise 的操作会返回一个当异步操作完成时被履行的 promise。</p>
<p>通常不直接使用 fsPromises 操作文件，而是用 fsPromises.open() 创建一个 FileHandle（数字文件描述符的封装） 对象，每个描述符都会绑定到一个特定的文件。然后使用 FileHandle 执行文件操作。</p>
<p>使用 FileHandle 好处：</p>
<ol>
<li>FileHandle 对象可以在多个操作之间共享，从而避免了在每个操作中打开和关闭文件的开销。</li>
<li>可以精确地控制文件的打开和关闭。</li>
<li>一些文件操作可能在底层实现上更为高效。</li>
<li>封装、代替数字文件描述符。FileHandle对象由系统更好地管理，以确保资源不泄漏。但仍然应该显示调用 close() 方法来关闭 FileHandle 对象，以便释放系统资源。当 FileHandle 已关闭且不再可用时，会触发 close 事件。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fd = <span class="keyword">await</span> fsPromises.<span class="title function_">open</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> fd.<span class="title function_">readFile</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line"><span class="keyword">await</span> fd.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure>
<h2 id="access"><a href="#access" class="headerlink" title="access"></a>access</h2><p><code>access(path[, mode], callback)</code> 测试用户对 path 指定的文件或目录的权限。</p>
<p>mode 值为<a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html#file-access-constants">文件访问常量</a>，指定要执行的可访问性检查。默认值：fs.constants.F_OK</p>
<ol>
<li>F_OK 指示文件对调用进程可见的标志。用于确定文件是否存在，但没有说明 rwx 权限。</li>
<li>R_OK    指示文件可以被调用进程读取的标志。</li>
<li>W_OK    指示文件可以被调用进程写入的标志。</li>
<li>X_OK    指示文件可以被调用进程执行的标志。这对 Windows 没有影响（将表现得像 fs.constants.F_OK）。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> file = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">access</span>(file, fs.<span class="property">constants</span>.<span class="property">F_OK</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;file&#125;</span> <span class="subst">$&#123;err ? <span class="string">&#x27;does not exist&#x27;</span> : <span class="string">&#x27;exists&#x27;</span>&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">fs.<span class="title function_">access</span>(file, fs.<span class="property">constants</span>.<span class="property">R_OK</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;file&#125;</span> <span class="subst">$&#123;err ? <span class="string">&#x27;is not readable&#x27;</span> : <span class="string">&#x27;is readable&#x27;</span>&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">fs.<span class="title function_">access</span>(file, fs.<span class="property">constants</span>.<span class="property">W_OK</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;file&#125;</span> <span class="subst">$&#123;err ? <span class="string">&#x27;is not writable&#x27;</span> : <span class="string">&#x27;is writable&#x27;</span>&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line">fs.<span class="title function_">access</span>(file, fs.<span class="property">constants</span>.<span class="property">R_OK</span> | fs.<span class="property">constants</span>.<span class="property">W_OK</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;file&#125;</span> <span class="subst">$&#123;err ? <span class="string">&#x27;is not&#x27;</span> : <span class="string">&#x27;is&#x27;</span>&#125;</span> readable and writable`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// c:\chuckle\qx\NodeJS-new\fs\1.txt exists</span></span><br><span class="line"><span class="comment">// c:\chuckle\qx\NodeJS-new\fs\1.txt is readable</span></span><br><span class="line"><span class="comment">// c:\chuckle\qx\NodeJS-new\fs\1.txt is writable</span></span><br><span class="line"><span class="comment">// c:\chuckle\qx\NodeJS-new\fs\1.txt is readable and writable</span></span><br></pre></td></tr></table></figure>
<p>在调用 fs.open()、fs.readFile() 或 fs.writeFile() 等文件操作之前，不要使用 fs.access() 检查文件的可访问性。这样做会引入竞争条件，因为其他进程可能会在两次调用之间更改文件的状态。而是，用户代码应直接打开/读取/写入文件，并处理无法访问文件时引发的错误。</p>
<h2 id="readFile文件读取"><a href="#readFile文件读取" class="headerlink" title="readFile文件读取"></a>readFile文件读取</h2><p>readFile用于读取文件内容</p>
<figure class="highlight js"><figcaption><span>同步</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>异步</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fsPromises.<span class="title function_">readFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="createReadStream"><a href="#createReadStream" class="headerlink" title="createReadStream"></a>createReadStream</h2><p><code>createReadStream(path[, options])</code> 创建可读流读取文件，返回一个可读流对象</p>
<p>适合读取大文件，因为不会一次性将文件读取到内存中，而是分块读取</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1、flags (标志) &lt;string&gt;:</span><br><span class="line">意义：指定文件系统标志。它定义了打开文件的行为，比如只读、只写、追加等。</span><br><span class="line">默认值：&#x27;r&#x27;，表示只读。</span><br><span class="line"></span><br><span class="line">2、encoding (编码) &lt;string&gt;:</span><br><span class="line">意义：指定用于解码文件数据的字符编码。如果未提供，则返回原始的 Buffer 数据。</span><br><span class="line">默认值：null，表示使用原始的 Buffer 数据。</span><br><span class="line"></span><br><span class="line">3、fd (文件描述符) &lt;integer&gt; | &lt;FileHandle&gt;:</span><br><span class="line">意义：提供一个现有的文件描述符或 FileHandle 对象，用于打开文件。</span><br><span class="line">默认值：null，表示通过文件路径打开。</span><br><span class="line"></span><br><span class="line">4、mode (权限掩码) &lt;integer&gt;:</span><br><span class="line">意义：指定文件的权限掩码（权限位）。用于在使用 fd 参数时设置文件权限。</span><br><span class="line">默认值：0o666，表示八进制权限掩码。</span><br><span class="line"></span><br><span class="line">5、autoClose (自动关闭) &lt;boolean&gt;:</span><br><span class="line">意义：指定是否在流结束时自动关闭文件描述符。</span><br><span class="line">默认值：true，表示流结束时自动关闭文件。</span><br><span class="line"></span><br><span class="line">6、emitClose (触发关闭事件) &lt;boolean&gt;:</span><br><span class="line">意义：指定是否在文件关闭时触发 &#x27;close&#x27; 事件。</span><br><span class="line">默认值：true，表示触发 &#x27;close&#x27; 事件。</span><br><span class="line"></span><br><span class="line">7、start (起始位置) &lt;integer&gt;:</span><br><span class="line">意义：指定从文件的哪个位置开始读取。</span><br><span class="line">默认值：未指定，从文件开头开始读取。</span><br><span class="line"></span><br><span class="line">8、end (结束位置) &lt;integer&gt;:</span><br><span class="line">意义：指定读取到文件的哪个位置为止。读取将在达到此位置时停止。</span><br><span class="line">默认值：Infinity，表示读取整个文件。</span><br><span class="line"></span><br><span class="line">9、highWaterMark (高水位标记) &lt;integer&gt;:</span><br><span class="line">意义：指定每次读取的最大字节数。当内部缓冲区的数据低于此值时，将继续读取。</span><br><span class="line">默认值：64 * 1024，表示每次最多读取 64 KB。</span><br><span class="line"></span><br><span class="line">10、fs (文件系统) &lt;Object&gt; | &lt;null&gt;:</span><br><span class="line">意义：提供一个自定义的文件系统对象。可以用于替代 Node.js 的默认文件系统模块。</span><br><span class="line">默认值：null，使用 Node.js 的默认文件系统模块。</span><br><span class="line"></span><br><span class="line">11、signal (中止信号) &lt;AbortSignal&gt; | &lt;null&gt;:</span><br><span class="line">意义：指定一个 AbortSignal 对象，用于中止文件读取操作。</span><br><span class="line">默认值：null，表示不使用中止信号。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">readStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="readStream"><a href="#readStream" class="headerlink" title="readStream"></a>readStream</h3><p>可读流对象 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html#%E7%B1%BBfsreadstream">ReadStream</a> 是使用 fs.createReadStream() 创建的</p>
<p>ReadStream 继承自 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E5%8F%AF%E8%AF%BB%E6%B5%81">Readable</a>，因此它具有所有可读流的方法和事件</p>
<p>事件：</p>
<ol>
<li><code>open</code> 当文件被打开时触发</li>
<li><code>close</code> 当文件被关闭时触发</li>
<li><code>ready</code> 当底层资源（比如文件描述符）被分配时触发</li>
<li><code>data</code> 当有数据可读时触发</li>
<li><code>end</code> 当没有更多的数据可读时触发</li>
<li><code>error</code> 当在接收和写入数据的过程中发生错误时触发</li>
<li><code>pause</code> 当调用 stream.pause() 时触发，暂停读取数据</li>
<li><code>resume</code> 当调用 stream.resume() 时触发，恢复读取数据</li>
<li><code>readable</code> 当有数据可读时触发，必须显式调用stream.read()方法来从流中读取数据片段。</li>
</ol>
<p>属性：</p>
<ol>
<li><code>bytesRead</code> 已读取的字节数</li>
<li><code>path</code> 文件路径或文件描述符</li>
<li><code>pending</code> 读取操作是否正在等待底层资源（比如文件描述符），如果底层文件尚未打开，即在触发 ‘ready’ 事件之前，则此属性为 true。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(readStream.<span class="property">path</span>) <span class="comment">// c:\chuckle\qx\NodeJS-new\fs\1.txt</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(readStream.<span class="property">bytesRead</span>) <span class="comment">// 0</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(readStream.<span class="property">pending</span>) <span class="comment">// true</span></span><br><span class="line"><span class="comment">// 监听读取数据</span></span><br><span class="line">readStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(readStream.<span class="property">bytesRead</span>) <span class="comment">// 14</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(readStream.<span class="property">pending</span>) <span class="comment">// false</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data) <span class="comment">// 123456</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 监听读取完成</span></span><br><span class="line">readStream.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;读取完成&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">readStream.<span class="title function_">on</span>(<span class="string">&#x27;pause&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;暂停读取&#x27;</span>)</span><br><span class="line">&#125;) <span class="comment">// 监听暂停事件</span></span><br><span class="line">readStream.<span class="title function_">pause</span>() <span class="comment">// 暂停读取</span></span><br><span class="line">readStream.<span class="title function_">resume</span>() <span class="comment">// 恢复读取</span></span><br><span class="line">readStream.<span class="title function_">on</span>(<span class="string">&#x27;resume&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;恢复读取&#x27;</span>)</span><br><span class="line">&#125;) <span class="comment">// 监听恢复事件</span></span><br></pre></td></tr></table></figure>
<h2 id="writeFile文件写入"><a href="#writeFile文件写入" class="headerlink" title="writeFile文件写入"></a>writeFile文件写入</h2><p><code>writeFile(file, data[, options], (err)=&gt;&#123;&#125;)</code> 将 data 写入到文件指定的 file 中，如果文件已存在则替换该文件</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. encoding &lt;string&gt;:</span><br><span class="line">意义：指定写入文件的字符编码。</span><br><span class="line">默认值：&#x27;utf8&#x27;。</span><br><span class="line"></span><br><span class="line">1. mode &lt;integer&gt;:</span><br><span class="line">意义：指定文件的权限掩码（权限位）。不会应用于已存在的文件。</span><br><span class="line">默认值：0o666。</span><br><span class="line"></span><br><span class="line">1. flag &lt;string&gt;:</span><br><span class="line">意义：指定用于打开文件的标志。</span><br><span class="line">默认值：&#x27;w&#x27;。</span><br><span class="line"></span><br><span class="line">1. signal &lt;AbortSignal&gt;:</span><br><span class="line">意义：指定一个 AbortSignal 对象，用于中止写入操作。</span><br><span class="line">默认值: null。</span><br><span class="line"></span><br><span class="line">1. flush &lt;integer&gt;:</span><br><span class="line">意义：如果所有数据都成功写入文件，并且 flush 是 true，则使用 fs.fsync() 来刷新数据。</span><br><span class="line">默认值： false。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">writeFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;123456&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>修改flag为a，表示追加写入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">writeFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./2.txt&#x27;</span>), <span class="string">&quot;123456&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">flag</span>: <span class="string">&#x27;a&#x27;</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;追加写入成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="appendFile追加写入"><a href="#appendFile追加写入" class="headerlink" title="appendFile追加写入"></a>appendFile追加写入</h2><p><code>appendFile(path, data[, options], (err)=&gt;&#123;&#125;)</code> 异步地将数据追加到文件，如果该文件尚不存在，则创建该文件</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. encoding &lt;string&gt;:</span><br><span class="line">意义：指定写入文件的字符编码。</span><br><span class="line">默认值：&#x27;utf8&#x27;。</span><br><span class="line"></span><br><span class="line">2. mode &lt;integer&gt;:</span><br><span class="line">意义：指定文件的权限掩码（权限位）。不会应用于已存在的文件。</span><br><span class="line">默认值：0o666。</span><br><span class="line"></span><br><span class="line">3. flag &lt;string&gt;:</span><br><span class="line">意义：指定用于打开文件的标志。</span><br><span class="line">默认值：&#x27;a&#x27;。</span><br><span class="line"></span><br><span class="line">4. flush &lt;AbortSignal&gt;:</span><br><span class="line">意义：如果是 true，则在关闭基础文件描述符之前将其刷新。</span><br><span class="line">默认值: false。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">appendFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;123456&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;追加写入成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="createWriteStream"><a href="#createWriteStream" class="headerlink" title="createWriteStream"></a>createWriteStream</h2><p><code>createWriteStream(path[, options])</code> 创建一个可写流写入文件，返回一个可写流对象</p>
<p>适合大内容的写入，因为不会一次性将内容写入文件，而是分块写入</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1、flags (标志) &lt;string&gt;:</span><br><span class="line">意义：指定文件系统标志。它定义了打开文件的行为，比如只读、只写、追加等。</span><br><span class="line">默认值：&#x27;w&#x27;，表示只写。</span><br><span class="line"></span><br><span class="line">2、encoding (编码) &lt;string&gt;:</span><br><span class="line">意义：指定用于解码文件数据的字符编码。如果未提供，则返回原始的 Buffer 数据。</span><br><span class="line">默认值：null，表示使用原始的 Buffer 数据。</span><br><span class="line"></span><br><span class="line">3、fd (文件描述符) &lt;integer&gt; | &lt;FileHandle&gt;:</span><br><span class="line">意义：提供一个现有的文件描述符或 FileHandle 对象，用于打开文件。</span><br><span class="line">默认值：null，表示通过文件路径打开。</span><br><span class="line"></span><br><span class="line">4、mode (权限掩码) &lt;integer&gt;:</span><br><span class="line">意义：指定文件的权限掩码（权限位）。用于在使用 fd 参数时设置文件权限。</span><br><span class="line">默认值：0o666，表示八进制权限掩码。</span><br><span class="line"></span><br><span class="line">5、autoClose (自动关闭) &lt;boolean&gt;:</span><br><span class="line">意义：指定是否在流结束时自动关闭文件描述符。</span><br><span class="line">默认值：true，表示流结束时自动关闭文件。</span><br><span class="line"></span><br><span class="line">6、emitClose (触发关闭事件) &lt;boolean&gt;:</span><br><span class="line">意义：指定是否在文件关闭时触发 &#x27;close&#x27; 事件。</span><br><span class="line">默认值：true，表示触发 &#x27;close&#x27; 事件。</span><br><span class="line"></span><br><span class="line">7、start (起始位置) &lt;integer&gt;:</span><br><span class="line">意义：指定从文件的哪个位置开始写入。</span><br><span class="line">默认值：未指定，从文件末尾开始写入。</span><br><span class="line"></span><br><span class="line">8、signal (中止信号) &lt;AbortSignal&gt; | &lt;null&gt;:</span><br><span class="line">意义：指定一个 AbortSignal 对象，用于中止文件写入操作。</span><br><span class="line">默认值：null，表示不使用中止信号。</span><br><span class="line"></span><br><span class="line">9、highWaterMark (高水位标记) &lt;number&gt;:</span><br><span class="line">意义：指定每次写入的最大字节数。当内部缓冲区的数据低于此值时，将继续写入。</span><br><span class="line">默认值：16 * 1024，表示每次最多写入 16 KB。</span><br><span class="line"></span><br><span class="line">10、flush (刷新) &lt;boolean&gt;:</span><br><span class="line">意义：如果是 true，则在关闭基础文件描述符之前将其刷新</span><br><span class="line">默认值：false，表示不刷新。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">writeStream.<span class="title function_">write</span>(<span class="string">&#x27;123456&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123; &#125;)</span><br><span class="line">writeStream.<span class="title function_">end</span>();</span><br><span class="line">writeStream.<span class="title function_">close</span>();</span><br></pre></td></tr></table></figure>
<h3 id="writeStream"><a href="#writeStream" class="headerlink" title="writeStream"></a>writeStream</h3><p>可写流对象 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html#%E7%B1%BBfswritestream">WriteStream</a> 是使用 fs.createWriteStream() 创建的</p>
<p>WriteStream 继承自 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E5%8F%AF%E5%86%99%E6%B5%81">Writable</a>，因此它具有所有可写流的方法和事件</p>
<p>事件：</p>
<ol>
<li><code>open</code> 当文件被打开时触发</li>
<li><code>close</code> 当文件被关闭时触发</li>
<li><code>ready</code> 当底层资源（比如文件描述符）被分配时触发</li>
<li><code>drain</code> 当 write() 方法返回 false 时触发</li>
<li><code>error</code> 当在接收和写入数据的过程中发生错误时触发</li>
<li><code>finish</code> 在调用 stream.end() 之后，而且缓冲区数据都已经传给底层系统之后触发。</li>
<li><code>pipe</code> 当调用 stream.pipe() 时触发</li>
<li><code>unpipe</code> 当调用 stream.unpipe() 时触发</li>
</ol>
<p>属性：</p>
<ol>
<li><code>bytesWritten</code> 到目前为止写入的字节数。不包括仍在排队等待写入的数据。</li>
<li><code>close(err=&gt;&#123;&#125;)</code> 关闭 writeStream。触发close事件。</li>
<li><code>write(chunk[, encoding][, callback])</code> 写入数据，返回boolean表示是否可以继续写入。返回false需邓艾drain事件触发后再继续写入。</li>
<li><code>end([chunk[, encoding]][, callback])</code> 结束写入，之后不可再写入。触发finish事件</li>
<li><code>path</code> 流正在写入的文件的路径，即 fs.createWriteStream() 的第一个参数。</li>
<li><code>pending</code> 写入操作是否正在等待底层资源（比如文件描述符），如果底层文件尚未打开，即在触发 ‘ready’ 事件之前，则此属性为 true。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">writeStream.<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入流打开&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">writeStream.<span class="title function_">on</span>(<span class="string">&#x27;ready&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;准备写入&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 监听写入完成</span></span><br><span class="line">writeStream.<span class="title function_">on</span>(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入完成&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">writeStream.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入流关闭&#x27;</span>)</span><br><span class="line">  writeStream.<span class="title function_">destroy</span>();</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 写入数据</span></span><br><span class="line">writeStream.<span class="title function_">write</span>(<span class="string">&#x27;123456&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(writeStream.<span class="property">bytesWritten</span>) <span class="comment">// 6</span></span><br><span class="line">  writeStream.<span class="title function_">close</span>();</span><br><span class="line">&#125;)</span><br><span class="line">writeStream.<span class="title function_">end</span>(); <span class="comment">// 结束写入，表示不再有数据写入（end之后不能调用write）</span></span><br></pre></td></tr></table></figure>
<h3 id="drain事件"><a href="#drain事件" class="headerlink" title="drain事件"></a>drain事件</h3><p>可以连续调用 <code>writeStream.write()</code> 向流中写入数据，但缓冲区是有限的，当缓冲区满时，<code>writeStream.write()</code> 将返回 false，表示不应再写入数据，直到触发 <strong>drain</strong> 事件，表示缓冲区已清空，可以继续写入数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> writableStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;example.txt&#x27;</span>, &#123; </span><br><span class="line">  <span class="attr">highWaterMark</span>: <span class="number">30</span> <span class="comment">// 指定缓冲区大小为 30 字节</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 要写入的数据数组</span></span><br><span class="line"><span class="keyword">const</span> dataToWrite = [</span><br><span class="line">  <span class="string">&#x27;待到秋来九月八 &#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;我花开后百花杀 &#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;冲天香阵透长安 &#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;满城尽带黄金甲 &#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// 递归写入数据的函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeDataArray</span>(<span class="params">dataArray, index</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (index &lt; dataArray.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 当前数据</span></span><br><span class="line">    <span class="keyword">const</span> currentData = dataArray[index];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`正在写入数据: <span class="subst">$&#123;currentData&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 尝试写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (!writableStream.<span class="title function_">write</span>(currentData)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;缓冲区已满，后续写入需等待本次写入完成...&#x27;</span>);</span><br><span class="line">      <span class="comment">// 在 drain 事件触发后继续写入下一条数据</span></span><br><span class="line">      writableStream.<span class="title function_">once</span>(<span class="string">&#x27;drain&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`成功写入数据: <span class="subst">$&#123;currentData&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;缓冲区已空，可以继续写入...&#x27;</span>);</span><br><span class="line">        <span class="title function_">writeDataArray</span>(dataArray, index + <span class="number">1</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`成功写入数据: <span class="subst">$&#123;currentData&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 数据已经完全写入，递归调用写入下一条数据</span></span><br><span class="line">      <span class="title function_">writeDataArray</span>(dataArray, index + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 所有数据都已写入，结束可写流</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;所有数据都已写入&#x27;</span>);</span><br><span class="line">    writableStream.<span class="title function_">end</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用写入函数，从数组的第一条数据开始</span></span><br><span class="line"><span class="title function_">writeDataArray</span>(dataToWrite, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">正在写入数据: 待到秋来九月八 </span><br><span class="line">缓冲区已满，后续写入需等待本次写入完成...</span><br><span class="line">成功写入数据: 待到秋来九月八</span><br><span class="line">缓冲区已空，可以继续写入...</span><br><span class="line"></span><br><span class="line">正在写入数据: 我花开后百花杀</span><br><span class="line">缓冲区已满，后续写入需等待本次写入完成...</span><br><span class="line">成功写入数据: 我花开后百花杀</span><br><span class="line">缓冲区已空，可以继续写入...</span><br><span class="line"></span><br><span class="line">正在写入数据: 冲天香阵透长安</span><br><span class="line">缓冲区已满，后续写入需等待本次写入完成...</span><br><span class="line">成功写入数据: 冲天香阵透长安</span><br><span class="line">缓冲区已空，可以继续写入...</span><br><span class="line"></span><br><span class="line">正在写入数据: 满城尽带黄金甲</span><br><span class="line">缓冲区已满，后续写入需等待本次写入完成...</span><br><span class="line">成功写入数据: 满城尽带黄金甲</span><br><span class="line">缓冲区已空，可以继续写入...</span><br><span class="line"></span><br><span class="line">所有数据都已写入</span><br></pre></td></tr></table></figure>
<h2 id="创建文件"><a href="#创建文件" class="headerlink" title="创建文件"></a>创建文件</h2><p>Node没有创建文件的方法，但可以通过open和writeFile方法创建文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将flag设置为a，表示读取和追加，若文件不存在则创建</span></span><br><span class="line">fs.<span class="title function_">openSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./2.txt&#x27;</span>), <span class="string">&#x27;a+&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">writeFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./3.txt&#x27;</span>), <span class="string">&quot;&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">flag</span>: <span class="string">&#x27;a+&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="mkdir创建目录"><a href="#mkdir创建目录" class="headerlink" title="mkdir创建目录"></a>mkdir创建目录</h2><p><code>mkdir(path[, options], callback)</code> 创建目录</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. recursive &lt;boolean&gt;:</span><br><span class="line">意义：指示是否应创建父目录（递归创建多级目录）。如果为 true，则缺少的目录将被创建。</span><br><span class="line">默认值：false。</span><br><span class="line"></span><br><span class="line">2. mode &lt;integer&gt;:</span><br><span class="line">意义：设置目录的权限掩码（权限位）。不会应用于已存在的目录。Windows 上不支持</span><br><span class="line">默认值：0o777。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">mkdir</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./test&#x27;</span>), <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;创建成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">fs.<span class="title function_">mkdir</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./a/b/c&#x27;</span>), &#123;</span><br><span class="line">  <span class="attr">recursive</span>: <span class="literal">true</span> <span class="comment">// 递归创建多级目录</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;创建成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="rm删除文件或目录"><a href="#rm删除文件或目录" class="headerlink" title="rm删除文件或目录"></a>rm删除文件或目录</h2><p><code>rm(path[, options], callback)</code> 删除文件或目录</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. force &lt;boolean&gt;:</span><br><span class="line">意义：当为 true 时，如果 path 不存在，则异常将被忽略</span><br><span class="line">默认值：false。</span><br><span class="line"></span><br><span class="line">2. maxRetries &lt;integer&gt;:</span><br><span class="line">意义：如果遇到 EBUSY、EMFILE、ENFILE、ENOTEMPTY 或 EPERM 错误，Node.js 将在每次尝试时以 retryDelay 毫秒的线性退避等待时间重试该操作。如果为 0，则不会重试。如果 recursive 选项不为 true，则忽略此选项</span><br><span class="line">默认值：0。</span><br><span class="line"></span><br><span class="line">3. recursive &lt;boolean&gt;:</span><br><span class="line">意义：指示是否应递归删除目录。如果为 false，则不会删除目录。</span><br><span class="line">默认值：false。</span><br><span class="line"></span><br><span class="line">4. retryDelay &lt;integer&gt;:</span><br><span class="line">意义：重试之间等待的毫秒数。如果 recursive 选项不为 true，则忽略此选项。</span><br><span class="line">默认值：100。</span><br></pre></td></tr></table></figure>
<p>如果要删除目录，recursive 选项必须为 true</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">rm</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./a.txt&#x27;</span>), <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">fs.<span class="title function_">rm</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./a&#x27;</span>), &#123;</span><br><span class="line">  <span class="attr">recursive</span>: <span class="literal">true</span> <span class="comment">// 递归删除目录</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="rename文件重命名和移动"><a href="#rename文件重命名和移动" class="headerlink" title="rename文件重命名和移动"></a>rename文件重命名和移动</h2><p><code>rename(oldPath, newPath, callback)</code> 将 oldPath 处的文件重命名为作为 newPath 提供的路径名。如果 newPath 已经存在，则它将被覆盖。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">renameSync</span>(</span><br><span class="line">  path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./2.txt&#x27;</span>), </span><br><span class="line">  <span class="comment">// 重命名并移动文件，test文件夹需要存在</span></span><br><span class="line">  path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./test/22.txt&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="watch监视文件"><a href="#watch监视文件" class="headerlink" title="watch监视文件"></a>watch监视文件</h2><p><code>watch(filename[, options][, listener]): &lt;fs.FSWatcher&gt;</code></p>
<p>fs.watch API 跨平台并非 100% 一致，并且在某些情况下不可用，详见：<a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a></p>
<p>在 Windows 上，如果监视目录被移动或重命名，则不会触发任何事件。 删除监视目录时报 EPERM 错误</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. persistent &lt;boolean&gt;:</span><br><span class="line">意义：指示只要正在监视文件，进程是否应继续运行。</span><br><span class="line">默认值：true。</span><br><span class="line"></span><br><span class="line">2. recursive &lt;boolean&gt;:</span><br><span class="line">意义：指示是应监视所有子目录，还是仅监视当前目录。 这在指定目录时适用，并且仅适用于受支持的平台。</span><br><span class="line">默认值：false。</span><br><span class="line"></span><br><span class="line">3. encoding &lt;string&gt; | &lt;null&gt;:</span><br><span class="line">意义：指定用于传递回调的文件名的字符编码。如果未指定，则返回原始的 Buffer。</span><br><span class="line">默认值：null。</span><br><span class="line"></span><br><span class="line">4. signal &lt;AbortSignal&gt; | &lt;null&gt;:</span><br><span class="line">意义：指定一个 AbortSignal 对象，用于中止监视器。</span><br><span class="line">默认值：null。</span><br></pre></td></tr></table></figure>
<p>监视器回调接受eventType事件类型、filename文件名两个参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> watcher = fs.<span class="title function_">watch</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>),</span><br><span class="line">  <span class="function">(<span class="params">eventType, filename</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(eventType, filename) <span class="comment">// change 1.txt</span></span><br><span class="line">  &#125;) <span class="comment">// 监听文件变化</span></span><br><span class="line"><span class="comment">// watcher.on(&#x27;change&#x27;, (eventType, filename) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//   console.log(eventType, filename)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;关闭watch&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 修改文件，文件已存在会先替换再写入，触发两次change事件</span></span><br><span class="line">fs.<span class="title function_">writeFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>), <span class="string">&#x27;123456&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入成功&#x27;</span>)</span><br><span class="line">  watcher.<span class="title function_">close</span>() <span class="comment">// 关闭监听</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="readdir读取目录"><a href="#readdir读取目录" class="headerlink" title="readdir读取目录"></a>readdir读取目录</h2><p><code>readdir(path[, options], (err, files)=&gt;&#123;&#125;)</code> 获取一个文件夹下所有文件名的数组</p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. encoding &lt;string&gt;:</span><br><span class="line">意义：指定用于解码文件名的字符编码。</span><br><span class="line">默认值：&#x27;utf8&#x27;</span><br><span class="line"></span><br><span class="line">2. withFileTypes &lt;boolean&gt;:</span><br><span class="line">意义：如果为 true，则将结果数组中的条目替换为 fs.Dirent 对象。</span><br><span class="line">默认值：false</span><br><span class="line"></span><br><span class="line">3. recursive &lt;boolean&gt;:</span><br><span class="line">意义：指示是否应递归读取子目录。如果为 true，则返回的数组将包含子目录中的文件的名称。</span><br><span class="line">默认值：false</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readdir</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./&#x27;</span>),&#123;</span><br><span class="line">  <span class="attr">recursive</span>: <span class="literal">true</span> <span class="comment">// 递归读取目录</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(files)</span><br><span class="line">  <span class="comment">// [ &#x27;1.txt&#x27;, &#x27;2.txt&#x27;, &#x27;index.js&#x27;, &#x27;test&#x27;, &#x27;test\\a.txt&#x27; ]</span></span><br><span class="line">&#125;)</span><br><span class="line">fs.<span class="title function_">readdir</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./&#x27;</span>),&#123;</span><br><span class="line">  <span class="attr">withFileTypes</span>: <span class="literal">true</span> <span class="comment">// 返回Dirent对象</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(files)</span><br><span class="line">  <span class="comment">// [</span></span><br><span class="line">  <span class="comment">//   Dirent &#123;</span></span><br><span class="line">  <span class="comment">//     name: &#x27;1.txt&#x27;,</span></span><br><span class="line">  <span class="comment">//     path: &#x27;c:\\chuckle\\qx\\NodeJS-new\\fs&#x27;,</span></span><br><span class="line">  <span class="comment">//     [Symbol(type)]: 1</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  <span class="comment">// ]</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>批量重命名文件，在文件名前加上0</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readdir</span>(__dirname + <span class="string">&#x27;/rename&#x27;</span>, <span class="function">(<span class="params">err, data</span>)=&gt;</span>&#123;</span><br><span class="line">    data.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item, index</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> data = item.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">let</span> [num, suffix] = data;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Number</span>(num)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">            num = <span class="string">&#x27;0&#x27;</span> + num;</span><br><span class="line">        &#125;</span><br><span class="line">        fs.<span class="title function_">renameSync</span>(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/rename/<span class="subst">$&#123;item&#125;</span>`</span>, <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/rename/<span class="subst">$&#123;num&#125;</span>.<span class="subst">$&#123;suffix&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="软-硬链接"><a href="#软-硬链接" class="headerlink" title="软/硬链接"></a>软/硬链接</h2><p>链接实际上是一种文件共享的方式</p>
<p><code>linkSync(existingPath, newPath)</code> 创建硬链接，newPath 指向 existingPath，两个文件共享同一份数据<br><code>symlinkSync(target, path[, type])</code> 创建软链接，path 指向 target，target 可以是绝对路径或相对路径，type 仅在 Windows 上有效，默认为 ‘file’，可以是 ‘dir’ 或 ‘junction’</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> file = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">linkSync</span>(file, path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index2.txt&#x27;</span>)) <span class="comment">//硬链接</span></span><br><span class="line">fs.<span class="title function_">symlinkSync</span>(file, path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index3.txt&#x27;</span>)) <span class="comment">//软连接</span></span><br></pre></td></tr></table></figure>
<p><code>unlink(path, err=&gt;&#123;&#125;)</code> 删除文件或符号链接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">unlinkSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./index.txt&#x27;</span>)) <span class="comment">// 删除文件</span></span><br><span class="line">fs.<span class="title function_">unlinkSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./index2.txt&#x27;</span>)) <span class="comment">// 删除硬链接</span></span><br><span class="line">fs.<span class="title function_">unlinkSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./index3.txt&#x27;</span>)) <span class="comment">// 删除软连接</span></span><br></pre></td></tr></table></figure>
<p>硬链接：</p>
<ol>
<li><strong>文件共享</strong>：硬链接允许多个文件指向同一个文件（同一个 inode），这样可以在不同的位置使用不同的文件名引用相同的内容。这样的共享文件可以节省存储空间，并且在多个位置对文件的修改会反映在所有引用文件上。</li>
<li><strong>文件备份</strong>：通过创建硬链接，可以在不复制文件的情况下创建文件的备份。如果原始文件发生更改，备份文件也会自动更新。这样可以节省磁盘空间，并确保备份文件与原始文件保持同步。</li>
<li><strong>文件重命名</strong>：通过创建硬链接，可以为文件创建一个新的文件名，而无需复制或移动文件。这对于需要更改文件名但保持相同内容和属性的场景非常有用。</li>
</ol>
<p>只有删除原始文件和所有硬链接后，才会真正删除文件</p>
<p>软链接：</p>
<ol>
<li>软链接实际上是保存了一个绝对路径</li>
<li><strong>跨文件系统</strong>：软链接可以跨越文件系统，而硬链接不能。硬链接只能在同一文件系统上工作，因为它们指向的是 inode，而 inode 只在文件系统内部唯一。</li>
<li><strong>符号链接</strong>：软链接是一个特殊类型的文件，它包含指向另一个文件的路径名。软链接可以指向任何类型的文件，包括目录，而硬链接只能指向普通文件。</li>
</ol>
<p>重命名或移动原始文件的位置，会导致软链接失效，需要更新目标路径，而硬链接仍然有效</p>
<h3 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h3><p><strong>inode (index node)</strong>是指在许多类Unix文件系统中的一种数据结构，用于描述文件系统对象（包括文件、目录、设备文件、socket、管道等）。每个inode保存了文件系统对象数据的属性和磁盘块（block）位置。文件系统对象属性包含了各种元数据（如：最后修改时间），也包含用户组（owner ）和权限数据。</p>
<p>文件储存在硬盘上，硬盘的最小存储单位叫做”扇区”（Sector）。每个扇区储存512字节（相当于0.5KB）。操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个”块”（block）。这种由多个扇区组成的”块”，是文件存取的最小单位。”块”的大小，最常见的是4KB，即连续八个 sector组成一个 block。</p>
<p>简单的说：每一个文件都有对应的inode，里面包含了与该文件有关的一些信息。</p>
<ol>
<li>文件的字节数</li>
<li>文件拥有者的User ID</li>
<li>文件的Group ID</li>
<li>文件的读、写、执行权限</li>
<li>文件的时间戳，共有三个：ctime指inode上一次变动的时间，mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。</li>
<li>链接数，即有多少文件名指向这个inode</li>
<li>文件数据block的位置</li>
</ol>
<p>打开文件时，系统首先找到文件名对应的 inode 号码，然后通过 inode 号码获取inode 信息，然后根据 inode 信息中的文件数据所在 block 读出数据。</p>
<p><code>statSync(path[, options])</code> 可以查看文件的inode信息，返回 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/fs.html#class-fsstats">fs.Stats</a></p>
<figure class="highlight txt"><figcaption><span>options配置项</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. bigint &lt;boolean&gt;:</span><br><span class="line">意义：指示是否应该返回 fs.BigInt 类型的数值，否则返回 number 类型的整数。</span><br><span class="line">默认值：false。</span><br><span class="line"></span><br><span class="line">2. throwIfNoEntry &lt;boolean&gt;:</span><br><span class="line">意义：如果文件系统条目不存在，是否会抛出异常，而不是返回 undefined</span><br><span class="line">默认值：false。</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stat = fs.<span class="title function_">statSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./1.txt&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isDirectory</span>()); <span class="comment">// 是否是文件夹</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isFile</span>()); <span class="comment">// 是否是普通文件</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isSymbolicLink</span>()) <span class="comment">// 是否是软连接</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isBlockDevice</span>()) <span class="comment">// 是否是块设备</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isCharacterDevice</span>()) <span class="comment">// 是否是字符设备</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isFIFO</span>()) <span class="comment">// 是否是FIFO</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(stat.<span class="title function_">isSocket</span>()) <span class="comment">// 是否是Socket</span></span><br><span class="line"><span class="comment">// Stats &#123;</span></span><br><span class="line"><span class="comment">//   dev: 1552965699,</span></span><br><span class="line"><span class="comment">//   mode: 33206,</span></span><br><span class="line"><span class="comment">//   nlink: 3,</span></span><br><span class="line"><span class="comment">//   uid: 0,</span></span><br><span class="line"><span class="comment">//   gid: 0,</span></span><br><span class="line"><span class="comment">//   rdev: 0,</span></span><br><span class="line"><span class="comment">//   blksize: 4096,</span></span><br><span class="line"><span class="comment">//   ino: 10696049115741484,</span></span><br><span class="line"><span class="comment">//   size: 6,</span></span><br><span class="line"><span class="comment">//   blocks: 0,</span></span><br><span class="line"><span class="comment">//   atimeMs: 1705127903632.4563,</span></span><br><span class="line"><span class="comment">//   mtimeMs: 1705127903632.4563,</span></span><br><span class="line"><span class="comment">//   ctimeMs: 1705127903632.4563,</span></span><br><span class="line"><span class="comment">//   birthtimeMs: 1705043183050.7405,</span></span><br><span class="line"><span class="comment">//   atime: 2024-01-13T06:38:23.632Z,</span></span><br><span class="line"><span class="comment">//   mtime: 2024-01-13T06:38:23.632Z,</span></span><br><span class="line"><span class="comment">//   ctime: 2024-01-13T06:38:23.632Z,</span></span><br><span class="line"><span class="comment">//   birthtime: 2024-01-12T07:06:23.051Z</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="Stream流"><a href="#Stream流" class="headerlink" title="Stream流"></a>Stream流</h1><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html">stream</a>（流）是一种抽象的数据结构。就像数组或字符串一样，流是数据的集合。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6854573219060400141">一文搞定 Node.js 流 （Stream）</a></p>
<p>stream 就像是水流，但默认是没有水的。stream.write 可以让水流中有水，也就是写入数据。</p>
<p><strong>作用：</strong>大文件资源拆分成小块（chunk），一块一块的运输，资源就像水流一样进行传输，无需将文件整个读入内存，减轻服务器压力。</p>
<p>四种类型的流：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamreadable">Readable</a> 可读流</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamwritable">Writable</a> 可写流</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamduplex">Duplex</a> 可读可写流，读和写是各自独立的</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamtransform">Transform</a> 可读可写流，读写在同一个流中，在读写过程中可以修改和变换数据</li>
</ol>
<p>Node中Stream无处不在，对服务器发起 http 请求的 request/response 对象也是 Stream。</p>
<h2 id="Readable可读流"><a href="#Readable可读流" class="headerlink" title="Readable可读流"></a>Readable可读流</h2><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamreadable">Readable</a></p>
<p>可读流中分为2种模式</p>
<ol>
<li>流动模式：监听data事件，一旦有数据就会触发data事件，数据作为回调的参数，直到数据全部读取完毕</li>
<li>暂停模式：监听readable事件，当流有了新数据或到了流结束之前触发readable事件，需要显示调用read([size])读取数据</li>
</ol>
<p>暂停模式切换到流动模式：</p>
<ol>
<li>监听 data 事件</li>
<li>调用 stream.resume()方法</li>
<li>调用 stream.pipe()方法将数据发送到可写流</li>
</ol>
<p>流动模式切换到暂停模式：</p>
<ol>
<li>如果不存在管道目标，调用 stream.pause() 方法</li>
<li>如果存在管道目标，调用 stream.unpipe() 并取消 data 事件监听</li>
</ol>
<figure class="highlight js"><figcaption><span>Readable简单示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Readable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> inStream = <span class="keyword">new</span> <span class="title class_">Readable</span>() <span class="comment">// 可以在其中实现_read方法</span></span><br><span class="line">inStream.<span class="title function_">push</span>(<span class="string">&#x27;hello world&#x27;</span>) <span class="comment">// 写入数据</span></span><br><span class="line">inStream.<span class="title function_">push</span>(<span class="string">&#x27;hello node&#x27;</span>)</span><br><span class="line">inStream.<span class="title function_">push</span>(<span class="literal">null</span>) <span class="comment">// 没有数据了</span></span><br><span class="line"><span class="comment">// 将这个可读流，导入到可写流 process.stdout。</span></span><br><span class="line">inStream.<span class="title function_">pipe</span>(process.<span class="property">stdout</span>)</span><br></pre></td></tr></table></figure>
<p><strong>详见fs中的<a href="#createreadstream">createReadStream</a></strong></p>
<h2 id="Writable可写流"><a href="#Writable可写流" class="headerlink" title="Writable可写流"></a>Writable可写流</h2><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamwritable">Writable</a></p>
<figure class="highlight js"><figcaption><span>Writable简单示例</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> outStream = <span class="keyword">new</span> <span class="title class_">Writable</span>(&#123;</span><br><span class="line">  <span class="comment">// 实现_write方法</span></span><br><span class="line">  <span class="title function_">write</span>(<span class="params">chunk, encoding, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>())</span><br><span class="line">    <span class="title function_">callback</span>() <span class="comment">// 通知流处理继续</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">process.<span class="property">stdin</span>.<span class="title function_">pipe</span>(outStream);</span><br></pre></td></tr></table></figure>
<p><strong>详见fs中的<a href="#createwritestream">createWriteStream</a></strong></p>
<h2 id="Duplex流"><a href="#Duplex流" class="headerlink" title="Duplex流"></a>Duplex流</h2><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamduplex">Duplex</a> 可读可写流，读和写是独立的，各自独立缓存区，既可当成可读流来使用，也可当成可写流来使用</p>
<p>Duplex 拥有 Writable 和 Readable 所有方法和事件，可以同时实现 read() 和 write() 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Duplex</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> duplex = <span class="keyword">new</span> <span class="title class_">Duplex</span>(&#123;</span><br><span class="line">  <span class="comment">// 可读端底层读取逻辑</span></span><br><span class="line">  <span class="title function_">read</span>(<span class="params">size</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentCharCode</span> &gt; <span class="number">90</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">push</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">push</span>(<span class="literal">null</span>) <span class="comment">// null 代表流没有数据了，不会触发data事件</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 通过push方法将数据推送到可读流，每次push都会触发一次data事件</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">push</span>(<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="variable language_">this</span>.<span class="property">currentCharCode</span>++))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 可写端底层写逻辑</span></span><br><span class="line">  <span class="title function_">write</span>(<span class="params">buf, enc, next</span>) &#123;</span><br><span class="line">    process.<span class="property">stdout</span>.<span class="title function_">write</span>(<span class="string">&#x27;write: &#x27;</span> + buf.<span class="title function_">toString</span>().<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="title function_">next</span>() <span class="comment">// 通知流处理继续</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">duplex.<span class="property">currentCharCode</span> = <span class="number">65</span>;</span><br><span class="line">duplex.<span class="title function_">pipe</span>(process.<span class="property">stdout</span>);</span><br><span class="line"><span class="comment">// ABCDEFGHIJKLMNOPQRSTUVWXYZ</span></span><br><span class="line">process.<span class="property">stdin</span>.<span class="title function_">pipe</span>(duplex);</span><br><span class="line"><span class="comment">// 小写输入转为大写</span></span><br><span class="line"><span class="comment">// aaaa</span></span><br><span class="line"><span class="comment">// write: AAAA</span></span><br></pre></td></tr></table></figure>
<h2 id="Transform流"><a href="#Transform流" class="headerlink" title="Transform流"></a>Transform流</h2><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamtransform">Transform</a> 流属于 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/stream.html#%E7%B1%BBstreamduplex">Duplex</a> 流，其中输出以某种方式从输入计算得出。<br>例如进行压缩、加密或解密数据的 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/zlib.html">zlib</a> 流或 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html">crypto</a> 流。</p>
<p>使用也很简单，<code>new Transform(&#123; transform() &#125;)</code>，传入包括实现了 transform() 方法的对象，该方法接收三个参数：chunk、encoding、callback</p>
<ol>
<li>chunk：读取到的数据块</li>
<li>encoding：编码方式</li>
<li>callback：回调函数，通知流处理继续</li>
</ol>
<p>读数据：<code>chunk.toString()</code><br>写数据 <code>this.push(xxx)</code></p>
<figure class="highlight js"><figcaption><span>以大写的格式打印任何键入的字符</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">Transform</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> upperCaseTr = <span class="keyword">new</span> <span class="title class_">Transform</span>(&#123;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">chunk, encoding, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(chunk.<span class="title function_">toString</span>().<span class="title function_">toUpperCase</span>())</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.<span class="property">stdin</span></span><br><span class="line">  .<span class="title function_">pipe</span>(upperCaseTr) </span><br><span class="line">	.<span class="title function_">pipe</span>(process.<span class="property">stdout</span>)</span><br></pre></td></tr></table></figure>
<h2 id="pipe管道"><a href="#pipe管道" class="headerlink" title="pipe管道"></a>pipe管道</h2><p>pipe 管道可以连接两个流，将一个流的输出作为另一个流的输入</p>
<p><code>stream1.pipe(stream2)</code><br>stream1 是发出数据的流，一个可读流。<br>stream2 是写入数据的流，一个可写流。</p>
<p>readable.pipe() 方法将 Writable 流绑定到 readable，使其自动切换到流动模式并将其所有数据推送到绑定的 Writable。数据流将被自动管理，以便目标 Writable 流不会被更快的 Readable 流漫过。</p>
<p>例如响应大文本和大图片：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>();</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 根据请求路径判断是文本请求还是图片请求</span></span><br><span class="line">  <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&#x27;/txt&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./big_data.txt&#x27;</span>));</span><br><span class="line">    <span class="comment">// 通过管道方式写入响应，读多少传多少</span></span><br><span class="line">    stream.<span class="title function_">pipe</span>(response);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&#x27;/img&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./big_img.png&#x27;</span>));</span><br><span class="line">    <span class="comment">// 设置响应头，告诉浏览器这是一个图片</span></span><br><span class="line">    response.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;image/png&#x27;</span>);</span><br><span class="line">    stream.<span class="title function_">pipe</span>(response);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 处理其他请求或返回 404 Not Found</span></span><br><span class="line">    response.<span class="property">statusCode</span> = <span class="number">404</span>;</span><br><span class="line">    response.<span class="title function_">end</span>(<span class="string">&#x27;Not Found&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running on http://localhost:8888&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>链式操作：</strong>一个水流可以经过无限个管道，数据流也一样。在链式操作过程中可以对数据进行转换、压缩等处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&#x27;zlib&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> stream = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建可读流</span></span><br><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;input.txt&#x27;</span>));</span><br><span class="line"><span class="comment">// 创建可写流</span></span><br><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;output.txt.gz&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建转换流，将文本内容转换为大写</span></span><br><span class="line"><span class="keyword">const</span> upperCaseTransform = <span class="keyword">new</span> stream.<span class="title class_">Transform</span>(&#123;</span><br><span class="line">  <span class="title function_">transform</span>(<span class="params">chunk, encoding, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 将数据转换为大写</span></span><br><span class="line">    <span class="keyword">const</span> upperCaseData = chunk.<span class="title function_">toString</span>().<span class="title function_">toUpperCase</span>();</span><br><span class="line">    <span class="comment">// 将转换后的数据推送到可读流</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">push</span>(upperCaseData);</span><br><span class="line">    <span class="comment">// 转换完成后调用回调函数，通知流处理继续</span></span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建压缩流</span></span><br><span class="line"><span class="keyword">const</span> gzipStream = zlib.<span class="title function_">createGzip</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将各个流连接起来形成管道链式操作</span></span><br><span class="line">readStream</span><br><span class="line">  .<span class="title function_">pipe</span>(upperCaseTransform) <span class="comment">// 转换为大写</span></span><br><span class="line">  .<span class="title function_">pipe</span>(gzipStream) <span class="comment">// 压缩</span></span><br><span class="line">  .<span class="title function_">pipe</span>(writeStream) <span class="comment">// 写入文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听完成事件</span></span><br><span class="line">writeStream.<span class="title function_">on</span>(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件处理完成&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>既然都是 stream 那么其它流方法也能套在链式过程中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;big_data.txt&#x27;</span>))</span><br><span class="line">  .<span class="title function_">pipe</span>(zlib.<span class="title function_">createGzip</span>())</span><br><span class="line">  <span class="comment">// 每次产生一块压缩数据时，执行提供的回调函数</span></span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">() =&gt;</span> process.<span class="property">stdout</span>.<span class="title function_">write</span>(<span class="string">&quot;.&quot;</span>)) <span class="comment">// 打出进度条</span></span><br><span class="line">  .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;big_data.txt.gz&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<h2 id="管道原理"><a href="#管道原理" class="headerlink" title="管道原理"></a>管道原理</h2><p>管道可以认为是两个事件的封装</p>
<ol>
<li>监听 data 事件，stream1 一有数据就塞给 stream2</li>
<li>监听 end 事件，当 stream1 停了，就停掉 stream2</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stream1.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">	stream2.<span class="title function_">write</span>(chunk)</span><br><span class="line">&#125;)</span><br><span class="line">stream1.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	stream2.<span class="title function_">end</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html">crypto</a> 模块提供了加密功能，其中包括了用于 OpenSSL 散列、HMAC、加密、解密、签名、以及验证的函数的一整套封装。</p>
<p>crypto有非常多的API，但主要有几个类，每个类都有许多<a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#nodecrypto-%E6%A8%A1%E5%9D%97%E6%96%B9%E6%B3%95%E5%92%8C%E5%B1%9E%E6%80%A7">模块方法</a>（<code>create***()</code>）去生成其实例，然后调用实例的方法去实现加密解密等功能</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBcipher">Cipher</a>类的实例用于对称加密数据</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBdecipher">Decipher</a>类的实例用于解密数据</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBhash">Hash</a>类是用于创建数据的哈希摘要的实用工具</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBhmac">Hmac</a>类是用于创建加密 HMAC 摘要的实用工具</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBkeyobject">KeyObject</a>类表示对称或非对称密钥，每种密钥暴露不同的功能</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBsign">Sign</a>类是用于生成签名的实用工具</li>
<li><a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#%E7%B1%BBverify">Verify</a>类是用于验证签名的实用工具</li>
</ol>
<p>本文后面需要加密的data都为 ‘hello world’</p>
<h2 id="摘要Hash"><a href="#摘要Hash" class="headerlink" title="摘要Hash"></a>摘要Hash</h2><p>摘要（digest）：将长度不固定的消息作为输入，通过运行hash函数，生成固定长度的输出，这段输出就叫做摘要，具有唯一性。通常用来验证消息完整、未被篡改。摘要运算是不可逆的，但可以撞库破解。</p>
<p>摘要算法：MD5、SHA1、SHA256、SHA512</p>
<p><code>crypto.getHashes()</code> 返回支持的哈希算法名称的数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(crypto.<span class="title function_">getHashes</span>())</span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-MD5&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-RIPEMD160&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA1&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA1-2&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA3-224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA3-256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA3-384&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA3-512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA384&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA512/224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SHA512/256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;RSA-SM3&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;blake2b512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;blake2s256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;id-rsassa-pkcs1-v1_5-with-sha3-224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;id-rsassa-pkcs1-v1_5-with-sha3-256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;id-rsassa-pkcs1-v1_5-with-sha3-384&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;id-rsassa-pkcs1-v1_5-with-sha3-512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;md5&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;md5-sha1&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;md5WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;ripemd&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;ripemd160&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;ripemd160WithRSA&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;rmd160&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha1&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha1WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha224WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha256WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha3-224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha3-256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha3-384&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha3-512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha384&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha384WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512-224&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512-224WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512-256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512-256WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sha512WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;shake128&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;shake256&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sm3&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;sm3WithRSAEncryption&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;ssl3-md5&#x27;,</span></span><br><span class="line"><span class="comment">//   &#x27;ssl3-sha1&#x27;</span></span><br><span class="line"><span class="comment">// ]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line"><span class="comment">// 创建哈希对象，并使用 MD5 算法</span></span><br><span class="line"><span class="keyword">const</span> hash = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line"><span class="comment">// 更新哈希对象的数据</span></span><br><span class="line">hash.<span class="title function_">update</span>(data)</span><br><span class="line"><span class="comment">// 计算哈希值，并以十六进制字符串形式输出</span></span><br><span class="line"><span class="keyword">const</span> digest = hash.<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(digest) <span class="comment">// 5eb63bbbe01eeed093cb22bb8f5acdc3</span></span><br></pre></td></tr></table></figure>
<h2 id="MAC、HMAC"><a href="#MAC、HMAC" class="headerlink" title="MAC、HMAC"></a>MAC、HMAC</h2><p>MAC（Message Authentication Code）：消息认证码，用以保证数据的完整性。运算结果取决于消息本身、秘钥。</p>
<p>MAC可以有多种不同的实现方式，比如Hash、HMAC。</p>
<p>HMAC（Hash-based Message Authentication Code）：可以粗略地理解为带秘钥的Hash函数。主要是为了防止Hash碰撞攻击。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hmac = crypto.<span class="title function_">createHmac</span>(<span class="string">&#x27;md5&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">hmac.<span class="title function_">update</span>(data)</span><br><span class="line"><span class="keyword">const</span> digest = hmac.<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(digest) <span class="comment">// 5eb63bbbe01eeed093cb22bb8f5acdc3</span></span><br></pre></td></tr></table></figure>
<h2 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h2><p><strong>加密/解密：</strong>给定明文，通过一定的算法，产生加密后的密文，这个过程叫加密。反过来就是解密。</p>
<p><strong>秘钥：</strong>为了进一步增强加/解密算法的安全性，在加/解密的过程中引入了秘钥。秘钥可以视为加/解密算法的参数，在已知密文的情况下，如果不知道解密所用的秘钥，则无法将密文解开。</p>
<p>根据加密、解密所用的秘钥是否相同，可以将加密算法分为对称加密、非对称加密。</p>
<p>常见的对称加密算法：DES、3DES、AES、Blowfish、RC5、IDEA。</p>
<p><code>createCipher()</code>(已弃用) 或 <code>createCipheriv()</code> 方法用于创建 Cipher 实例，使用初始化向量IV增加加密强度，IV 通常只是添加到未加密的密文消息中，解密后会被删除。</p>
<p><code>createDecipher()</code>(已弃用) 或 <code>createDecipheriv()</code> 方法用于创建 Decipher 实例，使用相同的密钥和IV进行解密。</p>
<figure class="highlight js"><figcaption><span>加密过程</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个随机的 16 字节的初始化向量 (IV)</span></span><br><span class="line"><span class="keyword">const</span> iv = crypto.<span class="title function_">randomBytes</span>(<span class="number">16</span>)</span><br><span class="line"><span class="comment">// 生成一个随机的 32 字节的密钥</span></span><br><span class="line"><span class="keyword">const</span> key = crypto.<span class="title function_">randomBytes</span>(<span class="number">32</span>)</span><br><span class="line"><span class="comment">// 创建一个 AES-256-CBC 加密算法的 cipher 对象</span></span><br><span class="line"><span class="keyword">const</span> cipher = crypto.<span class="title function_">createCipheriv</span>(<span class="string">&#x27;aes-256-cbc&#x27;</span>, key, iv)</span><br><span class="line"><span class="comment">// 对输入数据进行加密，并输出加密结果的十六进制表示</span></span><br><span class="line"><span class="comment">// 可以使用新数据多次调用 cipher.update() 方法，直到调用 cipher.final()</span></span><br><span class="line">cipher.<span class="title function_">update</span>(data, <span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;hex&quot;</span>)</span><br><span class="line"><span class="comment">// 以十六进制表示输出加密结果</span></span><br><span class="line"><span class="comment">// 一旦调用了 cipher.final() 方法，则 Cipher 对象就不能再用于加密数据</span></span><br><span class="line"><span class="keyword">const</span> result = cipher.<span class="title function_">final</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result) <span class="comment">// 5eb63bbbe01eeed093cb22bb8f5acdc3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>解密过程</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个 AES-256-CBC 解密算法的 decipher 对象，使用相同的密钥和IV</span></span><br><span class="line"><span class="keyword">const</span> decipher = crypto.<span class="title function_">createDecipheriv</span>(<span class="string">&#x27;aes-256-cbc&#x27;</span>, key, iv)</span><br><span class="line"><span class="comment">// 对加密数据进行解密，并输出解密结果的 UTF-8 字符串</span></span><br><span class="line"><span class="comment">// 可以使用新数据多次调用 decipher.update() 方法，直到调用 decipher.final()</span></span><br><span class="line">decipher.<span class="title function_">update</span>(result, <span class="string">&quot;hex&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="comment">// 以 UTF-8 字符串表示输出解密结果</span></span><br><span class="line"><span class="comment">// 一旦调用了 decipher.final() 方法，则 Decipher 对象就不能再用于解密数据</span></span><br><span class="line"><span class="keyword">const</span> decrypted = decipher.<span class="title function_">final</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(decrypted) <span class="comment">// hello world</span></span><br></pre></td></tr></table></figure>
<h3 id="分组加密"><a href="#分组加密" class="headerlink" title="分组加密"></a>分组加密</h3><p>常见的对称加密算法，如AES、DES都采用了分组加密模式，三个重要概念：模式、初始化向量、填充。</p>
<p><strong>分组加密：</strong>将（较长的）明文拆分成固定长度的块，然后对拆分的块按照特定的模式进行加密。</p>
<p>常见<strong>模式</strong>有：ECB（不安全）、CBC（最常用）、CFB、OFB、CTR等</p>
<p><strong>初始化向量IV：</strong><br>为了增强算法的安全性，部分分组加密模式（CFB、OFB、CTR）中引入了初始化向量（IV），使得加密的结果随机化。也就是说，对于同一段明文，IV不同，加密的结果不同。<br>以CBC为例，每一个数据块，都与前一个加密块进行异或运算后，再进行加密。对于第一个数据块，则是与IV进行异或。<br>IV的大小跟数据块的大小有关（128位，16字节），跟秘钥的长度无关。</p>
<p><strong>填充padding：</strong><br>部分加密模式，当最后一个块的长度小于128位时，需要通过特定的方式进行填充。（ECB、CBC需要填充，CFB、OFB、CTR不需要填充）</p>
<h2 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>对称加密的密钥是相同的，如果密钥泄露，加密的数据就不安全了。</p>
<p>非对称加密使用一对密钥，公钥和私钥，公钥加密，私钥解密。<br>公钥是公开的，任何人都可以获得，并对数据进行加密。私钥是保密的，只有私钥的拥有者才能解密。</p>
<p><strong>生成密钥对：</strong><code>crypto.generateKeyPairSync(type[, options])</code>，type为加密算法，options为配置项，返回一个对象，包含公钥和私钥。<br><strong>加密函数：</strong><code>crypto.publicEncrypt(publicKey, buffer)</code>，publicKey为公钥，buffer为要加密的数据，返回加密后的数据。<br><strong>解密函数：</strong><code>crypto.privateDecrypt(privateKey, buffer)</code>，privateKey为私钥，buffer为要解密的数据，返回解密后的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; privateKey, publicKey &#125; = crypto.<span class="title function_">generateKeyPairSync</span>(<span class="string">&#x27;rsa&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">modulusLength</span>: <span class="number">2048</span>, <span class="comment">// 模数长度，默认 2048 位，越长安全性越高，但是性能越差</span></span><br><span class="line">&#125;); <span class="comment">// 生成 RSA 密钥对</span></span><br><span class="line"><span class="comment">// 使用公钥加密数据</span></span><br><span class="line"><span class="keyword">const</span> encrypted = crypto.<span class="title function_">publicEncrypt</span>(publicKey, <span class="title class_">Buffer</span>.<span class="title function_">from</span>(data, <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(encrypted.<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)) <span class="comment">// 227d9e20fe66d854ec9ddda.......</span></span><br><span class="line"><span class="comment">// 使用私钥解密数据</span></span><br><span class="line"><span class="keyword">const</span> decrypted = crypto.<span class="title function_">privateDecrypt</span>(privateKey, encrypted)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(decrypted.<span class="title function_">toString</span>(<span class="string">&#x27;utf-8&#x27;</span>)) <span class="comment">// hello world</span></span><br></pre></td></tr></table></figure>
<h3 id="generateKeyPairSync"><a href="#generateKeyPairSync" class="headerlink" title="generateKeyPairSync"></a>generateKeyPairSync</h3><p><code>generateKeyPairSync(type, options)</code> 用于生成密钥对</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type: &lt;string&gt; 必须是 &#x27;rsa&#x27;、&#x27;rsa-pss&#x27;、&#x27;dsa&#x27;、&#x27;ec&#x27;、&#x27;ed25519&#x27;、&#x27;ed448&#x27;、&#x27;x25519&#x27;、&#x27;x448&#x27; 或 &#x27;dh&#x27;。</span><br><span class="line">options: &lt;Object&gt;</span><br><span class="line">  modulusLength: &lt;number&gt; 以位为单位的密钥大小（RSA、DSA）。</span><br><span class="line">  publicExponent: &lt;number&gt; 公共指数 (RSA)。 默认值： 0x10001。</span><br><span class="line">  hashAlgorithm: &lt;string&gt; 消息摘要的名称 (RSA-PSS)。</span><br><span class="line">  mgf1HashAlgorithm: &lt;string&gt; MGF1 (RSA-PSS) 使用的消息摘要的名称。</span><br><span class="line">  saltLength: &lt;number&gt; 以字节为单位的最小盐长度 (RSA-PSS)。</span><br><span class="line">  divisorLength: &lt;number&gt; q 的大小（以位为单位）(DSA)。</span><br><span class="line">  namedCurve: &lt;string&gt; 要使用的曲线的名称 (EC)。</span><br><span class="line">  prime: &lt;Buffer&gt; 主要参数 (DH)。</span><br><span class="line">  primeLength: &lt;number&gt; 以位 (DH) 为单位的素数长度。</span><br><span class="line">  generator: &lt;number&gt; 自定义生成器 (DH)。 默认值： 2。</span><br><span class="line">  groupName: &lt;string&gt; Diffie-Hellman 组名 (DH)。 参见 crypto.getDiffieHellman()。</span><br><span class="line">  paramEncoding: &lt;string&gt; 必须是 &#x27;named&#x27; 或 &#x27;explicit&#x27; (EC)。 默认值： &#x27;named&#x27;。</span><br><span class="line">  publicKeyEncoding: &lt;Object&gt; 参见 keyObject.export()。</span><br><span class="line">  privateKeyEncoding: &lt;Object&gt; 参见 keyObject.export()。</span><br><span class="line">返回： &lt;Object&gt;</span><br><span class="line">  publicKey: &lt;string&gt; | &lt;Buffer&gt; | &lt;KeyObject&gt;</span><br><span class="line">  privateKey: &lt;string&gt; | &lt;Buffer&gt; | &lt;KeyObject&gt;</span><br></pre></td></tr></table></figure>
<p>如果指定了 publicKeyEncoding 或 privateKeyEncoding，则此函数的行为就像对其结果调用了 <a target="_blank" rel="noopener" href="https://nodejs.cn/api/crypto.html#keyobjectexportoptions">keyObject.export(options)</a>，两者参数也与其一致。否则，密钥的相应部分将作为 KeyObject 返回。</p>
<p>对公钥进行编码时，建议使用 ‘spki’。 对私钥进行编码时，建议使用强密码的 ‘pkcs8’，并对密码进行保密。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; privateKey, publicKey &#125; = crypto.<span class="title function_">generateKeyPairSync</span>(<span class="string">&#x27;rsa&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">modulusLength</span>: <span class="number">2048</span>, <span class="comment">// 模数长度，默认 2048 位，越长安全性越高，但是性能越差</span></span><br><span class="line">  <span class="attr">publicKeyEncoding</span>: &#123; <span class="comment">// 公钥的输出格式</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;spki&#x27;</span>, <span class="comment">// 密钥编码类型</span></span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;pem&#x27;</span> <span class="comment">// 输出格式</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">privateKeyEncoding</span>: &#123; <span class="comment">// 私钥的输出格式</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;pkcs8&#x27;</span>, <span class="comment">// 密钥编码类型</span></span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;pem&#x27;</span> <span class="comment">// 输出格式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(privateKey)</span><br><span class="line"><span class="comment">// -----BEGIN PRIVATE KEY-----</span></span><br><span class="line"><span class="comment">// MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCs/KwPf39GSmgc</span></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">// WcDOr4jH76xt0OwEZNVn2A==</span></span><br><span class="line"><span class="comment">// -----END PRIVATE KEY-----</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(publicKey)</span><br><span class="line"><span class="comment">// -----BEGIN PUBLIC KEY-----</span></span><br><span class="line"><span class="comment">// MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArPysD39/RkpoHLHiXTSQ</span></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">// dwIDAQAB</span></span><br><span class="line"><span class="comment">// -----END PUBLIC KEY-----</span></span><br></pre></td></tr></table></figure>
<h2 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h2><p>数字签名属于非对称加密，用于验证数据的<strong>完整性</strong>和<strong>来源</strong>，私钥签名，公钥验证。</p>
<p>发送方生成签名：</p>
<ol>
<li>计算原始信息的摘要。</li>
<li>通过私钥对摘要进行签名，得到电子签名。</li>
<li>将原始信息、电子签名，发送给接收方。</li>
</ol>
<p>接收方验证签名：</p>
<ol>
<li>通过公钥解开电子签名，得到摘要D1。（如果解不开，信息来源主体校验失败）</li>
<li>计算原始信息的摘要D2。</li>
<li>对比D1、D2，如果D1等于D2，说明原始信息完整、未被篡改。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; privateKey, publicKey &#125; = crypto.<span class="title function_">generateKeyPairSync</span>(<span class="string">&#x27;rsa&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">modulusLength</span>: <span class="number">2048</span>,</span><br><span class="line">  <span class="attr">publicKeyEncoding</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;spki&#x27;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;pem&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">privateKeyEncoding</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;pkcs8&#x27;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;pem&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 创建签名对象，使用 SHA256 算法</span></span><br><span class="line"><span class="keyword">const</span> sign = crypto.<span class="title function_">createSign</span>(<span class="string">&#x27;RSA-SHA256&#x27;</span>);</span><br><span class="line"><span class="comment">// 更新签名对象的数据</span></span><br><span class="line">sign.<span class="title function_">update</span>(data);</span><br><span class="line"><span class="comment">// 私钥计算签名值，并以十六进制字符串形式输出</span></span><br><span class="line"><span class="keyword">const</span> signature = sign.<span class="title function_">sign</span>(privateKey, <span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(signature) <span class="comment">// 847f62482332b9abaa3a......</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建验证对象，使用 SHA256 算法</span></span><br><span class="line"><span class="keyword">const</span> verify = crypto.<span class="title function_">createVerify</span>(<span class="string">&#x27;RSA-SHA256&#x27;</span>);</span><br><span class="line"><span class="comment">// 更新验证对象的数据</span></span><br><span class="line">verify.<span class="title function_">update</span>(data);</span><br><span class="line"><span class="comment">// 公钥验证签名值是否正确，以及数据是否被篡改</span></span><br><span class="line"><span class="keyword">const</span> result = verify.<span class="title function_">verify</span>(publicKey, signature, <span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// true，验证成功，数据没有被篡改</span></span><br></pre></td></tr></table></figure>
<h1 id="脚手架"><a href="#脚手架" class="headerlink" title="脚手架"></a>脚手架</h1><p>脚手架是一种自动化的工具，用于快速生成项目的基础结构，包括目录结构、配置文件、代码规范等。<br>例如vue-cli、create-react-app、express-generator</p>
<p>作用：</p>
<ol>
<li>快速初始化项目</li>
<li>保证协作团队项目的统一</li>
<li>添加通用的组件或者配置</li>
</ol>
<p>脚手架一般通过命令行的方式使用，例如vue-cli，通过<code>vue create &lt;name&gt;</code>命令创建项目，首先设置项目名称，然后可以选择预设的模板，如是否需要使用TS、是否需要使用eslint等，最后会自动下载依赖、模板，创建项目。</p>
<p>重要的就是与命令行的交互，以及模板的下载。<br>可以使用readline和fs去实现，但是非常麻烦，也不好看，还是使用现成的库方便。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/commander">commander</a> 执行复杂的命令</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/inquirer">inquirer</a>    问答交互</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/download-git-repo">download-git-repo</a> 下载远程模板</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/chalk">chalk</a> 让 console.log 带颜色，比如成功时的绿色</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ora">ora</a> 命令行 loading 效果</li>
</ol>
<p>在入口文件添加特殊注释<code>#!/usr/bin/env node</code>告诉终端，这个文件要使用 node 去执行</p>
<p>然后在package.json中添加bin字段，指定命令的入口文件，在本地测试时，使用<code>npm link</code>将命令链接到全局</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test-cli&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>编写代码完成脚手架的功能</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"><span class="keyword">import</span> chalk <span class="keyword">from</span> <span class="string">&#x27;chalk&#x27;</span></span><br><span class="line"><span class="keyword">import</span> inquirer <span class="keyword">from</span> <span class="string">&#x27;inquirer&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Command</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;commander&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> util <span class="keyword">from</span> <span class="string">&#x27;./util.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> pkg <span class="keyword">from</span> <span class="string">&#x27;./package.json&#x27;</span> assert &#123; <span class="attr">type</span>: <span class="string">&quot;json&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建命令行对象</span></span><br><span class="line"><span class="keyword">const</span> program = <span class="keyword">new</span> <span class="title class_">Command</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 --version 参数</span></span><br><span class="line">program.<span class="title function_">version</span>(pkg.<span class="property">version</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义命令</span></span><br><span class="line">program.<span class="title function_">command</span>(<span class="string">&#x27;create &lt;name&gt;&#x27;</span>)</span><br><span class="line">  .<span class="title function_">alias</span>(<span class="string">&#x27;c&#x27;</span>) <span class="comment">// 命令别名</span></span><br><span class="line">  .<span class="title function_">description</span>(<span class="string">&#x27;创建项目&#x27;</span>) <span class="comment">// 命令描述</span></span><br><span class="line">  .<span class="title function_">action</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">    inquirer.<span class="title function_">prompt</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;input&#x27;</span>, <span class="comment">// 类型为input输入框</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;projectName&#x27;</span>, <span class="comment">// 问题名称</span></span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;请输入项目名称&#x27;</span>, <span class="comment">// 问题描述</span></span><br><span class="line">        <span class="attr">default</span>: name <span class="comment">// 默认值</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;confirm&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;isTS&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;是否使用TypeScript&#x27;</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 结果返回一个&#123; &lt;name&gt;: &lt;value&gt; &#125;对象</span></span><br><span class="line">      <span class="keyword">if</span> (util.<span class="title function_">checkDirExist</span>(res.<span class="property">projectName</span>)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(chalk.<span class="title function_">red</span>(<span class="string">&#x27;文件夹已存在&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> repo = <span class="string">&quot;github:qxchuckle/rollup-template&quot;</span></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">isTS</span>) &#123;</span><br><span class="line">        util.<span class="title function_">downloadTemplate</span>(<span class="string">&#x27;main&#x27;</span>, repo, res.<span class="property">projectName</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        util.<span class="title function_">downloadTemplate</span>(<span class="string">&#x27;main&#x27;</span>, repo, res.<span class="property">projectName</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析命令行参数</span></span><br><span class="line">program.<span class="title function_">parse</span>(process.<span class="property">argv</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>util.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> downloadGitRepo <span class="keyword">from</span> <span class="string">&#x27;download-git-repo&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ora <span class="keyword">from</span> <span class="string">&#x27;ora&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查路径是否存在</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">checkDirExist</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fs.<span class="title function_">existsSync</span>(path)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">downloadTemplate</span>(<span class="params">branch, repo, dest</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> spinner = <span class="title function_">ora</span>(<span class="string">&#x27;正在下载模板...&#x27;</span>)</span><br><span class="line">    spinner.<span class="title function_">start</span>()</span><br><span class="line">    <span class="title function_">downloadGitRepo</span>(<span class="string">`<span class="subst">$&#123;repo&#125;</span>#<span class="subst">$&#123;branch&#125;</span>`</span>, dest, &#123;</span><br><span class="line">      <span class="attr">clone</span>: <span class="literal">true</span></span><br><span class="line">    &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        spinner.<span class="title function_">fail</span>(<span class="string">&#x27;下载失败&#x27;</span>)</span><br><span class="line">        <span class="title function_">reject</span>(err)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        spinner.<span class="title function_">succeed</span>(<span class="string">&#x27;下载成功&#x27;</span>)</span><br><span class="line">        <span class="title function_">resolve</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="markdown渲染"><a href="#markdown渲染" class="headerlink" title="markdown渲染"></a>markdown渲染</h1><p>markdown渲染是常见的需求，使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/marked">marked</a>、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/marked-highlight">marked-highlight</a>、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/highlight.js">highlight</a>，将markdown转换为html并高亮代码，再使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ejs">ejs</a>模板引擎渲染完整页面、<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/browser-sync">browser-sync</a>实现构建网站时保持多个浏览器和设备同步</p>
<figure class="highlight js"><figcaption><span>index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Marked</span> &#125; <span class="keyword">from</span> <span class="string">&quot;marked&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; markedHighlight &#125; <span class="keyword">from</span> <span class="string">&quot;marked-highlight&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> hljs <span class="keyword">from</span> <span class="string">&#x27;highlight.js&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> browserSync <span class="keyword">from</span> <span class="string">&quot;browser-sync&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> ejs <span class="keyword">from</span> <span class="string">&quot;ejs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __dirname = path.<span class="title function_">dirname</span>(<span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成marked实例，用于渲染md</span></span><br><span class="line"><span class="keyword">const</span> marked = <span class="keyword">new</span> <span class="title class_">Marked</span>(</span><br><span class="line">  <span class="title function_">markedHighlight</span>(&#123;</span><br><span class="line">    <span class="attr">langPrefix</span>: <span class="string">&#x27;hljs language-&#x27;</span>, <span class="comment">// 紧接在代码块打开标记之后找到的语言标记被附加到它，形成类属性</span></span><br><span class="line">    <span class="title function_">highlight</span>(<span class="params">code, lang, info</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> language = hljs.<span class="title function_">getLanguage</span>(lang) ? lang : <span class="string">&#x27;plaintext&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> hljs.<span class="title function_">highlight</span>(code, &#123; language &#125;).<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">readFile</span> = (<span class="params">file</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, file), <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">server</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  globalThis.<span class="property">browser</span> = browserSync.<span class="title function_">create</span>()</span><br><span class="line">  browser.<span class="title function_">init</span>(&#123;</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">      <span class="attr">baseDir</span>: __dirname,</span><br><span class="line">      <span class="attr">index</span>: <span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 防抖</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">debounce</span> = (<span class="params">func, delay</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> timer;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">func</span>(...args);</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 监听文件变化，实现热更新</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">watch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> debouncedInit = <span class="title function_">debounce</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">init</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      browser.<span class="title function_">reload</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">  fs.<span class="title function_">watch</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./01.md&#x27;</span>), <span class="function">(<span class="params">eventType, filename</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 修改文件会连续触发多次change事件，使用防抖函数，只执行最后一次</span></span><br><span class="line">    <span class="title function_">debouncedInit</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// css资源</span></span><br><span class="line"><span class="keyword">const</span> css = [</span><br><span class="line">  <span class="string">&#x27;http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="comment">// 模板渲染</span></span><br><span class="line">  ejs.<span class="title function_">renderFile</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;index.ejs&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;Markdown&#x27;</span>,</span><br><span class="line">    <span class="attr">content</span>: marked.<span class="title function_">parse</span>(<span class="title function_">readFile</span>(<span class="string">&#x27;01.md&#x27;</span>)),</span><br><span class="line">    css,</span><br><span class="line">  &#125;, <span class="function">(<span class="params">err, str</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./index.html&#x27;</span>), <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    writeStream.<span class="title function_">on</span>(<span class="string">&#x27;ready&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;开始写入&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    writeStream.<span class="title function_">write</span>(str, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入完成&#x27;</span>)</span><br><span class="line">      callback &amp;&amp; <span class="title function_">callback</span>();</span><br><span class="line">      writeStream.<span class="title function_">destroy</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    writeStream.<span class="title function_">end</span>(); <span class="comment">// 结束写入，表示不再有数据写入（end之后不能调用write）</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 启动</span></span><br><span class="line"><span class="title function_">init</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">server</span>(); <span class="comment">// 启动服务</span></span><br><span class="line">  <span class="title function_">watch</span>(); <span class="comment">// 启动监听</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><figcaption><span>index.ejs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">    &lt;%= title %&gt;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  &lt;% css.forEach(function(cssPath) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= cssPath %&gt;&quot;</span>&gt;</span></span><br><span class="line">    &lt;% &#125;); %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;markdown-body&quot;</span>&gt;</span></span><br><span class="line">    &lt;%- content %&gt;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="zlib"><a href="#zlib" class="headerlink" title="zlib"></a>zlib</h1><p><a target="_blank" rel="noopener" href="https://nodejs.cn/api/zlib.html">zlib</a> 模块提供了使用 Gzip、Deflate/Inflate、以及 Brotli 实现的压缩功能。</p>
<p>常用的两个压缩算法：gzip、deflate。分别对应 <code>zlib.createGzip()</code>、<code>zlib.createDeflate()</code> 进行压缩，<code>zlib.createGunzip()</code>、<code>zlib.createInflate()</code> 进行解压。</p>
<p>通过管道可以很方便的实现压缩和解压缩</p>
<figure class="highlight js"><figcaption><span>压缩</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt&#x27;</span>))</span><br><span class="line">  .<span class="title function_">pipe</span>(zlib.<span class="title function_">createGzip</span>()) <span class="comment">// 使用gzip压缩</span></span><br><span class="line">  .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt.gz&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt&#x27;</span>))</span><br><span class="line">  .<span class="title function_">pipe</span>(zlib.<span class="title function_">createDeflate</span>()) <span class="comment">// 使用Deflate压缩</span></span><br><span class="line">  .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt.deflate&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><figcaption><span>解压</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt.gz&#x27;</span>))</span><br><span class="line">  .<span class="title function_">pipe</span>(zlib.<span class="title function_">createGunzip</span>()) <span class="comment">// 使用gzip解压</span></span><br><span class="line">  .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt.deflate&#x27;</span>))</span><br><span class="line">  .<span class="title function_">pipe</span>(zlib.<span class="title function_">createInflate</span>()) <span class="comment">// 使用Deflate解压</span></span><br><span class="line">  .<span class="title function_">pipe</span>(fs.<span class="title function_">createWriteStream</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;big_data.txt&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<p>deflate是一种使用了LZ77算法与哈夫曼编码（Huffman Coding）实现的无损数据压缩算法。它是一个无专利的，可以自由使用的算法。<br>gizp是一种以0x1F8B标志开头的数据格式，其内部通常采用DEFLATE算法对数据进行压缩。</p>
<blockquote>
<p>“Deflate” 和 “DEFLATE” 实际上是指相同的压缩算法，区别在于对待大小写的不同。”Deflate” 是一般的术语，表示该压缩算法。而 “DEFLATE” 则是一个特定的字母大小写形式，通常用于指代该算法在特定上下文中的实现或特定文件格式中的使用，比如在 gzip 文件格式中</p>
</blockquote>
<h2 id="http请求压缩"><a href="#http请求压缩" class="headerlink" title="http请求压缩"></a>http请求压缩</h2><p>客户端在向服务端发起请求时，会在请求头中添加<strong>accept-encoding</strong>字段，其值标明客户端<strong>支持</strong>的压缩内容编码格式<br>服务端在对返回内容执行压缩后，通过在响应头中添加<strong>content-encoding</strong>，来告诉浏览器内容<strong>实际</strong>压缩使用的编码算法</p>
<p>gzip 的核心是 Deflate，而它使用了 LZ77 算法与 Huffman 编码来压缩文件，<strong>重复度越高的文件可压缩的空间就越大</strong>。<br>对于文本文件，GZip 的效果非常明显，开启后传输所需流量大约会降至 1/4 ~ 1/3。主要用于 HTTP 文件传输中，比如 JS、CSS 等，但一般不会压缩图片。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>();</span><br><span class="line"><span class="keyword">const</span> zipList = &#123;</span><br><span class="line">  <span class="attr">gzip</span>: zlib.<span class="title function_">createGzip</span>(),</span><br><span class="line">  <span class="attr">deflate</span>: zlib.<span class="title function_">createDeflate</span>(),</span><br><span class="line">  <span class="attr">br</span>: zlib.<span class="title function_">createBrotliCompress</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> acceptedEncodings = req.<span class="property">headers</span>[<span class="string">&#x27;accept-encoding&#x27;</span>].<span class="title function_">split</span>(<span class="string">&#x27;, &#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(acceptedEncodings); <span class="comment">// gzip, deflate, br</span></span><br><span class="line">  <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./big_data.txt&#x27;</span>));</span><br><span class="line">  <span class="keyword">if</span> (acceptedEncodings &amp;&amp; acceptedEncodings.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> encoding = acceptedEncodings[<span class="number">0</span>].<span class="title function_">trim</span>();</span><br><span class="line">    res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Encoding&#x27;</span>, encoding);</span><br><span class="line">    stream.<span class="title function_">pipe</span>(zipList[encoding]).<span class="title function_">pipe</span>(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    stream.<span class="title function_">pipe</span>(res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running on http://localhost:8888&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Node-回眸[二]</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://www.qcqx.cn/article/9b981f17.html">https://www.qcqx.cn/article/9b981f17.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>轻笑Chuckle</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2024-01-11</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2024-01-11</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="post-meta__tags" href="/tags/NodeJS/">NodeJS</a></div><div class="post_share"></div></div><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投 喂</span><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/blog/pay/weixin.webp" alt="微信" loading="lazy"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/blog/pay/alipay.webp" alt="支付宝" loading="lazy"/></a><div class="post-qr-code-desc">支付宝</div></li><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">一个博客 一叶孤舟 一方世界</div></a></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/9b01fd71.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">⇦上一篇</div><div class="prev_info">Node-回眸[三]</div></div></a></div><div class="next-post pull-right"><a href="/article/98a1db82.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇⇨</div><div class="next_info">Node-回眸[一]</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" data-no-lazy="data-no-lazy" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.gif'" alt="avatar"/></div><div class="author-info__name">『轻笑Chuckle』</div><div class="author-info__description">漫天倾尘 风中轻笑</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">88</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">32</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qxchuckle"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/qxchuckle" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://gitee.com/qxchuckle" target="_blank" title="Gitee"><i class="iconfont icon-gitee"></i></a><a class="social-icon" href="https://space.bilibili.com/353049313" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=1395730595" target="_blank" title="网易云"><i class="iconfont icon-wangyiyunyinle"></i></a><a class="social-icon" href="http://www.coolapk.com/u/4137393" target="_blank" title="酷安"><i class="iconfont icon-kuan"></i></a></div></div><a class="card-widget" id="card-tuijian" href="https://afdian.net/a/chuckle" target="_blank" style="display:block"><div id="tj-box"><div id="tj-box1"><div id="tj-left"><p>扫一扫</p>
<span>快速打开移动端➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACEUlEQVR42u3bQXbDIAwFQN//0u22m7pfAgx1hlVeEjsaL0BPUq6vV68LDw8PDw8PDw8PDw8PDw8PDw8P74N5V7zur/r5/h+h/HJVNQY8PDy8vbwkoOTTaljTYsDDw8PbxEu2++phcH9tLwY8PDy8d/B6STkeHh7e5/CSQJOSBx4eHt5/5408grxcmz+UDbUWPDw8vAUNsHWvj+jv4eHh4QW86sqT3WS7nxYVHh4e3oO8fINOQm9u662r8PDw8Hbx7pv6vY0+x+cFjqGUGg8PD28qL791dfw0HzhYnlLj4eHhLShGVAdJRzb03hgWHh4e3jm8ajHiPrje2FYvxcfDw8M7mddj5N8fb6fh4eHhPc+rFiPy5DsvDY+UKvDw8PCe51V/Pm90jTfAphUj8PDw8Bbwqml075tJ0ry8GIGHh4c3NefM0+tqibZ6MBTujIeHh3cMr3oM5Nt6XgJeeDDg4eHhTUqpq5/2/kZVLWHg4eHhnc/rtbtG0ujeOCweHh7e87zqyhtm1QS6mtDj4eHh7eJd8Zp1h6Rcu3CmDA8PD2/xPGeeductqyQFLx9XeHh4eJt4vRZ+b+h/W60FDw8P70hePqCQR4KHh4f3Dl4yjDXeDJs8OoCHh4c3ldfb1psBBcl0IUI8PDy8x3nj7as83LmPCQ8PD+953jsWHh4eHh4eHh4eHh4eHh4eHh4e3gfwvgEYUJSPomVU/wAAAABJRU5ErkJggg=="/></div></div></div><div id="tj-box2"><div id="tj-left"><p>爱发电</p>
<span>扫码或<span class="tj-light">点击跳转</span>➤</span></div><div id="tj-right"><div id="tj-img-box"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACEElEQVR42u3bQXKDMAwFUO5/6fYAmbRfEhiTPK8YhiR+XtiKJI6fjx4HHh4eHh4eHh4eHh4eHh4eHh4e3hfzjnj88wMvz7x+9t33zOeAh4eHt56XT/31OrmTX/fmiYeHh3cX791GnPCSY+DdFl+dAx4eHt4TeclWXiXh4eHhfSqvGgRXkxR4eHh4z+JNUrTl9MGeuRY8PDy8Cwpg111vUd/Dw8PDC3jVkS9BHlKfMCs8PDy8hbxe60C+cfeSwuWWLzw8PLybeHm6tpfwrR4YeHh4eDvz8ibUKiAJu+ehNh4eHt5KXh7CzstU+fPl78HDw8NbzpuAJ4mG/Eg4uQCGh4eHN+ZNylr5ElxXMMPDw8O7i5ds7tV2qPwI6ZW+8PDw8NbzquWrfMvu3U+WAA8PD28fXu+oOOtIqIbReHh4ePvwJlPptZ/2khR4eHh49/KqbVVRmNsqjCWLjoeHh7cDL5/iJNQ+N3WLh4eHtxuvWhLLExB/H0iX/2PAw8PDG/PKW3ALk0+3dzzg4eHhreQd8chD7XlJ7OQCGB4eHt5l/ZyThMVZjftLcy14eHh4Y97fSYFeeF09fi4JqfHw8PA24FVfmuotXOEVLDw8PLxH8arg5Ek8PDy8p/DmRa9ei391UfDw8PB24OVbc34/b+fqvUiAh4eHdxfvMwYeHh4eHh4eHh4eHh4eHh4eHh7eF/B+Acr1Qv2GlsE8AAAAAElFTkSuQmCC"/></div></div></div></div></a><div class="card-widget card-announcement"><div class="item-headline"><i class="iconfont icon-gonggao"></i><span>公告</span></div><div class="announcement_content">欢迎来到『轻笑Chuckle』的小站<br>(￣▽￣)～■干杯□～(￣▽￣)<br>如果有什么加载不出来或者其它滴小bug,「刷新网页/Ctrl+F5」应该、也许能解决</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#events"><span class="toc-number">1.</span> <span class="toc-text">events</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#EventEmitter"><span class="toc-number">1.1.</span> <span class="toc-text">EventEmitter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">错误事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#new-removeListener%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">new&#x2F;removeListener事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#process%E5%BA%95%E5%B1%82"><span class="toc-number">1.4.</span> <span class="toc-text">process底层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#util"><span class="toc-number">2.</span> <span class="toc-text">util</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E5%88%A4%E6%96%AD"><span class="toc-number">2.1.</span> <span class="toc-text">类型判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promisify"><span class="toc-number">2.2.</span> <span class="toc-text">promisify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#callbackify"><span class="toc-number">2.3.</span> <span class="toc-text">callbackify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inspect"><span class="toc-number">2.4.</span> <span class="toc-text">inspect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#format"><span class="toc-number">2.5.</span> <span class="toc-text">format</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pngquant"><span class="toc-number">3.</span> <span class="toc-text">pngquant</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fs"><span class="toc-number">4.</span> <span class="toc-text">fs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%BF%E7%94%A8"><span class="toc-number">4.1.</span> <span class="toc-text">线程池使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flag%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%87%E5%BF%97"><span class="toc-number">4.2.</span> <span class="toc-text">flag文件系统标志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fd%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">4.3.</span> <span class="toc-text">fd文件描述符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fsPromises"><span class="toc-number">4.4.</span> <span class="toc-text">fsPromises</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#access"><span class="toc-number">4.5.</span> <span class="toc-text">access</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readFile%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">4.6.</span> <span class="toc-text">readFile文件读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createReadStream"><span class="toc-number">4.7.</span> <span class="toc-text">createReadStream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#readStream"><span class="toc-number">4.7.1.</span> <span class="toc-text">readStream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#writeFile%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">4.8.</span> <span class="toc-text">writeFile文件写入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#appendFile%E8%BF%BD%E5%8A%A0%E5%86%99%E5%85%A5"><span class="toc-number">4.9.</span> <span class="toc-text">appendFile追加写入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createWriteStream"><span class="toc-number">4.10.</span> <span class="toc-text">createWriteStream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#writeStream"><span class="toc-number">4.10.1.</span> <span class="toc-text">writeStream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#drain%E4%BA%8B%E4%BB%B6"><span class="toc-number">4.10.2.</span> <span class="toc-text">drain事件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6"><span class="toc-number">4.11.</span> <span class="toc-text">创建文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mkdir%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">4.12.</span> <span class="toc-text">mkdir创建目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rm%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6%E6%88%96%E7%9B%AE%E5%BD%95"><span class="toc-number">4.13.</span> <span class="toc-text">rm删除文件或目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rename%E6%96%87%E4%BB%B6%E9%87%8D%E5%91%BD%E5%90%8D%E5%92%8C%E7%A7%BB%E5%8A%A8"><span class="toc-number">4.14.</span> <span class="toc-text">rename文件重命名和移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watch%E7%9B%91%E8%A7%86%E6%96%87%E4%BB%B6"><span class="toc-number">4.15.</span> <span class="toc-text">watch监视文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readdir%E8%AF%BB%E5%8F%96%E7%9B%AE%E5%BD%95"><span class="toc-number">4.16.</span> <span class="toc-text">readdir读取目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF-%E7%A1%AC%E9%93%BE%E6%8E%A5"><span class="toc-number">4.17.</span> <span class="toc-text">软&#x2F;硬链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inode"><span class="toc-number">4.17.1.</span> <span class="toc-text">inode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream%E6%B5%81"><span class="toc-number">5.</span> <span class="toc-text">Stream流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Readable%E5%8F%AF%E8%AF%BB%E6%B5%81"><span class="toc-number">5.1.</span> <span class="toc-text">Readable可读流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Writable%E5%8F%AF%E5%86%99%E6%B5%81"><span class="toc-number">5.2.</span> <span class="toc-text">Writable可写流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Duplex%E6%B5%81"><span class="toc-number">5.3.</span> <span class="toc-text">Duplex流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transform%E6%B5%81"><span class="toc-number">5.4.</span> <span class="toc-text">Transform流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pipe%E7%AE%A1%E9%81%93"><span class="toc-number">5.5.</span> <span class="toc-text">pipe管道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%E5%8E%9F%E7%90%86"><span class="toc-number">5.6.</span> <span class="toc-text">管道原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#crypto"><span class="toc-number">6.</span> <span class="toc-text">crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81Hash"><span class="toc-number">6.1.</span> <span class="toc-text">摘要Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MAC%E3%80%81HMAC"><span class="toc-number">6.2.</span> <span class="toc-text">MAC、HMAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="toc-number">6.3.</span> <span class="toc-text">对称加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E5%8A%A0%E5%AF%86"><span class="toc-number">6.3.1.</span> <span class="toc-text">分组加密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="toc-number">6.4.</span> <span class="toc-text">非对称加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#generateKeyPairSync"><span class="toc-number">6.4.1.</span> <span class="toc-text">generateKeyPairSync</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D"><span class="toc-number">6.5.</span> <span class="toc-text">数字签名</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%84%9A%E6%89%8B%E6%9E%B6"><span class="toc-number">7.</span> <span class="toc-text">脚手架</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#markdown%E6%B8%B2%E6%9F%93"><span class="toc-number">8.</span> <span class="toc-text">markdown渲染</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zlib"><span class="toc-number">9.</span> <span class="toc-text">zlib</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http%E8%AF%B7%E6%B1%82%E5%8E%8B%E7%BC%A9"><span class="toc-number">9.1.</span> <span class="toc-text">http请求压缩</span></a></li></ol></li></ol></div></div><div class="card-widget card-recommend-post"><div class="item-headline"><i class="fas fa-dharmachakra"></i><span>相关推荐</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/9b01fd71.html" title="Node-回眸[三]"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp" alt="Node-回眸[三]"></a><div class="content"><a class="title" href="/article/9b01fd71.html" title="Node-回眸[三]">Node-回眸[三]</a><time datetime="2024-01-16" title="发表于 2024-01-16">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/98a1db82.html" title="Node-回眸[一]"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/74-0.webp" alt="Node-回眸[一]"></a><div class="content"><a class="title" href="/article/98a1db82.html" title="Node-回眸[一]">Node-回眸[一]</a><time datetime="2024-01-06" title="发表于 2024-01-06">2024-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/a1e193d6.html" title="NodeJS接口、会话控制"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/50-1.webp" alt="NodeJS接口、会话控制"></a><div class="content"><a class="title" href="/article/a1e193d6.html" title="NodeJS接口、会话控制">NodeJS接口、会话控制</a><time datetime="2023-04-22" title="发表于 2023-04-22">2023-04-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/bd0448f7.html" title="NodeJS-MongoDB"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/49-1.webp" alt="NodeJS-MongoDB"></a><div class="content"><a class="title" href="/article/bd0448f7.html" title="NodeJS-MongoDB">NodeJS-MongoDB</a><time datetime="2023-04-21" title="发表于 2023-04-21">2023-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/8ddaf637.html" title="Express框架"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/48-1.webp" alt="Express框架"></a><div class="content"><a class="title" href="/article/8ddaf637.html" title="Express框架">Express框架</a><time datetime="2023-04-20" title="发表于 2023-04-20">2023-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/109cbe0a.html" title="初识NodeJS"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/47-1.webp" alt="初识NodeJS"></a><div class="content"><a class="title" href="/article/109cbe0a.html" title="初识NodeJS">初识NodeJS</a><time datetime="2023-04-17" title="发表于 2023-04-17">2023-04-17</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最近更新</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/1be64a8d.html" title="NestJS实践杂记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/77-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="NestJS实践杂记"/></a><div class="content"><a class="title" href="/article/1be64a8d.html" title="NestJS实践杂记">NestJS实践杂记</a><time datetime="2024-12-09T07:10:08.000Z" title="更新于 2024-12-09 15:10:08">2024-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/55cefeb1.html" title="React-记-3"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-3"/></a><div class="content"><a class="title" href="/article/55cefeb1.html" title="React-记-3">React-记-3</a><time datetime="2024-10-12T17:26:31.000Z" title="更新于 2024-10-13 01:26:31">2024-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/f17dfea3.html" title="React-记-2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-2"/></a><div class="content"><a class="title" href="/article/f17dfea3.html" title="React-记-2">React-记-2</a><time datetime="2024-09-26T11:26:24.000Z" title="更新于 2024-09-26 19:26:24">2024-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/cb488cbf.html" title="React-记-1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/104-0.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="React-记-1"/></a><div class="content"><a class="title" href="/article/cb488cbf.html" title="React-记-1">React-记-1</a><time datetime="2024-09-23T13:15:26.000Z" title="更新于 2024-09-23 21:15:26">2024-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/d186ebdd.html" title="闭包与内存泄漏"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/images/103-4.webp" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/404.jpg'" alt="闭包与内存泄漏"/></a><div class="content"><a class="title" href="/article/d186ebdd.html" title="闭包与内存泄漏">闭包与内存泄漏</a><time datetime="2024-09-12T12:04:03.000Z" title="更新于 2024-09-12 20:04:03">2024-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(0, 0, 0, 0);"><div id="footer-wrap"><div id="footer_icon"><div class="icon_left"><a class="icon_link" target="_blank" href="http://foreverblog.cn/go.html" rel="noopener external nofollow" title="虫洞-随机访问十年之约成员博客"><i class="fa-solid fa-circle-notch fa-fw"></i></a><a class="icon_link" target="_blank" href="https://travellings.cn" rel="noopener external nofollow" title="开往-随机跳转到另一个加入开往的网页"><i class="fa-solid fa-subway fa-fw"></i></a><a class="icon_link" href="/link/" title="友链"><i class="fa-solid fa-link fa-fw"></i></a><a class="icon_link" href="/messageboard/" title="留言"><i class="fa-regular fa-comment fa-fw"></i></a></div><img class="footer_logo entered loaded" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/head.webp" onclick="btf.scrollToDest(0,500)" title="返回顶部"/><div class="icon_left"><a class="icon_link" target="_blank" rel="noopener" href="https://www.qcqx.cn/" title="我的主页"><i class="fa-solid fa-compass fa-fw"></i></a><a class="icon_link" target="_blank" href="https://res.abeim.cn/api/qq/?qq=1934009145" rel="noopener external nofollow" title="联系QQ"><i class="fa-brands fa-qq fa-fw"></i></a><a class="icon_link" target="_blank" href="https://github.com/qxchuckle" rel="noopener external nofollow" title="我的Github主页"><i class="fa-brands fa-github fa-fw"></i></a><a class="icon_link" href="mailto:chuckle@chuckle.top" rel="noopener external nofollow" title="邮件联系"><i class="fa-solid fa-envelope fa-fw"></i></a></div></div><div class="copyright">&copy;2022 - 2025 By 『轻笑Chuckle』<a id="beianhao" style="color:#fff;font-size:0.9rem;font-weight:400;" href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2022076449号</a></div><div class="footer_custom_text">『Another branch will grow and flourish in the future』</div><div class="footer-banner"><div id="footer-banner-time"><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>if(! (navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))){
function createtime() {
var now = new Date();
var grt= new Date("03/10/2022 00:00:00");
now.setTime(now.getTime()+1000);
days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
document.getElementById("timeDate").innerHTML = "自 2022-3-10 建站以来，小站已苟活 "+dnum+" 天 ";
document.getElementById("times").innerHTML = hnum + " 时 " + mnum + " 分 ( =•ω•= )m";
}
createtime();
if(typeof footer_time == "undefined"){
  var footer_time = setInterval("createtime()",1000*60);
}else{
  clearInterval(footer_time);
  footer_time = setInterval("createtime()",1000*60);
}
}
</script></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/hexo.svg"/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/butterfly.svg"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/github.svg"/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20220160" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/20220160.svg"/></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/2022076449.svg"/></a><a class="github-badge" target="_blank" href="https://cloud.tencent.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/tx.svg"/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/vercel.svg"/></a><a class="github-badge" target="_blank" href="https://tianli-blog.club/jsd/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/tianlicdn.svg"/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/ypy.svg"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/img/cc.svg"/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="refresh-cache" type="button" title="刷新缓存" onclick="refreshCache()"><i class="fas fa-refresh fa-spin"></i></button><button id="enlargePage-btn" type="button" title="放大页面" onclick="enlargePage()"><i class="fa fa-plus"></i></button><button id="narrowPage-btn" type="button" title="缩小页面" onclick="narrowPage()"><i class="fa fa-minus"></i></button><button type="button" title="切换背景" onclick="toggleWinbox()"><i class="fa fa-images"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn();"><i class="fas fa-comments"></i></button><button id="share-link" type="button" title="分享链接"><i class="fa fa-share-alt"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-top"><i class="fa fa-angles-up"></i></div></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:kk.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-magnifying-glass"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-read"><a class="rightMenu-item" href="javascript:kk.pasteText();"><i class="fa fa-paste"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" id="menu-radompage" href="/"><i class="fa-solid fa-shoe-prints"></i><span>博客主页</span></a><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-adjust"></i><span>昼夜切换</span></div><div class="rightMenu-item" id="share-chuckle"><i class="fa fa-share-alt"></i><span>分享本页</span></div><a class="rightMenu-item" id="menu-radompage" href="/categories/"><i class="fa fa-archive"></i><span>分类</span></a><a class="rightMenu-item" id="menu-radompage" href="/tags/"><i class="fa fa-tags"></i><span>标签</span></a></div></div><div id="rightmenu-mask" onclick="RemoveRightMenu()"></div><div><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/utils.js"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/main.js?6"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/search/local-search.js?2"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 2500);</script><div class="js-pjax"><script>function loadWaline () {
  function initWaline () {
    const waline = new Waline(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline.qcqx.cn',
      path: location.pathname,
      visitor: true,
      dark: 'html[data-theme="dark"]'
    }, {"requiredMeta":["nick","mail"],"wordLimit":400,"placeholder":"来评论交流吧，通过邮件通知（表情点不出来请刷新页面）"}))
  }

  if (typeof Waline === 'function') initWaline()
  else getScript('https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/waline.min.js?7').then(initWaline)
}

if ('Waline' === 'Waline' || !false) {
  if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/qx-tracker.min.js?1"></script><script>const tracker = new Tracker({requestUrl:'https://tracker-api.qcqx.cn/api/tracker',historyTracker:true,realTime:true});</script><script defer="true" src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/random.min.js?14"></script><script defer="true" src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/chuckle.js?15"></script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/chuckle-post-ai.js?11"></script><script defer>new ChucklePostAI({el:'#post>#article-container',key:'tN2jLmG7fX9zHk5dVbQr',title_el:'.post-title',rec_method:'web',whitelist:['article/17d3383a.html'],pjax:true})</script><script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#fixedcard-dashboard","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div id="fixedcard-dashboard"><button class="fixedcard-activebtn" type="button" title="用户信息" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-info&quot;,&quot;0&quot;)"><i class="fas fa-address-book"></i></button><button class="fixedcard-activebtn" type="button" title="公告" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-announcement&quot;,&quot;0&quot;)"><i class="fa fa-bullhorn"></i></button><button class="fixedcard-activebtn" type="button" title="相关推荐" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recommend-post&quot;,&quot;0&quot;)"><i class="fas fa-dharmachakra"></i></button><button class="fixedcard-activebtn" type="button" title="最近更新" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recent-post&quot;,&quot;0&quot;)"><i class="fas fa-history"></i></button><div class="fixedcard-user-avatar fixedcard-activebtn" onclick="RemoveFixedCardWidget()"><img class="fixedcard-user-avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/head.webp" title="『轻笑Chuckle』"></div></div></div><!-- hexo injector body_end start --><script data-pjax>function hope_light_loader_injector_config(){
                var parent_div_git = document.getElementById('body-wrap');
                var item_html = '<div id="loading-bar-wrapper">';
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementById('body-wrap') && (location.pathname ==='all'|| 'all' ==='all')){
            hope_light_loader_injector_config()
        } </script>
    <script src="https://cdn.jsdelivr.net/gh/qxchuckle/qxchuckle.github.io/js/nprogress.min.js"></script>
    <script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script data-pjax>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
      document.addEventListener('pjax:send', window.ShowLoading)
      document.addEventListener('pjax:success', window.HideLoading)
      document.addEventListener('pjax:error', window.HideLoading)
    </script>
<!-- hexo injector body_end end --></body></html>