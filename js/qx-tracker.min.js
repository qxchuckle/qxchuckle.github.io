!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Tracker=t()}(this,(function(){"use strict";const e=(e,t)=>{const r=history[e],o=new Event(t),n=new Event(e);return function(){const e=r.apply(this,arguments);return window.dispatchEvent(n),window.dispatchEvent(o),e}};function t(){return window.location.pathname+window.location.hash}function r(e,t){if(Object.keys(t).length<=0)return!1;return navigator.sendBeacon(e,JSON.stringify(t))}function o(e=2){const t=window.performance.getEntriesByType("navigation")[0]||performance.timing,r=window.performance.getEntriesByType("paint")[0],o=window.performance.getEntriesByType("paint")[1];if(!t)return null;const n=t.secureConnectionStart;return{startTime:t.startTime.toFixed(e),duration:t.duration.toFixed(e),DNS:(t.domainLookupEnd-t.domainLookupStart).toFixed(e),TCP:(t.connectEnd-t.connectStart).toFixed(e),SSL:(n>0?t.connectEnd-n:0).toFixed(e),TTFB:(t.responseStart-t.requestStart).toFixed(e),FP:(r?r.startTime-t.fetchStart:t.responseEnd-t.fetchStart).toFixed(e),FCP:(o?o.startTime-t.fetchStart:0).toFixed(e),TTI:(t.domInteractive-t.startTime).toFixed(e),redirect:(t.redirectEnd-t.redirectStart).toFixed(e),redirectCount:t.redirectCount,unload:(t.unloadEventEnd-t.unloadEventStart).toFixed(e),ready:(t.domContentLoadedEventEnd-t.startTime).toFixed(e),load:(t.loadEventEnd-t.startTime).toFixed(e),dom:(t.domContentLoadedEventEnd-t.responseEnd).toFixed(e),domComplete:t.domComplete.toFixed(e),resource:(t.domComplete-t.domInteractive).toFixed(e),htmlLoad:(t.responseEnd-t.startTime).toFixed(e),DCL:(t.domContentLoadedEventEnd-t.domContentLoadedEventStart).toFixed(e),onload:(t.loadEventEnd-t.loadEventStart).toFixed(e)}}function n(e=2){if(!window.performance)return null;const t=window.performance.getEntriesByType("resource"),r={};return t.forEach((t=>{let o=t.initiatorType||"other";if("beacon"!==o){if("other"===o){switch(function(e,t){let r=e.substring(e.lastIndexOf("/")+1);switch(t){case 1:return r;case 2:return r.substring(r.lastIndexOf(".")+1);case 3:return r.substring(0,r.lastIndexOf("."));case 4:return e.substring(0,e.lastIndexOf("/")+1);default:return}}(t.name,2)){case"css":o="css";break;case"js":o="js";break;case"json":o="json";break;case"png":case"jpg":case"jpeg":case"gif":case"svg":o="img"}}!r.hasOwnProperty(o)&&(r[o]=[]),r[o].push({name:t.name,duration:t.duration.toFixed(e),type:t.entryType,initiatorType:t.initiatorType,size:t.decodedBodySize||t.transferSize})}})),r}function i(e="#qx.chuckle,123456789<canvas>"){const t=document.createElement("canvas"),r=t.getContext("2d");if(!r)return;r.font="14px 'Arial'",r.textBaseline="bottom",r.fillStyle="#f60",r.fillRect(125,1,62,20),r.fillStyle="#069",r.fillText(e,2,15),r.fillStyle="rgba(102, 204, 0, 0.7)",r.fillText(e,4,17);return function(e){e=atob(e);let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return Math.abs(t).toString(16).padStart(8,"0")}(t.toDataURL().replace("data:image/png;base64,",""))}const s=void 0;function a(){const e=window.navigator,t=e.userAgent;return{userAgent:t,cookieEnabled:e.cookieEnabled,language:e.language,browser:c(t),os:d(t),isMobile:h(t),screen:{width:window.screen.width,height:window.screen.height}}}function c(e){e=e.toLowerCase();const t={Edge:/edge\/([\d.]+)/i,IE:/(rv:|msie\s+)([\d.]+)/i,Firefox:/firefox\/([\d.]+)/i,Chrome:/chrome\/([\d.]+)/i,Opera:/opera\/([\d.]+)/i,Safari:/version\/([\d.]+).*safari/i};for(const r in t){const o=e.match(t[r]);if(o)return{name:r,version:o[1]}}return{name:"",version:"0"}}function d(e){e=e.toLowerCase();const t=[{name:"windows",regex:/compatible|windows/i},{name:"macOS",regex:/macintosh|macintel/i},{name:"iOS",regex:/iphone|ipad/i},{name:"android",regex:/android/i},{name:"linux",regex:/linux/i}];for(const r of t)if(e.match(r.regex))return r.name;return"other"}function h(e){return!!e.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)}var l;!function(e){e.version="1.0.0"}(l||(l={}));class p{options;reportTracker;eventListeners={};constructor(e,t){this.options=e,this.reportTracker=t}addEventListener(e,t,r=!1){!this.eventListeners.hasOwnProperty(e)&&(this.eventListeners[e]=[]),this.eventListeners[e].push(t),window.addEventListener(e,t,r)}destroy(){for(const e in this.eventListeners){const t=this.eventListeners[e];for(const r of t)window.removeEventListener(e,r)}this.eventListeners={},this.additionalDestroy()}}class u extends p{enterTime=void 0;location=void 0;constructor(e,t){super(e,t),this.reLocationRecord()}init(){this.options.historyTracker&&this.historyChangeReport(),this.options.hashTracker&&this.hashChangeReport(),(this.options.historyTracker||this.options.hashTracker)&&this.beforeCloseRouterReport()}additionalDestroy(){this.enterTime=void 0,this.location=void 0}reLocationRecord(){this.enterTime=(new Date).getTime(),this.location=t()}captureLocationEvent(e,r,o){this.addEventListener(e,(()=>{const n={event:e,targetKey:r,location:this.location,targetLocation:t(),duration:(new Date).getTime()-this.enterTime,data:o};this.reportTracker(n,"router"),this.reLocationRecord()}))}historyChangeReport(t="historyChange"){!function(t="historyChange"){window.history.pushState=e("pushState",t),window.history.replaceState=e("replaceState",t),window.addEventListener("popstate",(()=>{window.dispatchEvent(new Event(t))}))}(t),this.captureLocationEvent(t,"history-pv")}hashChangeReport(){this.captureLocationEvent("hashchange","hash-pv")}beforeCloseRouterReport(){if(!this.options.realTime)return;const e="beforeunload";this.addEventListener(e,(()=>{const t={event:e,targetKey:"close",location:this.location,duration:(new Date).getTime()-this.enterTime};this.reportTracker(t,"router")}))}getLocation(){return this.location}}class m extends p{constructor(e,t){super(e,t)}init(){this.options.domTracker&&this.domEventReport()}additionalDestroy(){}domEventReport(){this.options.domEventsList?.forEach((e=>{this.addEventListener(e,(t=>{const r=t.target,o=JSON.stringify(r.getAttribute("target-events"));if(o&&!o.includes(t.type))return;const n=r.getAttribute("target-key");n&&this.reportTracker({event:e,targetKey:n,elementInfo:{name:r.localName??r.nodeName,id:r.id||null,class:r.className||null}},"dom")}))}))}}class f extends p{constructor(e,t){super(e,t)}init(){this.options.errorTracker&&this.errorReport()}additionalDestroy(){}errorReport(){this.errorEvent(),this.promiseReject()}errorEvent(){this.addEventListener("error",(e=>{const[t,r]=this.analyzeError(e);this.reportTracker({targetKey:r,event:"error",info:t},"error")}),!0)}analyzeError(e){const t=e.target||e.srcElement;return t instanceof HTMLElement?[{name:t.tagName||t.localName||t.nodeName,class:t.className||null,id:t.id||null,url:t.src||t.href||null},"resourceError"]:e instanceof ErrorEvent?[e.message,"jsError"]:[e,"otherError"]}promiseReject(){this.addEventListener("unhandledrejection",(e=>{e.promise.catch((e=>{this.reportTracker({targetKey:"reject",event:"promise",info:e},"error")}))}))}}class v extends p{performanceObserver=void 0;constructor(e,t){super(e,t)}init(){this.options.performanceTracker&&this.performanceReport()}performanceReport(e=2){const t=()=>{const t={targetKey:"performance",event:"load",domPerformance:o(e),resourcePerformance:n(e)};this.reportTracker(t,"performance"),this.performanceObserver=function(e){const t=new PerformanceObserver(((t,r)=>{t.getEntries().forEach((t=>{"beacon"!==t.initiatorType&&e(t)}))}));return t.observe({entryTypes:["resource"]}),t}((t=>{const r={targetKey:"resourceLoad",event:"load",resource:{name:t.name,duration:t.duration.toFixed(e),type:t.entryType,initiatorType:t.initiatorType,size:t.decodedBodySize||t.transferSize}};this.reportTracker(r,"performance")}))};this.addEventListener("load",(()=>{"function"==typeof Promise?Promise.resolve().then((()=>{setTimeout(t,0)})):setTimeout(t,0)}))}additionalDestroy(){this.performanceObserver?.disconnect()}}class g extends p{constructor(e,t){super(e,t)}init(){this.options.navigatorTracker&&this.navigatorReport()}additionalDestroy(){}navigatorReport(){this.reportTracker({targetKey:"navigator",event:null,info:a()},"navigator")}}return class extends class{options;constructor(e){this.options=Object.assign(this.initDefault(),e)}initDefault(){return{requestUrl:"",uuid:this.generateUserID(),historyTracker:!1,hashTracker:!1,errorTracker:!1,domTracker:!1,domEventsList:new Set(["click","dblclick","contextmenu","mousedown","mouseup","mouseout","mouseover"]),performanceTracker:!1,navigatorTracker:!1,extra:void 0,sdkVersion:l.version,log:!0,realTime:!1,maxSize:51200}}generateUserID(){return i()}}{report={};trackers={locationTracker:void 0,domTracker:void 0,errorTracker:void 0,performanceTracker:void 0,navigatorTracker:void 0};stringSizeCalculation=void 0;beforeCloseHandler=void 0;isDestroy=!1;constructor(e){super(e),this.trackers.locationTracker=new u(this.options,((e,t)=>this.reportTracker(e,t))),this.trackers.domTracker=new m(this.options,((e,t)=>this.reportTracker(e,t))),this.trackers.errorTracker=new f(this.options,((e,t)=>this.reportTracker(e,t))),this.trackers.performanceTracker=new v(this.options,((e,t)=>this.reportTracker(e,t))),this.trackers.navigatorTracker=new g(this.options,((e,t)=>this.reportTracker(e,t))),this.init()}init(){try{for(const e in this.trackers)this.trackers[e]?.init();this.options.realTime||(this.stringSizeCalculation=function(){const e=new TextEncoder;return function(t){return e.encode(t).length}}(),this.beforeCloseReport()),this.options.log&&console.log("Tracker is OK")}catch(e){r(this.options.requestUrl,this.decorateData({targetKey:"tracker",event:"error",message:e})),this.options.log&&console.error("Tracker is error")}}decorateData(e){return Object.assign({},{uuid:this.options.uuid,time:(new Date).getTime(),location:this.trackers.locationTracker?.getLocation(),extra:this.options.extra},e)}reportTracker(e,t){const o=this.decorateData(e);if(this.options.realTime)return r(this.options.requestUrl,o);{!this.report.hasOwnProperty(t)&&(this.report[t]=[]),this.report[t].push(o);const e=this.stringSizeCalculation&&this.stringSizeCalculation(JSON.stringify(this.report));return s&&s(e,o),this.options.maxSize&&e&&e>(this.options.maxSize||1e4)&&this.sendReport(),!0}}beforeCloseReport(){this.beforeCloseHandler=()=>{this.sendReport()},window.addEventListener("beforeunload",this.beforeCloseHandler)}setUserID(e){this.isDestroy||(this.options.uuid=e)}setExtra(e){this.isDestroy||(this.options.extra=e)}sendTracker(e="manual",t){this.isDestroy||this.reportTracker({event:"manual",targetKey:e,data:t},"manual")}sendReport(){if(this.isDestroy)return!1;const e=r(this.options.requestUrl,this.report);return e&&(this.report={}),e}destroy(){if(!this.isDestroy){this.sendReport();for(const e in this.trackers)this.trackers[e]?.destroy(),this.trackers[e]=void 0;this.beforeCloseHandler&&window.removeEventListener("beforeunload",this.beforeCloseHandler),this.stringSizeCalculation=void 0,this.beforeCloseHandler=void 0,this.isDestroy=!0}}}}));